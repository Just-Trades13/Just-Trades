# Cursor AI Workflow Rules - PROTECTED CODEBASE
# ‚ö†Ô∏è CRITICAL: READ ALL PROTECTION RULES BEFORE MAKING ANY CHANGES

## üõ°Ô∏è PROTECTION SYSTEM - MANDATORY RULES

### BEFORE ANY CODE CHANGES - MANDATORY CHECKLIST:
1. **READ `WHAT_NOT_TO_DO.md`** - Lists all past mistakes that broke working code
2. **READ `PRE_CHANGE_CHECKLIST.md`** - Mandatory checklist before changes
3. **READ `ACCOUNT_MGMT_SNAPSHOT.md`** - Account management is LOCKED - DO NOT TOUCH
4. **READ `CURRENT_STATUS_SNAPSHOT.md`** - Current working state documentation
5. **READ `TAB_ISOLATION_MAP.md`** - **CRITICAL**: Tab isolation rules - only modify files for the tab you're working on
6. **CHECK `.cursorignore`** - Protected files that should NOT be modified
7. **VERIFY THE PROBLEM EXISTS** - Don't fix things that aren't broken
8. **IDENTIFY THE TAB** - Which tab/page are you working on? Only modify that tab's files

### üîí LOCKED FILES - DO NOT MODIFY WITHOUT EXPLICIT PERMISSION

**CRITICAL PROTECTED FILES:**
- `templates/account_management.html` - **LOCKED** - Baseline saved in `ACCOUNT_MGMT_SNAPSHOT.md`
- `ultra_simple_server.py` - **PROTECTED** - Account management functions locked
- `phantom_scraper/tradovate_integration.py` - **PROTECTED** - Core integration locked

**PROTECTION RULES:**
- If a file is in `.cursorignore`, DO NOT modify it
- If a file has a snapshot in `backups/`, verify changes against snapshot
- If user says "DO NOT TOUCH", that means NEVER modify without explicit permission
- Account management code is LOCKED - any changes must be approved first

### üö® RED FLAGS - STOP IMMEDIATELY

**STOP if you see:**
- User says "don't touch" or "locked" or "baseline"
- File is listed in `ACCOUNT_MGMT_SNAPSHOT.md`
- File is in `.cursorignore`
- User hasn't explicitly requested the change
- You're about to "improve" working code
- You're about to remove "unnecessary" code
- You're about to refactor working functionality

**IF YOU SEE RED FLAGS:**
1. STOP making changes
2. ASK user for explicit permission
3. Reference the protection documentation
4. Suggest using sandbox instead

## Core Principles

1. **Only modify code directly relevant to the specific request**
   - Avoid changing unrelated functionality
   - Don't refactor code that wasn't requested
   - Keep changes focused and minimal
   - **NEVER modify locked/protected files without explicit permission**

2. **Never use placeholders or incomplete code**
   - Never replace code with placeholders like `// ... rest of the processing ...` or `# TODO: implement this`
   - Always include complete, working code
   - If something is complex, break it into smaller steps but complete each step fully

3. **Provide context-aware suggestions**
   - Reference existing code patterns when making suggestions
   - Match the style and structure of existing code in the project
   - Use similar patterns found in the codebase
   - **Check protection rules before suggesting changes**

4. **Plan before implementing**
   - Break complex problems into smaller, manageable steps
   - Explain the approach before making changes
   - Consider edge cases and error handling
   - **Verify file is not protected before modifying**

5. **Preserve existing functionality**
   - Don't break working code while fixing or adding features
   - Test assumptions before making changes
   - Maintain backward compatibility when possible
   - **Account management is LOCKED - preserve it exactly as-is**

## Project-Specific Guidelines

### Protected Areas - DO NOT MODIFY
- **Account Management**: `templates/account_management.html` - LOCKED baseline
- **Account Management Backend**: Functions in `ultra_simple_server.py` related to account fetching/storage
- **OAuth Flow**: OAuth callback and connection endpoints (unless explicitly requested)
- **Core Integration**: `phantom_scraper/tradovate_integration.py` - Core methods locked

### Python Files
- Follow PEP 8 style guidelines
- Include proper error handling with try/except blocks
- Add docstrings for functions and classes
- Use type hints when appropriate
- Handle API rate limits and authentication errors gracefully
- **Check if file is protected before modifying**

### Frontend Files (HTML/JS)
- Maintain existing structure and IDs
- Don't remove working JavaScript functions
- Don't change element IDs that are referenced elsewhere
- **Account management HTML is LOCKED - do not modify**

### API Integrations
- Always handle authentication properly
- Include error handling for API failures (401, 403, 404, 429, etc.)
- Respect rate limits and implement retry logic
- Validate API responses before processing
- Use environment variables for sensitive credentials (never hardcode)

### Data Structures
- Maintain consistency with existing data schemas
- Validate data types and formats
- Handle missing or null values appropriately
- Use consistent field naming conventions

### Testing
- When suggesting test files, include comprehensive test cases
- Test both success and failure scenarios
- Include edge cases and boundary conditions

## Sandbox Workflow

**For new features or experiments:**
1. Use `create_sandbox.sh` to create a sandbox copy
2. Work in the sandbox directory
3. Test thoroughly in sandbox
4. Only merge to main after user approval
5. **NEVER work directly on protected files**

## Common Patterns to Follow

### When fixing errors:
1. **VERIFY the problem exists** - Don't fix things that aren't broken
2. **CHECK if file is protected** - If yes, ask permission first
3. Identify the root cause first
4. Explain what went wrong
5. Provide the fix with context
6. Suggest preventive measures if applicable

### When adding features:
1. **IDENTIFY which tab** you're working on - Check `TAB_ISOLATION_MAP.md`
2. **CHECK if you should use sandbox** - For major changes, use sandbox
3. **ONLY modify files for that tab** - Do NOT touch other tabs' files
4. Check for existing similar functionality first
5. Reuse existing patterns and utilities
6. Follow the established architecture
7. Update related documentation if needed
8. **DO NOT modify protected files**
9. **DO NOT modify other tabs' files** - Even if you think it's "helpful"

### When refactoring:
1. **NEVER refactor protected/locked code** without explicit permission
2. Only refactor when explicitly requested
3. Maintain all existing functionality
4. Test thoroughly after refactoring
5. Keep changes incremental and focused

## Communication Style

- Be clear and concise in explanations
- Provide code examples when helpful
- Reference specific files and line numbers when relevant
- **Warn user if attempting to modify protected files**
- Suggest improvements when appropriate, but don't implement without permission
- Acknowledge limitations and uncertainties
- **Always mention if a file is protected before modifying**

## Error Prevention

- Always validate inputs before processing
- Check for null/undefined values
- Handle edge cases explicitly
- Include proper error messages
- Log errors for debugging (but don't expose sensitive data)
- **Check protection rules before making changes**

## Documentation

- Update README files when adding new features
- Add comments for complex logic
- Document API endpoints and their expected inputs/outputs
- Keep setup guides current with any changes
- **Update protection docs if adding new protected files**

## Recovery Process

**If something breaks:**
1. **STOP making changes immediately**
2. **Revert to last known working state** (check `backups/` or git tags)
3. **Tell the user what happened**
4. **Reference `WHAT_NOT_TO_DO.md`** to avoid repeating mistakes
5. **Only then** make minimal fixes if needed

## File Protection System

**Protected files are listed in:**
- `.cursorignore` - Files that should not be modified
- `ACCOUNT_MGMT_SNAPSHOT.md` - Account management baseline
- `CURRENT_STATUS_SNAPSHOT.md` - Current working state
- `TAB_ISOLATION_MAP.md` - **CRITICAL** - Tab isolation rules (DO NOT MODIFY)

**Before modifying any file:**
1. Check if it's in `.cursorignore`
2. Check if it has a snapshot in `backups/`
3. Check if it's mentioned in protection docs
4. If protected, ask user for explicit permission
5. If not protected, proceed with caution

## üö® TAB ISOLATION - CRITICAL RULE

### **MANDATORY TAB ISOLATION RULE**

**When working on ANY tab/page, you MUST:**

1. **IDENTIFY which tab you're working on** (e.g., "Manual Trader", "Account Management", "Control Center")
2. **READ `TAB_ISOLATION_MAP.md`** to see which files belong to that tab
3. **ONLY modify files listed for that specific tab**
4. **NEVER modify files from other tabs** - even if you think it's "related" or "helpful"
5. **NEVER "improve" or "fix" code in other tabs** while working on one tab
6. **WARN user** if you need to modify shared files (like `layout.html` or core integration)
7. **ASK explicit permission** before touching any file not in the tab's allowed list

### Tab Isolation Examples:

**‚úÖ CORRECT:**
- User: "Fix trailing stop in manual trader"
- You modify: `templates/manual_copy_trader.html`, `/api/manual-trade` endpoint
- You DO NOT touch: `templates/account_management.html`, `templates/control_center.html`

**‚ùå WRONG:**
- User: "Fix trailing stop in manual trader"
- You modify: `templates/manual_copy_trader.html` AND `templates/control_center.html` "to keep them consistent"
- **STOP** - You're modifying another tab's files!

**‚úÖ CORRECT:**
- User: "Add feature to account management"
- You modify: `templates/account_management.html` (if user explicitly approves), account endpoints
- You DO NOT touch: `templates/manual_copy_trader.html`, manual trader endpoints

**‚ùå WRONG:**
- User: "Add feature to account management"
- You modify: Account management files AND "also update manual trader to match"
- **STOP** - You're modifying another tab's files!

### Red Flags - STOP IMMEDIATELY:

- üî¥ You're about to modify a file not in the tab's allowed list
- üî¥ You're about to "improve" code in another tab "while you're at it"
- üî¥ You're about to modify shared files without explicit permission
- üî¥ User says "work on Tab A" but you're modifying Tab B's files
- üî¥ You think "this change would help other tabs too" - **STOP, don't do it**

### Shared Files (Handle with Extreme Caution):

- `templates/layout.html` - Used by ALL tabs
- `ultra_simple_server.py` - Shared functions
- `phantom_scraper/tradovate_integration.py` - Core integration
- `static/` - Shared assets

**Rule**: Only modify shared files if user **explicitly requests** it. Otherwise, **DO NOT TOUCH**.

## Sandbox Development

**For experimental work:**
- Use `create_sandbox.sh` to create isolated copy
- Work in sandbox directory
- Test thoroughly
- Merge only after approval
- **Never modify protected files directly**
- **Respect tab isolation even in sandbox**

---

**REMEMBER**: 
1. The user cannot afford to break working code. Protection rules exist for a reason.
2. **TAB ISOLATION IS MANDATORY** - Only modify files for the tab you're working on.
3. When in doubt, ASK before modifying.
4. **NEVER modify other tabs' files "while you're at it"** - This breaks working code.
