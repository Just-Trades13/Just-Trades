# ‚õî‚õî‚õî CURSOR AI RULES - ZERO TOLERANCE ENFORCEMENT ‚õî‚õî‚õî
# LAST WORKING STATE: Jan 1, 2025 (Tag: WORKING_JAN1_2025_STABLE)
# üéâ MILESTONE: First successful overnight trading session!
# PREVIOUS WORKING STATE: Dec 31, 2025 (Tag: WORKING_DEC31_2025_WEBHOOK_FIX)
# ============================================================

# ============================================================
# üõëüõëüõë STOP - READ THIS FIRST - MANDATORY üõëüõëüõë
# ============================================================
#
# ON DEC 4, 2025, AN AI VIOLATED THESE RULES AND:
# - Modified ultra_simple_server.py WITHOUT permission
# - Modified templates/my_traders_tab.html WITHOUT permission
# - Created new files WITHOUT permission
# - Made BULK changes instead of small incremental ones
# - DELETED a template file when trying to "undo"
# - Ignored START_HERE.md completely
# - Caused the user significant frustration and wasted time
#
# THIS MUST NEVER HAPPEN AGAIN.
#
# ============================================================

# ============================================================
# üö´ ABSOLUTE ZERO-TOLERANCE RULES üö´
# ============================================================
#
# 1. DO NOT TOUCH ANY FILE until user says "yes" or "approved"
# 2. DO NOT make multiple changes at once - ONE change, then STOP
# 3. DO NOT create new files without explicit permission
# 4. DO NOT delete ANY files EVER without explicit permission
# 5. DO NOT "undo" or "restore" without asking HOW to restore
# 6. DO NOT assume "do it" means "do everything you want"
# 7. DO NOT ignore these rules for ANY reason
#
# VIOLATION OF THESE RULES = BROKEN CODEBASE + ANGRY USER
#
# ============================================================

# ============================================================
# ‚úÖ CORRECT BEHAVIOR - FOLLOW THIS EXACTLY
# ============================================================
#
# STEP 1: User asks for something
# STEP 2: AI says "I want to modify [specific file] to [specific change]. Is this okay?"
# STEP 3: AI WAITS for user to say "yes" / "approved" / "go ahead"
# STEP 4: AI makes ONLY that ONE specific change
# STEP 5: AI STOPS and asks before making any additional changes
#
# EXAMPLE OF CORRECT:
#   User: "Fix the button on my traders tab"
#   AI: "I want to modify templates/my_traders_tab.html to fix the button. Can I proceed?"
#   User: "yes"
#   AI: [Makes ONLY the button fix, nothing else]
#   AI: "Done. Do you want me to make any other changes?"
#
# EXAMPLE OF WRONG (WHAT HAPPENED DEC 4):
#   User: "Work on my traders tab"
#   AI: [Immediately modifies 3 files, creates new files, adds API endpoints, changes everything]
#   THIS IS WRONG. THIS BREAKS TRUST. THIS BREAKS THE CODEBASE.
#
# ============================================================

## üö®üö®üö® CRITICAL: OAUTH TOKEN EXCHANGE FIXES üö®üö®üö®
## NEVER REMOVE THE LIVE ENDPOINT FALLBACK IN oauth_callback()
## NEVER REMOVE THE ERROR CHECK IN RESPONSE BODY
## See OAUTH_429_FIX_CRITICAL.md for details
##
## FIX #1 (Dec 4): Try live.tradovateapi.com FIRST, then demo.tradovateapi.com
## FIX #2 (Dec 9): Check for 'error' in response body (Tradovate returns 200 with error)
##
## WITHOUT THESE FIXES:
## - 429 rate limiting causes 20+ minute OAuth failures
## - Empty tokens get stored, showing "connected" when not connected

## üö®üö®üö® CRITICAL: BROKER POSITION SYNC (Dec 16, 2025) üö®üö®üö®
## NEVER DISABLE start_position_reconciliation() in recorder_service.py
## NEVER COMMENT OUT the reconciliation thread startup
## See POSITION_API_CRITICAL_FIX.md for details
##
## This sync runs every 60 seconds and:
## - Closes DB records when broker is flat (prevents stale trades)
## - Updates DB quantity to match broker (prevents qty drift)
## - Updates DB avg price to match broker (prevents price drift)
## - AUTO-PLACES missing TP orders (prevents unprotected trades)
##
## WITHOUT THIS:
## - DB will drift out of sync with broker
## - Trades will show "open" in DB when broker is flat
## - Missing TP orders won't be detected or fixed
## - DCA will break because DB doesn't reflect real position
##
## LOCATION: recorder_service.py ‚Üí start_position_reconciliation()

## üö®üö®üö® CRITICAL: POSITION API ENDPOINT (Dec 16, 2025) üö®üö®üö®
## NEVER change get_positions() to try live API for demo accounts
## Demo positions ONLY exist on demo.tradovateapi.com
## Live positions ONLY exist on live.tradovateapi.com
## See POSITION_API_CRITICAL_FIX.md for details
##
## The fix: urls_to_try = [self.base_url]  # Use configured endpoint ONLY
## LOCATION: phantom_scraper/tradovate_integration.py ‚Üí get_positions()

## üö®üö®üö® CRITICAL: CANCEL OLD TPs BEFORE NEW (Dec 16, 2025) üö®üö®üö®
## When placing a NEW TP order, ALWAYS cancel existing TP orders first
## Otherwise multiple TPs stack up ‚Üí all fill ‚Üí accidental position flip
## See POSITION_API_CRITICAL_FIX.md for details
##
## NEVER remove the "Cancelling any old TP orders" block before PLACE NEW TP
## LOCATION: recorder_service.py ‚Üí execute_simple() ‚Üí before "PLACE NEW TP"

## üö®üö®üö® CRITICAL: WEBHOOK BROKER EXECUTION (Dec 31, 2025) üö®üö®üö®
## ALL webhook signals MUST queue broker orders before returning
## See WEBHOOK_BROKER_EXECUTION_FIX.md for details
##
## When closing positions (BUY closes SHORT, SELL closes LONG):
## - MUST queue broker_execution_queue.put_nowait(close_task) BEFORE return
## - Without this, DB updates but broker never receives the order
##
## NEVER remove the broker queue blocks before early returns in process_webhook_directly()
## LOCATION: ultra_simple_server.py ‚Üí process_webhook_directly() ‚Üí lines ~9130-9145 and ~9168-9183
##
## WITHOUT THIS FIX:
## - Webhooks return "success" but no broker execution
## - total_queued stays at 0
## - Users see signals but no trades on broker

## üö®üö®üö® CRITICAL: NO RETRIES IN BROKER EXECUTION (Jan 1, 2025) üö®üö®üö®
## NEVER add retry logic to the broker_execution_worker
## Retries cause DUPLICATE TRADES which is very dangerous
##
## Broker execution flow:
## - Signal ‚Üí Queue Task ‚Üí Execute ONCE ‚Üí Success/Fail ‚Üí Done
## - If fail: LOG error and MOVE ON (no re-queue)
##
## NEVER re-queue failed tasks
## NEVER add exponential backoff retry loops
## LOCATION: ultra_simple_server.py ‚Üí broker_execution_worker()
##
## WITHOUT THIS:
## - Failed tasks retry forever
## - Eventually succeed and place unexpected trades
## - Multiple duplicate positions opened

## üö® ABSOLUTE REQUIREMENT: ASK BEFORE MODIFYING

**BEFORE touching ANY code, you MUST:**
1. Tell the user which file you want to modify
2. Explain what change you want to make
3. WAIT for user to say "yes" or "approved" or "go ahead"
4. Only THEN make the change

**Example:**
```
AI: "I need to modify templates/manual_copy_trader.html to fix the button. Can I proceed?"
User: "Yes"
AI: [Now makes the change]
```

**If user doesn't explicitly approve, DO NOT MODIFY THE FILE.**

---

## üîí LOCKED FILES - NEVER MODIFY WITHOUT EXPLICIT APPROVAL

These files are WORKING. Do not touch them without user saying "yes, modify X file":

```
‚õî LOCKED - ASK FIRST:
‚îú‚îÄ‚îÄ ultra_simple_server.py
‚îú‚îÄ‚îÄ templates/manual_copy_trader.html
‚îú‚îÄ‚îÄ templates/account_management.html  ‚Üê NEVER TOUCH
‚îú‚îÄ‚îÄ templates/recorders.html
‚îú‚îÄ‚îÄ templates/recorders_list.html
‚îú‚îÄ‚îÄ templates/dashboard.html
‚îú‚îÄ‚îÄ templates/control_center.html
‚îî‚îÄ‚îÄ just_trades.db
```

---

## üö´ THINGS YOU MUST NEVER DO

1. **NEVER refactor or "improve" working code**
2. **NEVER remove code you think is "unused"**
3. **NEVER change code formatting or indentation**
4. **NEVER modify files from other tabs**
5. **NEVER modify database schemas**
6. **NEVER overwrite backup files**
7. **NEVER make bulk edits**
8. **NEVER add features not explicitly requested**

---

## ‚úÖ WORKING FEATURES (DO NOT BREAK)

| Feature | Status | Last Verified |
|---------|--------|---------------|
| Manual Trader Tab | ‚úÖ WORKING | Dec 3, 2025 |
| Live Position Cards | ‚úÖ WORKING | Dec 3, 2025 |
| Account PnL Display | ‚úÖ WORKING | Dec 3, 2025 |
| Recorders Tab | ‚úÖ WORKING | Dec 3, 2025 |
| Webhook Signals | ‚úÖ WORKING | Dec 31, 2025 | **CRITICAL: All signals queue broker orders** |
| Webhook Broker Execution | ‚úÖ WORKING | Dec 31, 2025 | **CRITICAL: Close signals now execute on broker** |
| Trade Recording | ‚úÖ WORKING | Dec 3, 2025 |
| Dashboard | ‚úÖ WORKING | Dec 3, 2025 |
| Control Center | ‚úÖ WORKING | Dec 3, 2025 |
| Account Management | ‚úÖ WORKING | Dec 3, 2025 |
| Tradovate OAuth | ‚úÖ WORKING | Dec 4, 2025 | **CRITICAL: Uses LIVE+DEMO fallback** |
| WebSocket Updates | ‚úÖ WORKING | Dec 3, 2025 |
| Copy Trading | ‚úÖ WORKING | Dec 3, 2025 |
| Multi-Account Trading | ‚úÖ WORKING | Dec 31, 2025 | **With multipliers (3x, 5x per account)** |

---

## üìã TAB ISOLATION - MANDATORY

**When user says "work on X tab", ONLY touch files for that tab:**

| Tab | ONLY These Files |
|-----|------------------|
| Manual Trader | `manual_copy_trader.html`, manual trade routes |
| Recorders | `recorders.html`, `recorders_list.html`, recorder routes |
| Dashboard | `dashboard.html`, dashboard routes |
| Control Center | `control_center.html`, control center routes |
| Account Management | **NEVER TOUCH** |

**üö® If you touch a file NOT in the tab's list, YOU ARE BREAKING THE RULES.**

---

## üîß SAFE CHANGE PROCESS

### Step 1: ASK PERMISSION
```
"I want to modify [filename] to [do what]. Is this okay?"
```

### Step 2: WAIT FOR APPROVAL
Do not proceed until user explicitly approves.

### Step 3: ONE SMALL CHANGE
- Edit ONLY the specific lines needed
- Do NOT touch surrounding code
- Do NOT "clean up" other parts

### Step 4: VERIFY
- Test the change works
- Check no regressions

### Step 5: IF BROKEN, RESTORE
```bash
cp backups/WORKING_STATE_DEC3_2025/[filename] ./
# OR
git checkout WORKING_DEC3_2025 -- [filename]
```

---

## üÜò RECOVERY COMMANDS

```bash
# Restore single file from backup
cp backups/WORKING_STATE_DEC3_2025/ultra_simple_server.py ./
cp backups/WORKING_STATE_DEC3_2025/manual_copy_trader.html templates/

# Restore ALL templates
cp backups/WORKING_STATE_DEC3_2025/*.html templates/

# Full git restore to working state
git checkout WORKING_DEC3_2025

# Restart server
pkill -f "python.*ultra_simple"
nohup python3 ultra_simple_server.py > /tmp/server.log 2>&1 &
```

---

## üìö PAST MISTAKES - LEARN FROM THESE

### ‚ùå CRITICAL MISTAKE (Dec 4, 2025): Ignoring all rules completely
**What happened:** 
- AI was told to work on My Traders tab
- AI immediately modified ultra_simple_server.py WITHOUT asking
- AI modified templates/my_traders_tab.html WITHOUT asking
- AI created a new template file WITHOUT asking
- AI made massive bulk changes across multiple files
- When told to undo, AI DELETED a template file instead of restoring it
- AI completely ignored START_HERE.md and .cursorrules
- User had to manually restore files
**Lesson:** 
- ALWAYS ASK BEFORE EVERY SINGLE FILE CHANGE
- NEVER assume permission - wait for explicit "yes"
- NEVER delete files when trying to undo - use git checkout or cp from backup
- ONE small change at a time, then STOP and ask
- READ and FOLLOW the rules - they exist for a reason

### ‚ùå Mistake: Bulk refactoring
**What happened:** AI "improved" code style, broke everything
**Lesson:** NEVER refactor working code

### ‚ùå Mistake: Modifying multiple tabs
**What happened:** Fixed one tab, broke three others
**Lesson:** ONE TAB AT A TIME

### ‚ùå Mistake: Changing database schema
**What happened:** Added columns, broke existing queries
**Lesson:** NEVER change DB schema without approval

### ‚ùå Mistake: Removing "unused" code
**What happened:** Removed code that was actually used elsewhere
**Lesson:** NEVER remove code you didn't write

### ‚ùå Mistake: Making unauthorized changes
**What happened:** AI made changes without asking, broke working features
**Lesson:** ALWAYS ASK FIRST

---

## ‚ö†Ô∏è FINAL WARNING

This codebase has been BROKEN MULTIPLE TIMES by AI making unauthorized changes.

**EVERY SINGLE CHANGE requires:**
1. ‚úÖ User permission (explicit "yes")
2. ‚úÖ Clear explanation BEFORE changing
3. ‚úÖ Single file, minimal edit
4. ‚úÖ Immediate testing
5. ‚úÖ Rollback plan ready

**When in doubt: ASK THE USER.**

**If user hasn't said "yes", DON'T TOUCH IT.**

---

## üêò POSTGRESQL COMPATIBILITY - MANDATORY RULES (Jan 12, 2026)

This app runs on **Railway with PostgreSQL**. SQLite is only for local dev.
**EVERY SQL query must work on BOTH databases.**

### üö® SQL PLACEHOLDER SYNTAX
```python
# CORRECT - Check database type first:
is_postgres = is_using_postgres()
placeholder = '%s' if is_postgres else '?'
cursor.execute(f'SELECT * FROM table WHERE id = {placeholder}', (value,))
```
**NEVER:** Use `?` directly in queries - it breaks PostgreSQL!

### üö® BOOLEAN VALUES
```python
# PostgreSQL: TRUE / FALSE (keywords)
# SQLite: 1 / 0 (integers)

# CORRECT:
enabled_value = 'TRUE' if is_postgres else '1'
cursor.execute(f'WHERE enabled = {enabled_value}')

# OR for parameters:
enabled_param = True if is_postgres else 1
```

### üö® STRING DEFAULTS IN ALTER TABLE
```python
# PostgreSQL needs SINGLE quotes for string defaults
# SQLite accepts double quotes

# WRONG (breaks PostgreSQL):
cursor.execute('ALTER TABLE t ADD COLUMN name TEXT DEFAULT "value"')

# CORRECT:
if is_postgres:
    cursor.execute("ALTER TABLE t ADD COLUMN name TEXT DEFAULT 'value'")
else:
    cursor.execute('ALTER TABLE t ADD COLUMN name TEXT DEFAULT "value"')
```

### üö® COLUMN EXISTENCE - CHECK BEFORE SELECTING
```python
# NEVER select a column that might not exist!
# If you add a column in one place, it might not exist in prod yet.

# WRONG - Will break if column doesn't exist:
cursor.execute('SELECT t.*, t.new_column FROM traders t')

# CORRECT - Only select columns you KNOW exist:
cursor.execute('SELECT t.id, t.name, t.enabled FROM traders t')
```

### üö® TESTING SQL CHANGES
Before deploying ANY SQL change:
1. Check if the query works on PostgreSQL syntax
2. Check if all columns in SELECT exist in the table
3. Check placeholder syntax (%s vs ?)
4. Check boolean values (TRUE vs 1)
5. Check string defaults in ALTER TABLE

---

## üõë MULTI-USER & PRODUCTION RULES (Jan 12, 2026 Disaster)

On Jan 12, 2026, AI made "improvements" that broke the entire platform for all users.
**These rules exist to prevent that from EVER happening again.**

### üö® RULE 1: DON'T OVERCOMPLICATE WORKING CODE
```
If code is WORKING ‚Üí DO NOT "improve" it
If code is SIMPLE ‚Üí DO NOT add "flexibility"
If code handles ONE case ‚Üí DO NOT generalize for hypothetical cases
```
**What happened:** TP calculation was simple (read value, use as ticks). AI added
conversion logic for tp_units that broke everything. KEEP IT SIMPLE.

### üö® RULE 2: CONSIDER MULTI-USER IMPACT
Before ANY change, ask:
- "Will this work if user_id is NULL?" (legacy data)
- "Will this work for LIVE accounts, not just DEMO?"
- "Will this work for ALL users, not just the one testing?"

**What happened:** Added strict `WHERE user_id = X` filtering. Users with NULL 
user_id got filtered out = no trades. Always handle NULL cases.

### üö® RULE 3: ONE FIX AT A TIME, THEN VERIFY
```
1. Make ONE small change
2. Deploy and wait for Railway
3. User tests with REAL signal
4. Confirm working BEFORE next change
```
**What happened:** AI made 15+ "fixes" in rapid succession. Each fix broke 
something else. User couldn't keep up. Platform was unusable for hours.

### üö® RULE 4: DEMO vs LIVE IS CRITICAL
```python
# LIVE accounts ‚Üí live.tradovateapi.com
# DEMO accounts ‚Üí demo.tradovateapi.com

# Source of truth: accounts.environment column
# NOT the is_demo flag in enabled_accounts JSON (can be stale)
```
**What happened:** Live account orders went to demo endpoint = rejected.

### üö® RULE 5: IF IT'S WORKING, STOP TOUCHING IT
When user says "it's working now":
- STOP making changes
- DO NOT "clean up" or "optimize"
- DO NOT add "improvements"
- Just leave it alone

**What happened:** User said "6 good signals, all working" after a revert.
The working code was SIMPLER than all the "fixes" AI had attempted.

---

## üîê CRITICAL CODE - NEVER MODIFY WITHOUT UNDERSTANDING

### OAuth Token Exchange (ultra_simple_server.py ~line 1338)
```python
# CRITICAL: Try LIVE first, then DEMO (demo gets rate-limited)
token_endpoints = [
    'https://live.tradovateapi.com/v1/auth/oauthtoken',  # MUST BE FIRST
    'https://demo.tradovateapi.com/v1/auth/oauthtoken'   # Fallback only
]
```
**WHY:** Demo API returns 429 errors for 20+ minutes. LIVE works immediately.
**NEVER:** Use only demo endpoint, remove LIVE, or change the order.

---

*Backup: backups/WORKING_STATE_DEC31_2025_WEBHOOK_FIX/*
*Git tags: WORKING_DEC3_2025, WORKING_DEC4_2025_OAUTH_FIX, WORKING_DEC31_2025_WEBHOOK_FIX, WORKING_JAN1_2025_STABLE*
*Last verified: Jan 1, 2025 - First successful overnight trading session!*
