{# ⚠️ CRITICAL FOR AI ASSISTANTS: READ START_HERE.md BEFORE MODIFYING THIS FILE
   Tab: Manual Trader (/manual-trader)
   Allowed Files: This file, /api/manual-trade endpoint
   Forbidden Files: account_management.html, control_center.html (other tabs)
   See TAB_ISOLATION_MAP.md for complete file mappings.
#}
{% extends "layout.html" %}
{% block title %}Manual Trader / Copy Trader - Just.Trades.{% endblock %}
{% block page_title %}MANUAL TRADER / COPY TRADER{% endblock %}

{% block content %}

{% if not has_platform_subscription %}
<!-- Platform Access Required Overlay -->
<div class="upgrade-overlay">
    <div class="upgrade-card">
        <div class="upgrade-icon">
            <span class="material-icons">lock</span>
        </div>
        <h2>Platform Access Required</h2>
        <p>You need a <strong>Platform subscription</strong> to use Manual/Copy Trading. Discord subscriptions provide community access only.</p>
        <div class="upgrade-features">
            <div class="feature-item"><span class="material-icons">check_circle</span> Manual trade execution</div>
            <div class="feature-item"><span class="material-icons">check_circle</span> Copy trading from other users</div>
            <div class="feature-item"><span class="material-icons">check_circle</span> Real-time position management</div>
            <div class="feature-item"><span class="material-icons">check_circle</span> Risk management tools</div>
        </div>
        <div class="upgrade-buttons">
            <a href="/pricing" class="btn-upgrade">
                <span class="material-icons">rocket_launch</span>
                View Pricing Plans
            </a>
            <a href="/dashboard" class="btn-back">
                <span class="material-icons">arrow_back</span>
                Back to Dashboard
            </a>
        </div>
        <p class="current-tier">Your current plan: <strong>{% if subscription_status.tier == 'none' %}None{% else %}Discord Only{% endif %}</strong></p>
    </div>
</div>
<style>
    .upgrade-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(15, 23, 42, 0.95);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 20px;
    }
    .upgrade-card {
        background: linear-gradient(135deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.98));
        border: 1px solid rgba(25, 184, 255, 0.3);
        border-radius: 24px;
        padding: 48px;
        max-width: 520px;
        text-align: center;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }
    .upgrade-icon {
        width: 80px;
        height: 80px;
        background: linear-gradient(135deg, rgba(25, 184, 255, 0.2), rgba(15, 136, 204, 0.1));
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 24px;
    }
    .upgrade-icon .material-icons {
        font-size: 40px;
        color: var(--primary-color);
    }
    .upgrade-card h2 {
        font-size: 1.5rem;
        margin-bottom: 12px;
        color: var(--text-light);
    }
    .upgrade-card > p {
        color: var(--text-muted);
        margin-bottom: 24px;
        line-height: 1.6;
    }
    .upgrade-features {
        text-align: left;
        margin-bottom: 32px;
        padding: 20px;
        background: rgba(148, 163, 184, 0.05);
        border-radius: 12px;
    }
    .feature-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 0;
        color: var(--text-light);
        font-size: 0.9rem;
    }
    .feature-item .material-icons {
        color: #22c55e;
        font-size: 20px;
    }
    .upgrade-buttons {
        display: flex;
        gap: 12px;
        justify-content: center;
        flex-wrap: wrap;
    }
    .btn-upgrade {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 14px 28px;
        background: linear-gradient(135deg, var(--primary-color), var(--primary-color-dark));
        color: white;
        border-radius: 12px;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.2s ease;
    }
    .btn-upgrade:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(25, 184, 255, 0.4);
    }
    .btn-back {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 14px 28px;
        background: rgba(148, 163, 184, 0.15);
        color: var(--text-light);
        border-radius: 12px;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.2s ease;
    }
    .btn-back:hover {
        background: rgba(148, 163, 184, 0.25);
    }
    .current-tier {
        margin-top: 24px;
        font-size: 0.85rem;
        color: var(--text-muted);
    }
</style>
{% endif %}

<div class="manual-copy-wrapper">
    <section class="manual-trader">
        <header>
            <h1>Manual Trader</h1>
        </header>
        <div class="manual-form">
            <div class="trade-setup-grid">
                <div class="setup-card">
                    <h3>Order Setup</h3>
                    <label>
                        <span>Account</span>
                        <div class="select-shell">
                            <select id="manualAccountSelect" required>
                                <option value="">Select account...</option>
                                <option value="1:26029294">Mark - DEMO4419847-2 (Demo)</option>
                                <option value="1:544727">Mark - 1381296 (Live)</option>
                            </select>
                            <span class="material-icons">expand_more</span>
                        </div>
                    </label>
                    <label>
                        <span>Ticker</span>
                        <div class="select-shell">
                            <select id="manualTickerSelect">
                                <option value="">Select or type a ticker</option>
                                <option value="ES1!">ES1!</option>
                                <option value="NQ1!">NQ1!</option>
                                <option value="MES1!">MES1!</option>
                                <option value="MNQ1!">MNQ1!</option>
                            </select>
                            <span class="material-icons">expand_more</span>
                        </div>
                    </label>
                    <label>
                        <span>Position Size (Qty)</span>
                        <input type="number" id="manualPositionSize" value="1" min="1" step="1">
                    </label>
                </div>
                <div class="risk-card">
                    <h3>Targets</h3>
                    <label>
                        <span>Take Profit (ticks)</span>
                        <input type="number" id="takeProfitTicks" placeholder="e.g. 20" min="1">
                    </label>
                    <label>
                        <span>Stop Loss (ticks)</span>
                        <input type="number" id="stopLossTicks" placeholder="e.g. 10" min="1">
                    </label>
                </div>
                <div class="risk-card">
                    <h3>Trailing / Breakeven</h3>
                    <label class="toggle-row">
                        <input type="checkbox" id="useTrailingStop">
                        <span>Enable Trailing Stop</span>
                    </label>
                    <label>
                        <span>Trailing Stop (ticks)</span>
                        <input type="number" id="trailTicks" placeholder="e.g. 6" min="1">
                    </label>
                    <label class="toggle-row">
                        <input type="checkbox" id="useBreakEven">
                        <span>Enable Breakeven</span>
                    </label>
                    <label>
                        <span>Breakeven Trigger (ticks)</span>
                        <input type="number" id="breakEvenTrigger" placeholder="e.g. 8" min="1">
                    </label>
                </div>
            </div>
            <div class="manual-actions">
                <button class="btn btn-sell" type="button" id="manualSellBtn">SELL</button>
                <button class="btn btn-close" type="button" id="manualCloseBtn">CLOSE</button>
                <button class="btn btn-buy" type="button" id="manualBuyBtn">BUY</button>
            </div>
        </div>
    </section>

    <section class="live-positions">
        <header>
            <div>
                <h2>Live Positions</h2>
                <p>Real-time position tracking via WebSocket</p>
            </div>
            <div class="position-controls">
                <span id="wsStatus" class="badge badge-secondary">Connecting...</span>
            </div>
        </header>
        <div id="positionsContainer" class="positions-container">
            <div class="positions-placeholder">
                <i class="material-icons">trending_up</i>
                <p>Select an account to view live positions</p>
            </div>
        </div>
    </section>

    <!-- ================================================================== -->
    <!-- PRO COPY TRADER — Leader/Follower Auto-Copy                       -->
    <!-- ================================================================== -->
    {% if not has_advanced_copy_trader %}
    <section class="pro-copy-trader" style="position:relative;overflow:hidden">
        <div class="pro-upgrade-overlay">
            <span class="material-icons" style="font-size:2rem;color:rgba(168,85,247,0.7)">lock</span>
            <h3>Pro Copy Trader</h3>
            <p>Auto-copy trades from a leader account to multiple followers via WebSocket.</p>
            <p style="font-size:0.8rem;color:rgba(148,163,184,0.7)">Available on Pro Copy Trader ($100/mo) and Basic+ plans.</p>
            <a href="/pricing" class="btn-small" style="padding:0.6rem 1.5rem;font-size:0.85rem;text-decoration:none">View Plans</a>
        </div>
    </section>
    {% else %}
    <section class="pro-copy-trader cockpit" id="proCopyTraderSection">
        <!-- Cockpit Header -->
        <header class="cockpit-header">
            <div class="cockpit-title-row">
                <div>
                    <h2>Pro Copy Trader</h2>
                    <p>Auto-copy trades from a leader account to followers via WebSocket</p>
                </div>
                <div class="cockpit-controls">
                    {% if current_user and current_user.is_admin %}
                    <div class="pro-copy-master-toggle" id="masterToggleContainer">
                        <span style="font-size:0.8rem;color:rgba(148,163,184,0.7);margin-right:0.5rem;">Copy Trading:</span>
                        <label class="copy-toggle">
                            <input type="checkbox" id="masterCopyToggle" checked>
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="master-status" id="masterStatus" style="font-size:0.8rem;margin-left:0.4rem;font-weight:600;color:#22c55e;">Active</span>
                    </div>
                    {% endif %}
                    <div class="pro-copy-mode-toggle">
                        <span class="mode-label" id="modeManualLabel">Manual</span>
                        <label class="copy-toggle">
                            <input type="checkbox" id="autoCopyMode">
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="mode-label" id="modeAutoLabel">Auto</span>
                    </div>
                </div>
            </div>
            <div class="cockpit-stats-bar" id="cockpitStatsBar">
                <div class="stat-pill" id="statStatus">
                    <span class="stat-dot" id="wsDot"></span>
                    <span class="stat-label">Status</span>
                    <span class="stat-value" id="wsStatusText">Manual</span>
                </div>
                <div class="stat-pill">
                    <span class="stat-label">Copies</span>
                    <span class="stat-value" id="statTotalCopies">--</span>
                </div>
                <div class="stat-pill">
                    <span class="stat-label">Success</span>
                    <span class="stat-value" id="statSuccessRate">--</span>
                </div>
                <div class="stat-pill">
                    <span class="stat-label">Avg Latency</span>
                    <span class="stat-value" id="statAvgLatency">--</span>
                </div>
                <div class="stat-pill">
                    <span class="stat-label">Leader</span>
                    <span id="leaderPositionBadge" class="position-badge flat">FLAT</span>
                </div>
            </div>
        </header>

        <!-- Compact Leader Strip -->
        <div class="cockpit-leader-strip">
            <div class="leader-avatar"><span class="material-icons">stars</span></div>
            <div class="leader-select-row" style="flex:1">
                <div class="select-shell" style="flex:1">
                    <select id="leaderAccountSelect">
                        <option value="">Select leader...</option>
                    </select>
                    <span class="material-icons">expand_more</span>
                </div>
                <button type="button" class="btn-small" id="setLeaderBtn">Set Leader</button>
            </div>
            <div id="leaderStatus" class="leader-status-inline" style="display:none">
                <span class="status-dot" id="leaderStatusDot"></span>
                <span id="leaderStatusText">Not connected</span>
            </div>
        </div>

        <!-- Follower Accounts -->
        <div class="cockpit-followers-section">
            <div class="section-header-row">
                <h3>Follower Accounts</h3>
                <div class="follower-actions-row">
                    <button type="button" class="btn-small" id="addAllFollowersBtn">Add All</button>
                    <button type="button" class="btn-small btn-outline" id="refreshFollowersBtn">Refresh</button>
                </div>
            </div>
            <div class="followers-table-wrapper" id="followerAccountsList">
                <div class="follower-placeholder">
                    <i class="material-icons">group_add</i>
                    <p>Set a leader account first, then add follower accounts</p>
                </div>
            </div>
        </div>

        <!-- Copy Trade Log -->
        <div class="cockpit-log-section">
            <div class="section-header-row">
                <h3>Copy Trade Log</h3>
                <span class="log-count-badge" id="logCountBadge">0 trades</span>
            </div>
            <div class="copy-trade-log-wrapper">
                <div id="copyTradeLog" class="copy-trade-log">
                    <div class="log-placeholder">
                        <i class="material-icons">history</i>
                        <p>No copy trades yet</p>
                    </div>
                </div>
            </div>
        </div>
    </section>
    {% endif %}
</div>
{% endblock %}

{% block styles %}
<style>
    .manual-copy-wrapper {
        display: grid;
        gap: 1.5rem;
    }
    .manual-trader {
        background: rgba(11,18,33,0.92);
        border-radius: 18px;
        border: 1px solid rgba(59,130,246,0.25);
        padding: 1.75rem;
        display: grid;
        gap: 1.25rem;
    }
    .manual-trader header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        justify-content: space-between;
    }
    .manual-trader h1 { margin: 0; font-size: 1.5rem; }
    .badge {
        padding: 0.25rem 0.75rem;
        border-radius: 999px;
        background: rgba(59,130,246,0.25);
        color: #bfdbfe;
        font-size: 0.75rem;
        letter-spacing: 0.1em;
    }
    .badge-secondary {
        background: rgba(148,163,184,0.2);
        color: #cbd5f5;
    }
    .manual-form {
        display: grid;
        gap: 1rem;
    }
    .trade-setup-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
    }
    @media (max-width: 900px) {
        .trade-setup-grid {
            grid-template-columns: 1fr;
        }
    }
    .setup-card {
        background: rgba(15,23,42,0.55);
        border: 1px solid rgba(59,130,246,0.25);
        border-radius: 16px;
        padding: 1rem;
        display: grid;
        gap: 0.65rem;
    }
    .setup-card h3 {
        margin: 0;
        font-size: 0.95rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: rgba(226,232,240,0.8);
    }
    label { display: grid; gap: 0.35rem; color: var(--text-muted); font-size: 0.8rem; letter-spacing: 0.08em; text-transform: uppercase; }
    input, select {
        background: rgba(15,23,42,0.55);
        border: 1px solid rgba(148,163,184,0.25);
        border-radius: 12px;
        color: #e2e8f0;
        padding: 0.6rem 0.75rem;
        font-size: 0.95rem;
    }
    .select-shell { position: relative; }
    .select-shell select { width: 100%; appearance: none; }
    .select-shell .material-icons {
        position: absolute;
        right: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-muted);
        font-size: 1rem;
        pointer-events: none;
    }
    .risk-card {
        background: rgba(15,23,42,0.55);
        border: 1px solid rgba(59,130,246,0.25);
        border-radius: 16px;
        padding: 1rem;
        display: grid;
        gap: 0.65rem;
    }
    .risk-card h3 {
        margin: 0;
        font-size: 0.95rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: rgba(226,232,240,0.8);
    }
    .toggle-row {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: rgba(226,232,240,0.8);
        text-transform: none;
    }
    .toggle-row input[type="checkbox"] {
        width: 18px;
        height: 18px;
    }
    .manual-actions {
        display: grid;
        grid-template-columns: repeat(auto-fit,minmax(100px,1fr));
        gap: 0.75rem;
    }
    .btn {
        border: none;
        border-radius: 12px;
        padding: 0.7rem 1.4rem;
        font-weight: 600;
        letter-spacing: 0.08em;
        cursor: pointer;
        text-transform: uppercase;
    }
    .btn-sell { background: linear-gradient(135deg,#f87171,#ef4444); color: #0b1120; }
    .btn-buy { background: linear-gradient(135deg,#34d399,#10b981); color: #0b1120; }
    .btn-close { background: linear-gradient(135deg,#fb923c,#f97316); color: #0b1120; }
    /* Copy Trader Toggle Switch */
    .copy-toggle {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        cursor: pointer;
    }
    .copy-toggle input[type="checkbox"] {
        display: none;
    }
    .toggle-slider {
        width: 48px;
        height: 26px;
        background: rgba(71,85,105,0.5);
        border-radius: 999px;
        position: relative;
        transition: background 0.3s ease;
    }
    .toggle-slider::after {
        content: '';
        position: absolute;
        width: 20px;
        height: 20px;
        background: #e2e8f0;
        border-radius: 50%;
        top: 3px;
        left: 3px;
        transition: transform 0.3s ease;
    }
    .copy-toggle input:checked + .toggle-slider {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
    }
    .copy-toggle input:checked + .toggle-slider::after {
        transform: translateX(22px);
    }
    .toggle-label {
        font-size: 0.85rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: rgba(226,232,240,0.8);
    }
    .copy-toggle input:checked ~ .toggle-label {
        color: #3b82f6;
    }
    
    .live-positions {
        background: rgba(11,18,33,0.92);
        border-radius: 18px;
        border: 1px solid rgba(59,130,246,0.25);
        padding: 1.75rem;
        display: grid;
        gap: 1.25rem;
    }
    .live-positions header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 0.75rem;
    }
    .live-positions h2 {
        margin: 0;
        font-size: 1.5rem;
    }
    .position-controls {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .positions-container {
        min-height: 200px;
    }
    .positions-placeholder {
        border: 1px dashed rgba(148,163,184,0.35);
        border-radius: 16px;
        padding: 2rem;
        text-align: center;
        color: rgba(226,232,240,0.8);
    }
    .positions-placeholder i {
        font-size: 2.5rem;
        display: block;
        margin-bottom: 0.75rem;
        color: rgba(59,130,246,0.6);
    }
    .positions-table {
        width: 100%;
        border-collapse: collapse;
    }
    .positions-table th,
    .positions-table td {
        padding: 0.75rem;
        text-align: left;
        border-bottom: 1px solid rgba(148,163,184,0.15);
    }
    .positions-table th {
        color: rgba(226,232,240,0.6);
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        font-weight: 600;
    }
    .positions-table td {
        color: rgba(226,232,240,0.9);
        font-size: 0.9rem;
    }
    .positions-table tr:hover {
        background: rgba(59,130,246,0.05);
    }
    .position-quantity {
        font-weight: 600;
    }
    .position-quantity.positive {
        color: #10b981;
    }
    .position-quantity.negative {
        color: #f87171;
    }
    .position-pnl {
        font-weight: 600;
    }
    .position-pnl.positive {
        color: #10b981;
    }
    .position-pnl.negative {
        color: #f87171;
    }
    /* Account PnL Summary Styles */
    .pnl-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1rem;
        margin-bottom: 1.25rem;
    }
    .account-pnl-card {
        background: rgba(15,23,42,0.55);
        border: 1px solid rgba(59,130,246,0.25);
        border-radius: 14px;
        padding: 1rem;
    }
    .account-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid rgba(148,163,184,0.15);
    }
    .account-name {
        font-weight: 600;
        font-size: 0.95rem;
        color: #e2e8f0;
    }
    .account-type-badge {
        padding: 0.2rem 0.5rem;
        border-radius: 999px;
        font-size: 0.65rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        font-weight: 600;
    }
    .account-type-badge.demo {
        background: rgba(251,191,36,0.2);
        color: #fcd34d;
    }
    .account-type-badge.live {
        background: rgba(16,185,129,0.2);
        color: #6ee7b7;
    }
    .account-type {
        font-size: 0.75rem;
        color: rgba(148,163,184,0.7);
    }
    .pnl-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.35rem 0;
    }
    .pnl-label {
        color: rgba(148,163,184,0.9);
        font-size: 0.8rem;
    }
    .pnl-value {
        font-weight: 600;
        font-size: 0.95rem;
    }
    .pnl-value.positive {
        color: #10b981;
    }
    .pnl-value.negative {
        color: #f87171;
    }
    .pnl-row.net-liq {
        margin-top: 0.5rem;
        padding-top: 0.5rem;
        border-top: 1px solid rgba(148,163,184,0.15);
    }
    .pnl-row.net-liq .pnl-value {
        color: #38bdf8;
    }
    @media (max-width: 900px) {
        .manual-copy-wrapper {
            grid-template-columns: 1fr;
        }
    }

    /* ===== LIGHT MODE OVERRIDES ===== */
    :root[data-theme="light"] .manual-trader,
    :root[data-theme="light"] .live-positions {
        background: #ffffff !important;
        border-color: rgba(148, 163, 184, 0.2) !important;
    }
    :root[data-theme="light"] .manual-trader header,
    :root[data-theme="light"] .live-positions header {
        background: #f8fafc !important;
    }
    :root[data-theme="light"] .manual-trader h1,
    :root[data-theme="light"] .manual-trader h3,
    :root[data-theme="light"] .live-positions h2 {
        color: #1e293b !important;
    }
    :root[data-theme="light"] .live-positions p {
        color: #64748b !important;
    }
    :root[data-theme="light"] .setup-card,
    :root[data-theme="light"] .risk-card {
        background: #f8fafc !important;
        border-color: rgba(148, 163, 184, 0.2) !important;
    }
    :root[data-theme="light"] label {
        color: #475569 !important;
    }
    :root[data-theme="light"] input,
    :root[data-theme="light"] select {
        background: #ffffff !important;
        color: #1e293b !important;
        border-color: rgba(148, 163, 184, 0.3) !important;
    }
    :root[data-theme="light"] input:focus,
    :root[data-theme="light"] select:focus {
        border-color: #3b82f6 !important;
        background: #ffffff !important;
    }
    :root[data-theme="light"] .select-shell {
        background: #ffffff !important;
    }
    :root[data-theme="light"] .select-shell .material-icons {
        color: #64748b !important;
    }
    :root[data-theme="light"] .toggle-row span {
        color: #475569 !important;
    }
    :root[data-theme="light"] .badge-secondary {
        background: rgba(148, 163, 184, 0.2) !important;
        color: #475569 !important;
    }
    :root[data-theme="light"] .badge-success {
        background: rgba(34, 197, 94, 0.15) !important;
        color: #15803d !important;
    }
    :root[data-theme="light"] .badge-warning {
        background: rgba(234, 179, 8, 0.15) !important;
        color: #a16207 !important;
    }
    :root[data-theme="light"] .positions-placeholder,
    :root[data-theme="light"] .positions-placeholder p {
        color: #64748b !important;
    }
    :root[data-theme="light"] .position-card {
        background: #ffffff !important;
        border-color: rgba(148, 163, 184, 0.2) !important;
    }
    :root[data-theme="light"] .position-card:hover {
        border-color: rgba(59, 130, 246, 0.4) !important;
        background: #f8fafc !important;
    }
    :root[data-theme="light"] .position-symbol {
        color: #0284c7 !important;
    }
    :root[data-theme="light"] .position-account {
        color: #64748b !important;
    }
    :root[data-theme="light"] .position-qty,
    :root[data-theme="light"] .position-entry,
    :root[data-theme="light"] .position-current,
    :root[data-theme="light"] .position-pnl {
        color: #1e293b !important;
    }
    :root[data-theme="light"] .copy-config-card {
        background: #f8fafc !important;
        border-color: rgba(148, 163, 184, 0.2) !important;
    }
    :root[data-theme="light"] .copy-config-card:hover {
        border-color: rgba(59, 130, 246, 0.4) !important;
    }
    :root[data-theme="light"] .config-header span {
        color: #1e293b !important;
    }
    :root[data-theme="light"] .config-detail {
        color: #64748b !important;
    }
    :root[data-theme="light"] .active-config {
        background: rgba(59, 130, 246, 0.08) !important;
        border-color: rgba(59, 130, 246, 0.3) !important;
    }
    :root[data-theme="light"] .inactive-config {
        background: #f8fafc !important;
        border-color: rgba(148, 163, 184, 0.2) !important;
    }
    :root[data-theme="light"] .inactive-config .config-header span {
        color: #64748b !important;
    }

    /* Pro Copy Trader Upgrade Overlay */
    .pro-upgrade-overlay {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 3rem 2rem;
        text-align: center;
        gap: 0.75rem;
    }
    .pro-upgrade-overlay h3 {
        margin: 0;
        font-size: 1.2rem;
        color: #e2e8f0;
    }
    .pro-upgrade-overlay p {
        margin: 0;
        color: rgba(226,232,240,0.6);
        font-size: 0.9rem;
        max-width: 400px;
    }

    /* ===== PRO COPY TRADER STYLES ===== */
    .pro-copy-trader {
        background: rgba(11,18,33,0.92);
        border-radius: 18px;
        border: 1px solid rgba(168,85,247,0.3);
        padding: 1.75rem;
        display: grid;
        gap: 1.25rem;
    }
    .pro-copy-trader header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 0.75rem;
    }
    .pro-copy-trader h2 {
        margin: 0;
        font-size: 1.5rem;
        background: linear-gradient(135deg, #a855f7, #6366f1);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    .pro-copy-trader p {
        color: var(--text-muted);
        margin: 0;
    }
    .pro-copy-mode-toggle {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .mode-label {
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: rgba(226,232,240,0.5);
        transition: color 0.3s ease;
    }
    .mode-label.active {
        color: #a855f7;
    }
    .pro-copy-card {
        background: rgba(15,23,42,0.55);
        border: 1px solid rgba(168,85,247,0.2);
        border-radius: 14px;
        padding: 1.25rem;
        display: grid;
        gap: 0.75rem;
    }
    .pro-copy-card h3 {
        margin: 0;
        font-size: 0.95rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: rgba(226,232,240,0.8);
    }
    .card-desc {
        font-size: 0.8rem;
        color: rgba(148,163,184,0.7) !important;
    }
    .leader-select-row {
        display: flex;
        gap: 0.75rem;
        align-items: center;
    }
    .leader-status {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 0.75rem;
        background: rgba(15,23,42,0.4);
        border-radius: 8px;
        font-size: 0.85rem;
        color: rgba(226,232,240,0.7);
    }
    .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #64748b;
    }
    .status-dot.connected {
        background: #22c55e;
        box-shadow: 0 0 6px rgba(34,197,94,0.5);
    }
    .status-dot.disconnected {
        background: #f87171;
    }
    .status-dot.connecting {
        background: #fbbf24;
        animation: pulse-dot 1.5s ease infinite;
    }
    @keyframes pulse-dot {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.4; }
    }
    .follower-actions-row {
        display: flex;
        gap: 0.5rem;
    }
    .follower-accounts-list {
        display: grid;
        gap: 0.5rem;
        max-height: 400px;
        overflow-y: auto;
    }
    .follower-placeholder {
        text-align: center;
        padding: 2rem;
        color: rgba(148,163,184,0.6);
    }
    .follower-placeholder i {
        font-size: 2rem;
        display: block;
        margin-bottom: 0.5rem;
    }
    .follower-card {
        display: grid;
        grid-template-columns: auto 1fr auto;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1rem;
        background: rgba(15,23,42,0.4);
        border: 1px solid rgba(148,163,184,0.15);
        border-radius: 10px;
        transition: border-color 0.2s ease;
    }
    .follower-card:hover {
        border-color: rgba(168,85,247,0.3);
    }
    .follower-card.disabled {
        opacity: 0.5;
    }
    .follower-info {
        display: flex;
        flex-direction: column;
        gap: 0.15rem;
    }
    .follower-name {
        font-size: 0.9rem;
        font-weight: 500;
        color: #e2e8f0;
    }
    .follower-meta {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.75rem;
        color: rgba(148,163,184,0.8);
    }
    .follower-controls {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    .follower-multiplier {
        display: flex;
        align-items: center;
        gap: 0.35rem;
    }
    .follower-multiplier span {
        font-size: 0.75rem;
        color: rgba(148,163,184,0.7);
        text-transform: uppercase;
    }
    .follower-multiplier input {
        width: 60px;
        padding: 0.3rem 0.5rem;
        font-size: 0.85rem;
        border-radius: 8px;
        text-align: center;
    }
    .follower-sync-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: #64748b;
    }
    .follower-sync-dot.synced { background: #22c55e; }
    .follower-sync-dot.error { background: #f87171; }

    /* Copy Trade Log */
    .copy-trade-log {
        max-height: 250px;
        overflow-y: auto;
    }
    .log-placeholder {
        text-align: center;
        padding: 1.5rem;
        color: rgba(148,163,184,0.5);
    }
    .log-placeholder i {
        font-size: 1.5rem;
        display: block;
        margin-bottom: 0.35rem;
    }
    .log-entry {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px solid rgba(148,163,184,0.1);
        font-size: 0.8rem;
    }
    .log-entry:last-child { border-bottom: none; }
    .log-symbol { font-weight: 600; color: #e2e8f0; }
    .log-side.buy { color: #34d399; }
    .log-side.sell { color: #f87171; }
    .log-time { color: rgba(148,163,184,0.6); }
    .log-status-badge {
        padding: 0.15rem 0.4rem;
        border-radius: 4px;
        font-size: 0.65rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    .log-status-badge.filled { background: rgba(34,197,94,0.2); color: #86efac; }
    .log-status-badge.error { background: rgba(248,113,113,0.2); color: #fca5a5; }
    .log-status-badge.pending { background: rgba(251,191,36,0.2); color: #fde68a; }

    /* Leader Position Display */
    .leader-position-display {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 0.75rem;
        background: rgba(15,23,42,0.4);
        border-radius: 8px;
        font-size: 0.85rem;
    }
    .position-label { color: rgba(148,163,184,0.8); }
    .position-badge {
        padding: 0.2rem 0.6rem;
        border-radius: 6px;
        font-weight: 700;
        font-size: 0.8rem;
        letter-spacing: 0.05em;
    }
    .position-badge.flat { background: rgba(148,163,184,0.2); color: #94a3b8; }
    .position-badge.long { background: rgba(16,185,129,0.25); color: #6ee7b7; }
    .position-badge.short { background: rgba(248,113,113,0.25); color: #fca5a5; }
    .log-risk { font-size: 0.7rem; color: rgba(168,85,247,0.7); margin-left: 0.25rem; }
    .log-latency { font-size: 0.7rem; color: rgba(148,163,184,0.5); margin-left: 0.35rem; }

    /* ===== COCKPIT DASHBOARD STYLES ===== */
    .pro-copy-trader.cockpit {
        gap: 1rem;
    }
    .cockpit-header {
        display: grid;
        gap: 0.75rem;
    }
    .cockpit-title-row {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 0.75rem;
    }
    .cockpit-controls {
        display: flex;
        align-items: center;
        gap: 1rem;
        flex-wrap: wrap;
    }
    .cockpit-stats-bar {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }
    .stat-pill {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.4rem 0.75rem;
        background: rgba(15,23,42,0.55);
        border: 1px solid rgba(168,85,247,0.2);
        border-radius: 999px;
        font-size: 0.8rem;
    }
    .stat-dot {
        width: 7px;
        height: 7px;
        border-radius: 50%;
        background: #64748b;
    }
    .stat-dot.connected { background: #22c55e; box-shadow: 0 0 6px rgba(34,197,94,0.5); }
    .stat-dot.disconnected { background: #f87171; }
    .stat-dot.connecting { background: #fbbf24; animation: pulse-dot 1.5s ease infinite; }
    .stat-label {
        color: rgba(148,163,184,0.7);
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.06em;
    }
    .stat-value {
        color: #e2e8f0;
        font-weight: 600;
    }
    .cockpit-leader-strip {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1rem;
        background: rgba(15,23,42,0.55);
        border: 1px solid rgba(168,85,247,0.15);
        border-radius: 12px;
    }
    .leader-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: linear-gradient(135deg, rgba(168,85,247,0.3), rgba(99,102,241,0.2));
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }
    .leader-avatar .material-icons {
        font-size: 18px;
        color: #a855f7;
    }
    .leader-status-inline {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        font-size: 0.8rem;
        color: rgba(226,232,240,0.7);
        margin-left: auto;
    }
    .cockpit-followers-section,
    .cockpit-log-section {
        display: grid;
        gap: 0.5rem;
    }
    .section-header-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    .section-header-row h3 {
        margin: 0;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: rgba(226,232,240,0.8);
    }
    .followers-table-wrapper {
        max-height: 350px;
        overflow-y: auto;
    }
    .followers-table {
        width: 100%;
        border-collapse: collapse;
    }
    .followers-table th {
        padding: 0.5rem 0.6rem;
        text-align: left;
        color: rgba(148,163,184,0.6);
        font-size: 0.65rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        font-weight: 600;
        border-bottom: 1px solid rgba(148,163,184,0.15);
        white-space: nowrap;
    }
    .followers-table td {
        padding: 0.5rem 0.6rem;
        color: rgba(226,232,240,0.9);
        font-size: 0.85rem;
        border-bottom: 1px solid rgba(148,163,184,0.08);
    }
    .followers-table tr:hover td {
        background: rgba(168,85,247,0.04);
    }
    .follower-row.disabled td {
        opacity: 0.45;
    }
    .follower-row .follower-name {
        font-weight: 500;
        color: #e2e8f0;
    }
    .follower-row .follower-sub {
        font-size: 0.7rem;
        color: rgba(148,163,184,0.6);
    }
    .follower-row .follower-mult-input {
        width: 52px;
        padding: 0.25rem 0.35rem;
        font-size: 0.8rem;
        border-radius: 6px;
        text-align: center;
    }
    .btn-flatten {
        padding: 0.25rem 0.5rem;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        border: 1px solid rgba(248,113,113,0.35);
        border-radius: 6px;
        background: rgba(248,113,113,0.1);
        color: #fca5a5;
        cursor: pointer;
        transition: all 0.15s ease;
    }
    .btn-flatten:hover {
        background: rgba(248,113,113,0.25);
        border-color: rgba(248,113,113,0.5);
    }
    .copy-trade-log-wrapper {
        max-height: 250px;
        overflow-y: auto;
    }
    .copy-log-table {
        width: 100%;
        border-collapse: collapse;
    }
    .copy-log-table th {
        padding: 0.4rem 0.6rem;
        text-align: left;
        color: rgba(148,163,184,0.6);
        font-size: 0.65rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        font-weight: 600;
        border-bottom: 1px solid rgba(148,163,184,0.15);
        white-space: nowrap;
        position: sticky;
        top: 0;
        background: rgba(11,18,33,0.95);
    }
    .copy-log-table td {
        padding: 0.4rem 0.6rem;
        color: rgba(226,232,240,0.9);
        font-size: 0.8rem;
        border-bottom: 1px solid rgba(148,163,184,0.08);
    }
    .copy-log-table tr:hover td {
        background: rgba(168,85,247,0.04);
    }
    .log-count-badge {
        padding: 0.2rem 0.6rem;
        border-radius: 999px;
        background: rgba(168,85,247,0.15);
        color: rgba(168,85,247,0.9);
        font-size: 0.7rem;
        font-weight: 600;
        letter-spacing: 0.04em;
    }
    @media (max-width: 768px) {
        .cockpit-stats-bar { gap: 0.35rem; }
        .stat-pill { padding: 0.3rem 0.5rem; font-size: 0.7rem; }
        .cockpit-leader-strip { flex-wrap: wrap; }
        .cockpit-controls { flex-direction: column; align-items: flex-start; }
        .followers-table .col-pnl { display: none; }
        .copy-log-table .col-latency { display: none; }
    }

    /* Light mode overrides for pro copy trader */
    :root[data-theme="light"] .pro-copy-trader {
        background: #ffffff !important;
        border-color: rgba(168,85,247,0.2) !important;
    }
    :root[data-theme="light"] .pro-copy-card {
        background: #f8fafc !important;
        border-color: rgba(168,85,247,0.15) !important;
    }
    :root[data-theme="light"] .pro-copy-trader h2 {
        -webkit-text-fill-color: unset;
        background: none;
        color: #7c3aed !important;
    }
    :root[data-theme="light"] .follower-card {
        background: #ffffff !important;
        border-color: rgba(148,163,184,0.2) !important;
    }
    :root[data-theme="light"] .follower-name {
        color: #1e293b !important;
    }
    /* Light mode — cockpit overrides */
    :root[data-theme="light"] .cockpit-stats-bar .stat-pill {
        background: #f8fafc !important;
        border-color: rgba(168,85,247,0.15) !important;
    }
    :root[data-theme="light"] .stat-label { color: #64748b !important; }
    :root[data-theme="light"] .stat-value { color: #1e293b !important; }
    :root[data-theme="light"] .cockpit-leader-strip {
        background: #f8fafc !important;
        border-color: rgba(168,85,247,0.12) !important;
    }
    :root[data-theme="light"] .leader-avatar {
        background: linear-gradient(135deg, rgba(168,85,247,0.15), rgba(99,102,241,0.1)) !important;
    }
    :root[data-theme="light"] .section-header-row h3 { color: #1e293b !important; }
    :root[data-theme="light"] .followers-table th,
    :root[data-theme="light"] .copy-log-table th {
        color: #64748b !important;
        background: #ffffff !important;
        border-color: rgba(148,163,184,0.15) !important;
    }
    :root[data-theme="light"] .followers-table td,
    :root[data-theme="light"] .copy-log-table td {
        color: #334155 !important;
        border-color: rgba(148,163,184,0.1) !important;
    }
    :root[data-theme="light"] .followers-table tr:hover td,
    :root[data-theme="light"] .copy-log-table tr:hover td {
        background: rgba(168,85,247,0.03) !important;
    }
    :root[data-theme="light"] .btn-flatten {
        background: rgba(239,68,68,0.08) !important;
        border-color: rgba(239,68,68,0.25) !important;
        color: #dc2626 !important;
    }
    :root[data-theme="light"] .log-count-badge {
        background: rgba(168,85,247,0.1) !important;
        color: #7c3aed !important;
    }
    :root[data-theme="light"] .leader-status-inline {
        color: #475569 !important;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    async function loadAccountsForManualTrader() {
        const accountSelect = document.getElementById('manualAccountSelect');
        if (!accountSelect) {
            console.error('manualAccountSelect element not found');
            return;
        }
        
        try {
            const response = await fetch('/api/accounts');
            const data = await response.json();
            
            if (!data.success || !data.accounts) {
                console.error('API error:', data);
                return;
            }
            
            accountSelect.innerHTML = '<option value="">Select account...</option>';
            
            data.accounts.forEach(account => {
                if (!account.is_connected) return;
                
                const accountName = account.name || `Account ${account.id}`;
                const tradovateAccounts = account.tradovate_accounts || [];
                
                if (tradovateAccounts.length > 0) {
                    tradovateAccounts.forEach(tradAccount => {
                        const option = document.createElement('option');
                        const subaccountId = String(tradAccount.id);
                        const subaccountName = tradAccount.name || subaccountId;
                        const envLabel = tradAccount.is_demo ? ' (Demo)' : ' (Live)';
                        option.value = `${account.id}:${subaccountId}`;
                        option.textContent = `${accountName} - ${subaccountName}${envLabel}`;
                        accountSelect.appendChild(option);
                    });
                } else {
                    const option = document.createElement('option');
                    option.value = `${account.id}:`;
                    option.textContent = accountName;
                    accountSelect.appendChild(option);
                }
            });
        } catch (error) {
            console.error('Error loading accounts:', error);
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        setTimeout(() => loadAccountsForManualTrader(), 100);
        
        const accountSelect = document.getElementById('manualAccountSelect');
        if (accountSelect) {
            accountSelect.addEventListener('change', function() {
                const selectedValue = this.value;
                if (selectedValue) {
                    const [accountId, subaccountId] = selectedValue.split(':');
                    currentAccountId = accountId;
                    loadStrategiesForManualTrader(accountId, subaccountId);
                    // Positions will update via WebSocket automatically
                } else {
                    currentAccountId = null;
                    const strategySelect = document.getElementById('manualStrategySelect');
                    if (strategySelect) {
                        strategySelect.innerHTML = '<option value="">Select strategy...</option>';
                    }
                    // Clear positions display
                    const container = document.getElementById('positionsContainer');
                    if (container) {
                        container.innerHTML = `
                            <div class="positions-placeholder">
                                <i class="material-icons">trending_up</i>
                                <p>Select an account to view live positions</p>
                            </div>
                        `;
                    }
                }
            });
        }

        const buyBtn = document.getElementById('manualBuyBtn');
        const sellBtn = document.getElementById('manualSellBtn');
        const closeBtn = document.getElementById('manualCloseBtn');

        if (buyBtn) buyBtn.addEventListener('click', () => placeManualTrade('Buy'));
        if (sellBtn) sellBtn.addEventListener('click', () => placeManualTrade('Sell'));
        if (closeBtn) closeBtn.addEventListener('click', () => placeManualTrade('Close'));
    });

    async function loadStrategiesForManualTrader(accountId, subaccountId) {
        // Strategy list removed; placeholder for future use
    }

    // Convert TradingView ticker (MNQ1!) to Tradovate front-month symbol (MNQH6)
    function convertToTradovateSymbol(ticker) {
        if (!ticker) return ticker;
        const clean = ticker.trim().toUpperCase();
        
        // Already Tradovate format (no ! suffix)
        if (!clean.includes('!')) return clean;
        
        // Extract base symbol (e.g., MNQ from MNQ1!)
        const match = clean.match(/^([A-Z]+)\d*!$/);
        if (!match) return clean.replace('!', '');
        
        const root = match[1];
        
        // Calculate front month contract based on current date
        const now = new Date();
        const currentMonth = now.getMonth() + 1; // 1-12
        const currentYear = now.getFullYear() % 10; // Last digit (e.g., 2025 -> 5)
        
        // Quarterly contracts: H(Mar=3), M(Jun=6), U(Sep=9), Z(Dec=12)
        const quarterlyContracts = ['MNQ', 'MES', 'ES', 'NQ', 'YM', 'RTY', 'M2K', 'CL', 'MCL', 'GC', 'MGC', 'MYM'];
        const quarterlyMonths = [3, 6, 9, 12];
        const quarterlyMonthCodes = { 3: 'H', 6: 'M', 9: 'U', 12: 'Z' };
        
        let monthCode, year;
        
        if (quarterlyContracts.includes(root)) {
            // Find next quarterly month
            let foundMonth = null;
            let yearOffset = 0;
            
            for (const qMonth of quarterlyMonths) {
                if (currentMonth < qMonth || (currentMonth === qMonth && now.getDate() <= 15)) {
                    foundMonth = qMonth;
                    break;
                }
            }
            
            if (!foundMonth) {
                // Roll to next year's first quarterly (March)
                foundMonth = 3;
                yearOffset = 1;
            }
            
            monthCode = quarterlyMonthCodes[foundMonth];
            year = (currentYear + yearOffset) % 10;
        } else {
            // Monthly contracts - use next month
            const monthCodes = ['F', 'G', 'H', 'J', 'K', 'M', 'N', 'Q', 'U', 'V', 'X', 'Z'];
            let nextMonth = currentMonth;
            let yearOffset = 0;
            
            if (now.getDate() > 15) {
                nextMonth = currentMonth + 1;
                if (nextMonth > 12) {
                    nextMonth = 1;
                    yearOffset = 1;
                }
            }
            
            monthCode = monthCodes[nextMonth - 1];
            year = (currentYear + yearOffset) % 10;
        }
        
        const converted = `${root}${monthCode}${year}`;
        console.log(`📅 Converted ${ticker} → ${converted}`);
        return converted;
    }

    async function placeManualTrade(side) {
        try {
            const accountSelect = document.getElementById('manualAccountSelect');
            const tickerSelect = document.getElementById('manualTickerSelect');
            const positionSizeInput = document.getElementById('manualPositionSize');

            if (!accountSelect || !accountSelect.value) {
                showToast('Please select an account', 'error');
                return;
            }
            if (!tickerSelect || !tickerSelect.value) {
                showToast('Please select or enter a ticker', 'error');
                return;
            }

            const quantity = parseInt(positionSizeInput?.value || '1');
            if (isNaN(quantity) || quantity < 1) {
                showToast('Please enter a valid position size (minimum 1)', 'error');
                return;
            }

            const riskPayload = collectRiskSettings();
            
            // Convert TradingView ticker to Tradovate front-month symbol
            const tradovateSymbol = convertToTradovateSymbol(tickerSelect.value);

            // Place the primary manual trade
            const response = await fetch('/api/manual-trade', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    account_subaccount: accountSelect.value,
                    symbol: tradovateSymbol,
                    side: side,
                    quantity: quantity,
                    risk: riskPayload,
                    leader_id: currentLeaderId || null
                })
            });

            const data = await response.json();
            if (data.success) {
                showToast(`✅ ${data.message || `${side} order placed successfully`}`, 'success');
            } else {
                showToast(`❌ Error: ${data.error || 'Failed to place order'}`, 'error');
            }
        } catch (error) {
            console.error('Error placing manual trade:', error);
            showToast(`❌ Error: ${error.message || 'Failed to place order'}`, 'error');
        }
    }

    function showToast(message, type = 'info') {
        let container = document.getElementById('toast-container');
        if (!container) {
            container = document.createElement('div');
            container.id = 'toast-container';
            container.className = 'toast-container';
            document.body.appendChild(container);
        }

        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        container.appendChild(toast);

        setTimeout(() => toast.classList.add('fade-out'), 2500);
        setTimeout(() => toast.remove(), 3000);
    }

    function collectRiskSettings() {
        const tp = document.getElementById('takeProfitTicks');
        const sl = document.getElementById('stopLossTicks');
        const trailEnabled = document.getElementById('useTrailingStop');
        const trailTicks = document.getElementById('trailTicks');
        const breakEvenEnabled = document.getElementById('useBreakEven');
        const breakEvenTrigger = document.getElementById('breakEvenTrigger');

        const risk = {};

        if (tp && tp.value) {
            risk.take_profit = [{
                gain_ticks: Number(tp.value),
                trim_percent: 100
            }];
        }

        if (sl && sl.value) {
            risk.stop_loss = {
                type: 'fixed',
                loss_ticks: Number(sl.value)
            };
        }

        if (trailEnabled?.checked && trailTicks?.value) {
            risk.trail = {
                activation_ticks: Number(trailTicks.value),
                offset_ticks: Number(trailTicks.value)
            };
        }

        if (breakEvenEnabled?.checked && breakEvenTrigger?.value) {
            risk.break_even = {
                activation_ticks: Number(breakEvenTrigger.value)
            };
        }

        return risk;
    }

    // ============================================================================
    // Pro Copy Trader — Leader/Follower Management
    // ============================================================================
    let currentLeaderId = null;

    // Initialize Pro Copy Trader on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Master copy trader toggle (admin only)
        const masterToggle = document.getElementById('masterCopyToggle');
        const masterStatus = document.getElementById('masterStatus');
        let masterToggleUserChanged = false; // so stale GET response doesn't overwrite after user click
        if (masterToggle) {
            // Load current state (don't overwrite checkbox if user already toggled)
            fetch('/api/admin/copy-trader-toggle')
                .then(r => r.json())
                .then(data => {
                    if (masterToggleUserChanged) return;
                    masterToggle.checked = data.enabled !== false;
                    if (masterStatus) {
                        masterStatus.textContent = masterToggle.checked ? 'Active' : 'Disabled';
                        masterStatus.style.color = masterToggle.checked ? '#22c55e' : '#ef4444';
                    }
                })
                .catch(() => {});
            // Toggle handler
            masterToggle.addEventListener('change', function() {
                masterToggleUserChanged = true;
                const enabled = masterToggle.checked;
                fetch('/api/admin/copy-trader-toggle', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({enabled: enabled})
                })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        if (masterStatus) {
                            masterStatus.textContent = enabled ? 'Active' : 'Disabled';
                            masterStatus.style.color = enabled ? '#22c55e' : '#ef4444';
                        }
                    } else {
                        masterToggle.checked = !enabled;
                        if (masterStatus) {
                            masterStatus.textContent = masterToggle.checked ? 'Active' : 'Disabled';
                            masterStatus.style.color = masterToggle.checked ? '#22c55e' : '#ef4444';
                        }
                    }
                })
                .catch(() => {
                    masterToggle.checked = !enabled;
                    if (masterStatus) {
                        masterStatus.textContent = masterToggle.checked ? 'Active' : 'Disabled';
                        masterStatus.style.color = masterToggle.checked ? '#22c55e' : '#ef4444';
                    }
                });
            });
        }

        // Populate leader dropdown from existing accounts
        loadLeaderAccountOptions();

        // Load existing leader from DB (so currentLeaderId is set on page load)
        loadExistingLeader();

        // Set Leader button
        const setLeaderBtn = document.getElementById('setLeaderBtn');
        if (setLeaderBtn) {
            setLeaderBtn.addEventListener('click', setLeaderAccount);
        }

        // Add All Followers button
        const addAllBtn = document.getElementById('addAllFollowersBtn');
        if (addAllBtn) {
            addAllBtn.addEventListener('click', addAllFollowerAccounts);
        }

        // Refresh followers
        const refreshBtn = document.getElementById('refreshFollowersBtn');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', () => {
                if (currentLeaderId) loadFollowerAccounts(currentLeaderId);
            });
        }

        // Auto/Manual mode toggle
        const autoCopyToggle = document.getElementById('autoCopyMode');
        if (autoCopyToggle) {
            autoCopyToggle.addEventListener('change', function() {
                const manualLabel = document.getElementById('modeManualLabel');
                const autoLabel = document.getElementById('modeAutoLabel');
                if (this.checked) {
                    manualLabel?.classList.remove('active');
                    autoLabel?.classList.add('active');
                } else {
                    autoLabel?.classList.remove('active');
                    manualLabel?.classList.add('active');
                }
                toggleAutoCopyMode(this.checked);
            });
            // Set initial state
            document.getElementById('modeManualLabel')?.classList.add('active');
        }
    });

    async function loadLeaderAccountOptions() {
        const leaderSelect = document.getElementById('leaderAccountSelect');
        if (!leaderSelect) return;

        try {
            const response = await fetch('/api/accounts');
            const data = await response.json();

            if (!data.success || !data.accounts) return;

            leaderSelect.innerHTML = '<option value="">Select leader account...</option>';
            data.accounts.forEach(account => {
                if (!account.is_connected) return;
                const accountName = account.name || `Account ${account.id}`;
                (account.tradovate_accounts || []).forEach(sub => {
                    const option = document.createElement('option');
                    option.value = `${account.id}:${sub.id}`;
                    option.textContent = `${accountName} - ${sub.name || sub.id} (${sub.is_demo ? 'Demo' : 'Live'})`;
                    leaderSelect.appendChild(option);
                });
            });
        } catch (error) {
            console.error('Error loading leader options:', error);
        }
    }

    async function loadExistingLeader() {
        try {
            const response = await fetch('/api/copy-trader/leaders');
            const data = await response.json();
            if (data.success && data.leaders && data.leaders.length > 0) {
                const leader = data.leaders[0]; // Use first active leader
                currentLeaderId = leader.id;
                updateLeaderStatus('connected', `Leader: ${leader.label || leader.subaccount_id}`);
                loadFollowerAccounts(currentLeaderId);
                loadCopyTradeLog(currentLeaderId);
                console.log('Loaded existing leader:', currentLeaderId);
            }
        } catch (error) {
            console.error('Error loading existing leader:', error);
        }
    }

    async function setLeaderAccount() {
        const leaderSelect = document.getElementById('leaderAccountSelect');
        const val = leaderSelect?.value;
        if (!val) {
            showToast('Please select a leader account', 'error');
            return;
        }

        const [accountId, subaccountId] = val.split(':');
        const label = leaderSelect.options[leaderSelect.selectedIndex]?.textContent || '';

        try {
            const response = await fetch('/api/copy-trader/leaders', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    account_id: parseInt(accountId),
                    subaccount_id: subaccountId,
                    label: label
                })
            });
            const data = await response.json();
            if (data.success) {
                currentLeaderId = data.leader_id;
                showToast('Leader account set', 'success');
                updateLeaderStatus('connected', `Leader: ${label}`);
                loadFollowerAccounts(currentLeaderId);
                loadCopyTradeLog(currentLeaderId);
            } else {
                showToast(`Error: ${data.error || 'Failed to set leader'}`, 'error');
            }
        } catch (error) {
            console.error('Error setting leader:', error);
            showToast('Failed to set leader account', 'error');
        }
    }

    function updateLeaderStatus(state, text) {
        const statusEl = document.getElementById('leaderStatus');
        const dotEl = document.getElementById('leaderStatusDot');
        const textEl = document.getElementById('leaderStatusText');
        if (!statusEl) return;

        statusEl.style.display = 'flex';
        dotEl.className = `status-dot ${state}`;
        textEl.textContent = text;
    }

    async function loadFollowerAccounts(leaderId) {
        const container = document.getElementById('followerAccountsList');
        if (!container || !leaderId) return;

        try {
            const response = await fetch(`/api/copy-trader/followers/${leaderId}`);
            const data = await response.json();

            if (!data.success || !data.followers || data.followers.length === 0) {
                container.innerHTML = `
                    <div class="follower-placeholder">
                        <i class="material-icons">group_add</i>
                        <p>No followers yet. Click "Add All" to add your accounts.</p>
                    </div>
                `;
                return;
            }

            let rows = '';
            data.followers.forEach(f => {
                const enabledClass = f.is_enabled ? '' : ' disabled';
                rows += `
                    <tr class="follower-row${enabledClass}" data-follower-id="${f.id}" data-subaccount-id="${f.subaccount_id}" data-account-sub="${f.account_id}:${f.subaccount_id}">
                        <td>
                            <label class="copy-toggle" style="margin:0">
                                <input type="checkbox" class="follower-enable-toggle"
                                       data-id="${f.id}" ${f.is_enabled ? 'checked' : ''}>
                                <span class="toggle-slider" style="width:32px;height:18px"></span>
                            </label>
                        </td>
                        <td>
                            <span class="follower-name">${f.label || f.subaccount_id}</span><br>
                            <span class="follower-sub">${f.account_id}:${f.subaccount_id}</span>
                        </td>
                        <td class="follower-pos-cell"><span class="position-badge flat" style="font-size:0.7rem">FLAT</span></td>
                        <td class="follower-pnl-cell col-pnl">--</td>
                        <td>
                            <input type="number" class="follower-mult-input"
                                   data-id="${f.id}" value="${f.multiplier || 1}"
                                   min="0.1" max="100" step="0.1">
                        </td>
                        <td>
                            <button type="button" class="btn-flatten" data-account="${f.account_id}:${f.subaccount_id}">Flatten</button>
                        </td>
                    </tr>
                `;
            });

            container.innerHTML = `
                <table class="followers-table">
                    <thead>
                        <tr>
                            <th style="width:42px">ON</th>
                            <th>Account</th>
                            <th>Position</th>
                            <th class="col-pnl">P&amp;L</th>
                            <th style="width:60px">Mult</th>
                            <th style="width:70px">Actions</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            `;

            // Wire up enable toggles
            container.querySelectorAll('.follower-enable-toggle').forEach(toggle => {
                toggle.addEventListener('change', function() {
                    updateFollowerSetting(this.dataset.id, { is_enabled: this.checked });
                    this.closest('.follower-row')?.classList.toggle('disabled', !this.checked);
                });
            });

            // Wire up multiplier inputs (save on change)
            container.querySelectorAll('.follower-mult-input').forEach(input => {
                input.addEventListener('change', function() {
                    updateFollowerSetting(this.dataset.id, { multiplier: parseFloat(this.value) || 1.0 });
                });
            });
        } catch (error) {
            console.error('Error loading followers:', error);
            container.innerHTML = '<div class="follower-placeholder"><p>Error loading followers</p></div>';
        }
    }

    async function addAllFollowerAccounts() {
        if (!currentLeaderId) {
            showToast('Set a leader account first', 'error');
            return;
        }

        const leaderSelect = document.getElementById('leaderAccountSelect');
        const leaderVal = leaderSelect?.value;

        try {
            const response = await fetch('/api/accounts');
            const data = await response.json();
            if (!data.success) return;

            let added = 0;
            for (const account of (data.accounts || [])) {
                if (!account.is_connected) continue;
                for (const sub of (account.tradovate_accounts || [])) {
                    const val = `${account.id}:${sub.id}`;
                    if (val === leaderVal) continue; // Skip leader account

                    const label = `${account.name || 'Account'} - ${sub.name || sub.id} (${sub.is_demo ? 'Demo' : 'Live'})`;
                    // API call placeholder — will be wired in Step 5
                    try {
                        const resp = await fetch(`/api/copy-trader/followers/${currentLeaderId}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                account_id: account.id,
                                subaccount_id: String(sub.id),
                                label: label,
                                multiplier: 1.0
                            })
                        });
                        const result = await resp.json();
                        if (result.success) added++;
                    } catch (e) { /* individual failure OK */ }
                }
            }

            showToast(`Added ${added} follower account(s)`, 'success');
            loadFollowerAccounts(currentLeaderId);
        } catch (error) {
            console.error('Error adding followers:', error);
            showToast('Failed to add followers', 'error');
        }
    }

    async function updateFollowerSetting(followerId, settings) {
        try {
            const response = await fetch(`/api/copy-trader/followers/${followerId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settings)
            });
            const data = await response.json();
            if (!data.success) {
                showToast('Failed to update follower setting', 'error');
            }
        } catch (error) {
            console.error('Error updating follower:', error);
        }
    }

    async function toggleAutoCopyMode(enabled) {
        if (!currentLeaderId) {
            showToast('Set a leader account first', 'error');
            const toggle = document.getElementById('autoCopyMode');
            if (toggle) toggle.checked = false;
            return;
        }

        try {
            const response = await fetch('/api/copy-trader/auto-mode', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    leader_id: currentLeaderId,
                    enabled: enabled
                })
            });
            const data = await response.json();
            if (data.success) {
                showToast(enabled ? 'Auto copy mode enabled' : 'Auto copy mode disabled', 'success');
                updateLeaderStatus(
                    enabled ? 'connecting' : 'connected',
                    enabled ? 'Connecting to leader WebSocket...' : 'Manual mode active'
                );
                // Start/stop position polling and log refresh
                if (enabled) {
                    startPositionPolling();
                    startLogRefresh();
                } else {
                    stopPositionPolling();
                    stopLogRefresh();
                }
            } else {
                showToast(`Error: ${data.error || 'Failed to toggle mode'}`, 'error');
            }
        } catch (error) {
            console.error('Error toggling auto mode:', error);
            showToast('Failed to toggle auto copy mode', 'error');
        }
    }

    async function loadCopyTradeLog(leaderId) {
        const container = document.getElementById('copyTradeLog');
        if (!container || !leaderId) return;

        try {
            const response = await fetch(`/api/copy-trader/leaders/${leaderId}/log`);
            const data = await response.json();

            // Update stats bar from data.stats (returned but previously ignored)
            if (data.stats) {
                const s = data.stats;
                const totalEl = document.getElementById('statTotalCopies');
                const rateEl = document.getElementById('statSuccessRate');
                const latEl = document.getElementById('statAvgLatency');
                if (totalEl) totalEl.textContent = s.total_copies || 0;
                if (rateEl) {
                    if (s.total_copies > 0) {
                        rateEl.textContent = Math.round((s.successful / s.total_copies) * 100) + '%';
                    } else {
                        rateEl.textContent = 'N/A';
                    }
                }
                if (latEl) latEl.textContent = s.avg_latency_ms ? (s.avg_latency_ms + 'ms') : '--';
            }

            // Update log count badge
            const countBadge = document.getElementById('logCountBadge');
            const logCount = (data.log && data.log.length) || 0;
            if (countBadge) countBadge.textContent = logCount + ' trade' + (logCount !== 1 ? 's' : '');

            if (!data.success || !data.log || data.log.length === 0) {
                container.innerHTML = `
                    <div class="log-placeholder">
                        <i class="material-icons">history</i>
                        <p>No copy trades yet</p>
                    </div>
                `;
                return;
            }

            let rows = '';
            data.log.forEach(entry => {
                const rawSide = entry.side || '';
                const sideClass = rawSide.toLowerCase().includes('buy') ? 'buy' : 'sell';
                const time = new Date(entry.created_at).toLocaleTimeString();
                const latency = entry.latency_ms || '--';
                const errorRow = entry.error_message
                    ? `<tr><td colspan="7" style="color:#ef4444;font-size:0.7rem;padding:2px 0.6rem;opacity:0.8">${entry.error_message.substring(0, 120)}</td></tr>`
                    : '';
                rows += `
                    <tr>
                        <td>${time}</td>
                        <td><span class="log-symbol">${entry.symbol}</span></td>
                        <td><span class="log-side ${sideClass}">${rawSide}</span></td>
                        <td>x${entry.follower_quantity}</td>
                        <td>${entry.follower_label || 'Follower'}</td>
                        <td><span class="log-status-badge ${entry.status}">${entry.status}</span></td>
                        <td class="col-latency">${latency}${typeof latency === 'number' ? 'ms' : ''}</td>
                    </tr>
                    ${errorRow}
                `;
            });

            container.innerHTML = `
                <table class="copy-log-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Symbol</th>
                            <th>Side</th>
                            <th>Qty</th>
                            <th>Follower</th>
                            <th>Status</th>
                            <th class="col-latency">Latency</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            `;
        } catch (error) {
            console.error('Error loading copy log:', error);
        }
    }

    // Log auto-refresh (10s interval when auto-copy active)
    let _logRefreshInterval = null;

    function startLogRefresh() {
        stopLogRefresh();
        if (currentLeaderId) {
            _logRefreshInterval = setInterval(() => loadCopyTradeLog(currentLeaderId), 10000);
        }
    }

    function stopLogRefresh() {
        if (_logRefreshInterval) {
            clearInterval(_logRefreshInterval);
            _logRefreshInterval = null;
        }
    }

    // Poll leader position state every 3 seconds when auto-copy is active
    let _leaderPositionInterval = null;
    let _lastLeaderPositions = {};

    async function pollLeaderPosition() {
        if (!currentLeaderId) return;
        try {
            const response = await fetch(`/api/copy-trader/leader-position/${currentLeaderId}`);
            const data = await response.json();
            if (!data.success) return;

            const badge = document.getElementById('leaderPositionBadge');
            if (!badge) return;

            const positions = data.positions || {};
            _lastLeaderPositions = positions;
            const symbols = Object.keys(positions);

            if (symbols.length === 0) {
                badge.className = 'position-badge flat';
                badge.textContent = 'FLAT';
            } else {
                const parts = symbols.map(sym => {
                    const p = positions[sym];
                    return `${p.side === 'Long' ? '+' : '-'}${p.qty} ${sym}`;
                });
                const side = positions[symbols[0]].side;
                badge.className = `position-badge ${side.toLowerCase()}`;
                badge.textContent = parts.join(', ');
            }

            // Update WS connection status too
            if (data.connected) {
                updateLeaderStatus('connected', 'Auto-copy active');
            }
        } catch (error) {
            console.error('Error polling leader position:', error);
        }
    }

    function startPositionPolling() {
        if (_leaderPositionInterval) clearInterval(_leaderPositionInterval);
        pollLeaderPosition();
        _leaderPositionInterval = setInterval(pollLeaderPosition, 3000);
        startCopyTraderStatusPolling();
    }

    function stopPositionPolling() {
        if (_leaderPositionInterval) {
            clearInterval(_leaderPositionInterval);
            _leaderPositionInterval = null;
        }
        const badge = document.getElementById('leaderPositionBadge');
        if (badge) {
            badge.className = 'position-badge flat';
            badge.textContent = 'FLAT';
        }
        stopCopyTraderStatusPolling();
    }

    // ============================================================================
    // Live P&L Wiring — Update follower table from WebSocket pnlData
    // ============================================================================
    function updateFollowerPnlCells(pnlData) {
        if (!pnlData) return;
        const rows = document.querySelectorAll('.follower-row');
        rows.forEach(row => {
            const subId = row.dataset.subaccountId;
            if (!subId) return;

            const pnlCell = row.querySelector('.follower-pnl-cell');
            const posCell = row.querySelector('.follower-pos-cell');
            if (!pnlCell && !posCell) return;

            // Find matching account in pnlData by subaccount_id
            let matched = null;
            for (const [accId, acc] of Object.entries(pnlData)) {
                if (String(acc.subaccount_id) === String(subId) || String(accId) === String(subId)) {
                    matched = acc;
                    break;
                }
            }

            if (matched) {
                // Update P&L cell
                if (pnlCell) {
                    const openPnl = matched.open_pnl || 0;
                    const sign = openPnl >= 0 ? '+' : '';
                    const colorClass = openPnl >= 0 ? 'color:#10b981' : 'color:#f87171';
                    pnlCell.innerHTML = `<span style="${colorClass};font-weight:600">${sign}$${openPnl.toFixed(2)}</span>`;
                }
                // Update position badge
                if (posCell && matched.positions) {
                    const posArr = Array.isArray(matched.positions) ? matched.positions : [];
                    if (posArr.length === 0) {
                        posCell.innerHTML = '<span class="position-badge flat" style="font-size:0.7rem">FLAT</span>';
                    } else {
                        const p = posArr[0];
                        const side = (p.netPos || 0) > 0 ? 'long' : 'short';
                        const qty = Math.abs(p.netPos || 0);
                        posCell.innerHTML = `<span class="position-badge ${side}" style="font-size:0.7rem">${side.toUpperCase()} ${qty}</span>`;
                    }
                }
            } else {
                // No match — leave defaults
                if (pnlCell && pnlCell.textContent === '--') { /* keep default */ }
            }
        });
    }

    // ============================================================================
    // Copy Trader Status Polling — WS dot in stats bar
    // ============================================================================
    let _statusPollInterval = null;

    async function pollCopyTraderStatus() {
        try {
            const response = await fetch('/api/copy-trader/status');
            const data = await response.json();
            if (!data.success) return;

            const dot = document.getElementById('wsDot');
            const text = document.getElementById('wsStatusText');
            if (!dot || !text) return;

            if (data.ws_connected && data.ws_authenticated) {
                dot.className = 'stat-dot connected';
                text.textContent = 'Auto (WS)';
            } else if (data.ws_connected) {
                dot.className = 'stat-dot connecting';
                text.textContent = 'Connecting...';
            } else if (data.auto_mode_enabled) {
                dot.className = 'stat-dot disconnected';
                text.textContent = 'Disconnected';
            } else {
                dot.className = 'stat-dot';
                text.textContent = 'Manual';
            }
        } catch (error) {
            // Silently fail — status polling is informational
        }
    }

    function startCopyTraderStatusPolling() {
        stopCopyTraderStatusPolling();
        pollCopyTraderStatus();
        _statusPollInterval = setInterval(pollCopyTraderStatus, 5000);
    }

    function stopCopyTraderStatusPolling() {
        if (_statusPollInterval) {
            clearInterval(_statusPollInterval);
            _statusPollInterval = null;
        }
    }

    // ============================================================================
    // Flatten Button Handler — event delegation
    // ============================================================================
    document.addEventListener('click', function(e) {
        const btn = e.target.closest('.btn-flatten');
        if (!btn) return;

        const accountSub = btn.dataset.account;
        if (!accountSub) return;
        if (!confirm('Flatten all positions for this follower?')) return;

        // Find first symbol from leader positions, or default
        const symbols = Object.keys(_lastLeaderPositions);
        const symbol = symbols.length > 0 ? symbols[0] : null;

        if (!symbol) {
            showToast('No leader position to reference — cannot determine symbol', 'error');
            return;
        }

        btn.disabled = true;
        btn.textContent = '...';

        fetch('/api/manual-trade', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                account_subaccount: accountSub,
                symbol: symbol,
                side: 'Close',
                quantity: 1,
                leader_id: currentLeaderId || null
            })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                showToast('Flatten order sent', 'success');
            } else {
                showToast('Flatten failed: ' + (data.error || 'Unknown error'), 'error');
            }
        })
        .catch(() => showToast('Flatten request failed', 'error'))
        .finally(() => {
            btn.disabled = false;
            btn.textContent = 'Flatten';
        });
    });

</script>
<script>
    // ============================================================================
    // WebSocket Connection for Real-Time Position Updates (like Trade Manager)
    // ============================================================================
    console.log('🔌 WebSocket script block starting...');
    console.log('🔍 DEBUG: Script is executing!');
    console.log('🔍 DEBUG: Current time:', new Date().toISOString());
    let socket = null;
    let currentAccountId = null;

    // Store account PnL data globally for display
    let accountPnlData = {};
    
    // Current user ID for filtering accounts (passed from server)
    const CURRENT_USER_ID = {{ current_user_id|default('null') }};
    console.log('Current user ID:', CURRENT_USER_ID);

    function updatePositionsFromWebSocket(positions, pnlData) {
        const container = document.getElementById('positionsContainer');
        if (!container) return;

        // Update account PnL data if provided
        if (pnlData) {
            accountPnlData = pnlData;
        }

        if (!positions || positions.length === 0) {
            // Even with no positions, show account PnL summary if available
            let html = '';
            if (Object.keys(accountPnlData).length > 0) {
                html += buildAccountPnlSummary(accountPnlData);
            }
            html += `
                <div class="positions-placeholder">
                    <i class="material-icons">trending_flat</i>
                    <p>No open positions</p>
                </div>
            `;
            container.innerHTML = html;
            return;
        }

        // Build account PnL summary + positions table
        let tableHTML = '';
        
        // Add account PnL summary at the top
        if (Object.keys(accountPnlData).length > 0) {
            tableHTML += buildAccountPnlSummary(accountPnlData);
        }

        container.innerHTML = tableHTML;
    }

    function buildAccountPnlSummary(pnlData) {
        let html = '<div class="pnl-summary">';
        
        for (const [accId, acc] of Object.entries(pnlData)) {
            // Filter by user_id - ONLY show accounts owned by current user (no null pass-through)
            if (CURRENT_USER_ID !== null && acc.user_id !== CURRENT_USER_ID) {
                continue; // Skip accounts not owned by current user
            }
            const openPnl = acc.open_pnl || 0;
            const realizedPnl = acc.realized_pnl || 0;
            const netLiq = acc.net_liq || 0;
            const pnlClass = openPnl >= 0 ? 'positive' : 'negative';
            const pnlSign = openPnl >= 0 ? '+' : '';
            const isDemo = acc.is_demo ? '(Demo)' : '(Live)';
            
            html += `
                <div class="account-pnl-card">
                    <div class="account-header">
                        <span class="account-name">${acc.account_name || accId}</span>
                        <span class="account-type-badge ${acc.is_demo ? 'demo' : 'live'}">${isDemo}</span>
                    </div>
                    <div class="pnl-row">
                        <span class="pnl-label">Unrealized P&L:</span>
                        <span class="pnl-value ${pnlClass}">${pnlSign}$${openPnl.toFixed(2)}</span>
                    </div>
                    <div class="pnl-row">
                        <span class="pnl-label">Today's Realized:</span>
                        <span class="pnl-value ${realizedPnl >= 0 ? 'positive' : 'negative'}">${realizedPnl >= 0 ? '+' : ''}$${realizedPnl.toFixed(2)}</span>
                    </div>
                    <div class="pnl-row net-liq">
                        <span class="pnl-label">Net Liq:</span>
                        <span class="pnl-value">$${netLiq.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                    </div>
                </div>
            `;
        }
        
        html += '</div>';
        return html;
    }

    // ============================================================================
    // WebSocket Connection (Socket.IO already loaded above)
    // ============================================================================
    console.log('🔌 WebSocket script block executing...');
    console.log('Socket.IO available:', typeof io !== 'undefined');
    console.log('Document ready state:', document.readyState);
    
    // Function to connect WebSocket
    function connectWebSocket() {
        console.log('🔌 Attempting to connect WebSocket...');
        console.log('Socket.IO available:', typeof io !== 'undefined');
        
        if (typeof io === 'undefined') {
            console.error('❌ Socket.IO library not loaded! Retrying in 1 second...');
            const statusEl = document.getElementById('wsStatus');
            if (statusEl) {
                statusEl.textContent = 'Loading Socket.IO...';
                statusEl.className = 'badge badge-secondary';
            }
            setTimeout(connectWebSocket, 1000);
            return;
        }

        try {
            console.log('Creating Socket.IO connection to:', window.location.origin);
            // Connect to the same origin
            socket = io(window.location.origin, {
                transports: ['websocket', 'polling'],
                reconnection: true,
                reconnectionDelay: 1000,
                reconnectionAttempts: 5,
                timeout: 20000
            });
            
            console.log('✅ Socket object created:', socket);

            socket.on('connect', () => {
                console.log('✅ Connected to WebSocket - Manual Trader');
                console.log('Socket ID:', socket.id);
                const statusEl = document.getElementById('wsStatus');
                if (statusEl) {
                    statusEl.textContent = 'Connected';
                    statusEl.className = 'badge';
                }
            });

            socket.on('disconnect', (reason) => {
                console.log('❌ Disconnected from WebSocket. Reason:', reason);
                const statusEl = document.getElementById('wsStatus');
                if (statusEl) {
                    statusEl.textContent = 'Disconnected';
                    statusEl.className = 'badge badge-secondary';
                }
            });

            socket.on('connect_error', (error) => {
                console.error('❌ WebSocket connection error:', error);
                console.error('Error details:', error.message);
                const statusEl = document.getElementById('wsStatus');
                if (statusEl) {
                    statusEl.textContent = 'Connection Error';
                    statusEl.className = 'badge badge-secondary';
                }
            });

            socket.on('reconnect', (attemptNumber) => {
                console.log('🔄 Reconnected after', attemptNumber, 'attempts');
            });

            socket.on('reconnect_error', (error) => {
                console.error('❌ Reconnection error:', error);
            });

            // Real-time position updates (every second, like Trade Manager)
            socket.on('position_update', (data) => {
                console.log('📊 Position update received:', data);
                
                const positions = data.positions || [];
                const pnlData = data.pnl_data || {};
                
                // Always update with all positions and PnL data
                // The PnL data contains account-level unrealized/realized PnL from Tradovate
                console.log(`📊 Received ${positions.length} positions, ${Object.keys(pnlData).length} accounts`);
                
                // Update the display with positions and PnL data
                updatePositionsFromWebSocket(positions, pnlData);

                // Also update follower P&L cells in copy trader table
                if (typeof updateFollowerPnlCells === 'function') {
                    updateFollowerPnlCells(pnlData);
                }
            });

            // Trade executed - refresh positions
            socket.on('trade_executed', (data) => {
                console.log('💰 Trade executed:', data);
                // Positions will be updated via position_update event
            });

            // Test event to verify connection
            socket.on('status', (data) => {
                console.log('📡 Status update:', data);
            });

        } catch (error) {
            console.error('❌ Error creating WebSocket connection:', error);
            console.error('Error stack:', error.stack);
            const statusEl = document.getElementById('wsStatus');
            if (statusEl) {
                statusEl.textContent = 'Error: ' + error.message;
                statusEl.className = 'badge badge-secondary';
            }
        }
    }
    
    // Connect immediately - Socket.IO should be loaded in layout.html head
    console.log('📄 Connecting WebSocket immediately...');
    console.log('Window location:', window.location.href);
    console.log('Socket.IO type:', typeof io);
    console.log('Document ready state:', document.readyState);
    
    // Wait for DOM and Socket.IO to be ready
    function attemptConnection() {
        console.log('🔄 Attempting connection, io available:', typeof io !== 'undefined');
        console.log('Document ready:', document.readyState === 'complete');
        
        if (typeof io === 'undefined') {
            console.error('❌ Socket.IO not available!');
            console.error('This means Socket.IO script failed to load from /static/js/socket.io.min.js');
            const statusEl = document.getElementById('wsStatus');
            if (statusEl) {
                statusEl.textContent = 'Socket.IO not loaded';
                statusEl.className = 'badge badge-secondary';
            }
            // Retry after 2 seconds
            console.log('⏳ Retrying in 2 seconds...');
            setTimeout(attemptConnection, 2000);
            return;
        }
        
        if (document.readyState !== 'complete') {
            console.log('⏳ Waiting for DOM to be ready...');
            window.addEventListener('load', attemptConnection);
            return;
        }
        
        console.log('✅ Socket.IO is available, connecting NOW...');
        console.log('Calling connectWebSocket()...');
        try {
            connectWebSocket();
        } catch (error) {
            console.error('❌ Error calling connectWebSocket:', error);
            console.error('Stack:', error.stack);
        }
    }
    
    // Start connection attempt
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', attemptConnection);
    } else {
        // DOM already ready, try immediately
        attemptConnection();
    }
</script>
<style>
    .toast-container {
        position: fixed;
        top: 1.5rem;
        right: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        z-index: 1200;
    }
    .toast {
        background: rgba(15,23,42,0.95);
        border: 1px solid rgba(148,163,184,0.2);
        border-radius: 999px;
        padding: 0.65rem 1.1rem;
        font-size: 0.85rem;
        letter-spacing: 0.02em;
        box-shadow: 0 10px 20px rgba(2,6,23,0.45);
        transition: opacity 0.3s ease, transform 0.3s ease;
    }
    .toast.success { border-color: rgba(16,185,129,0.6); color: #bbf7d0; }
    .toast.error { border-color: rgba(248,113,113,0.6); color: #fecaca; }
    .toast.fade-out { opacity: 0; transform: translateY(-8px); }
</style>
{% endblock %}

