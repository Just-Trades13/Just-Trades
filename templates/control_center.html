{% extends "layout.html" %}
{% block title %}Control Center - Just.Trades.{% endblock %}
{% block page_title %}CONTROL CENTER{% endblock %}
{% block content %}
<div class="control-center">
    <section class="live-panels">
        <article class="live-trading">
            <header>
                <h2>Live Trading Panel</h2>
                <div class="panel-actions">
                    <button class="btn btn-danger" onclick="closeAllPositions()">Close All</button>
                    <button class="btn btn-warning" onclick="clearAllTrades()">Clear All</button>
                    <button class="btn btn-outline" onclick="toggleAllStrategies()">Disable All Strats</button>
                </div>
            </header>
            <table>
                <thead>
                    <tr>
                        <th>STRATEGY</th>
                        <th>ENABLES</th>
                        <th>PROFIT / LOSS</th>
                        <th>ACTIONS</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in live_rows %}
                    <tr>
                        <td><a href="/recorders/{{ row.id }}">{{ row.name }}</a></td>
                        <td class="toggle-cell">
                            <span>ALL / ALL</span>
                            <label class="switch">
                                <input type="checkbox" {% if row.enabled %}checked{% endif %}>
                                <span class="slider"></span>
                            </label>
                        </td>
                        <td class="pl-cell {% if row.pnl >= 0 %}positive{% else %}negative{% endif %}"> {{ row.pnl | round(2) }} </td>
                        <td class="action-cell">
                            <button class="btn btn-outline btn-small">Close</button>
                            <button class="btn btn-outline btn-small">Clear</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </article>

        <article class="autotrader-logs">
            <header>
                <div>
                    <h2>AutoTrader Logs</h2>
                    <p>Realtime feed of recorder events</p>
                </div>
                <span class="status-dot connected">Connected</span>
            </header>
            <div class="log-feed">
                {% for log in logs %}
                <div class="log-entry">
                    <span class="log-type {{ log.type }}">[{{ log.type | upper }}]</span>
                    <span class="log-content">{{ log.message }}</span>
                    <span class="log-time">{{ log.time }}</span>
                </div>
                {% endfor %}
            </div>
        </article>
    </section>
</div>
{% endblock %}
{% block styles %}
<style>
    .control-center { display: grid; gap: 1.5rem; }

    .live-panels { display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; }
    .live-trading { background: rgba(7,12,23,0.92); border-radius: 18px; border: 1px solid rgba(148,163,184,0.12); overflow: hidden; display: grid; }
    .live-trading header { background: rgba(15,23,42,0.75); padding: 1rem 1.25rem; display: flex; justify-content: space-between; align-items: center; gap: 1rem; }
    .live-trading h2 { margin: 0; font-size: 1.2rem; }
    .panel-actions { display: flex; gap: 0.75rem; flex-wrap: wrap; }
    .btn-danger { background: rgba(239,68,68,0.85); color: #0b1120; }
    .btn-warning { background: rgba(234,179,8,0.85); color: #0b1120; }
    .btn-outline { background: rgba(15,23,42,0.6); color: #e2e8f0; border: 1px solid rgba(148,163,184,0.2); }
    table { width: 100%; border-collapse: collapse; }
    thead th { text-align: left; padding: 0.85rem 1.25rem; text-transform: uppercase; letter-spacing: 0.08em; font-size: 0.75rem; color: #94a3b8; border-bottom: 1px solid rgba(148,163,184,0.12); }
    tbody td { padding: 1rem 1.25rem; border-bottom: 1px solid rgba(148,163,184,0.08); color: #e2e8f0; }
    tbody tr:last-child td { border-bottom: none; }
    .toggle-cell { display: flex; align-items: center; gap: 0.75rem; }
    .switch { position: relative; display: inline-block; width: 48px; height: 24px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; inset: 0; background: rgba(148,163,184,0.3); border-radius: 24px; transition: 0.2s; }
    .slider:before { content: ""; position: absolute; height: 18px; width: 18px; left: 4px; bottom: 3px; background: #0b1120; border-radius: 50%; transition: 0.2s; }
    .switch input:checked + .slider { background: rgba(16,185,129,0.7); }
    .switch input:checked + .slider:before { transform: translateX(22px); }
    .pl-cell { font-weight: 600; }
    .pl-cell.positive { color: #34d399; }
    .pl-cell.negative { color: #f87171; }
    .action-cell { display: flex; gap: 0.5rem; }
    .btn-small { padding: 0.45rem 0.85rem; font-size: 0.75rem; }

    .autotrader-logs { background: rgba(11,18,33,0.92); border-radius: 18px; border: 1px solid rgba(148,163,184,0.12); display: grid; grid-template-rows: auto 1fr; }
    .autotrader-logs header { padding: 1rem 1.25rem; display: flex; justify-content: space-between; align-items: center; }
    .autotrader-logs h2 { margin: 0; font-size: 1.2rem; }
    .autotrader-logs p { margin: 0; color: var(--text-muted); }
    .status-dot { font-size: 0.8rem; letter-spacing: 0.08em; text-transform: uppercase; padding: 0.3rem 0.75rem; border-radius: 999px; }
    .status-dot.connected { background: rgba(52,211,153,0.25); color: #bbf7d0; }
    .log-feed { padding: 0 1.25rem 1.25rem; overflow-y: auto; max-height: 480px; display: grid; gap: 0.75rem; }
    .log-entry { background: rgba(15,23,42,0.6); border: 1px solid rgba(59,130,246,0.2); border-radius: 12px; padding: 0.75rem; display: grid; gap: 0.35rem; font-size: 0.85rem; }
    .log-type { font-weight: 600; }
    .log-type.open { color: #34d399; }
    .log-type.close { color: #fb923c; }
    .log-content { color: #e2e8f0; }
    .log-time { color: var(--text-muted); font-size: 0.75rem; }

    @media (max-width: 1100px) {
        .live-panels { grid-template-columns: 1fr; }
    }
</style>
{% endblock %}
{% block scripts %}
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.log-feed').forEach(function(feed) {
            feed.scrollTop = feed.scrollHeight;
        });
        
        // Refresh stats periodically
        loadControlCenterStats();
        setInterval(loadControlCenterStats, 30000);  // Refresh every 30 seconds (trades are priority, PnL is secondary)
        
        // WebSocket connection for real-time updates (like Trade Manager)
        const socket = io();
        
        socket.on('connect', () => {
            console.log('Connected to WebSocket');
            const statusDot = document.querySelector('.status-dot');
            if (statusDot) {
                statusDot.textContent = 'Connected';
                statusDot.classList.add('connected');
            }
        });
        
        socket.on('disconnect', () => {
            console.log('Disconnected from WebSocket');
            const statusDot = document.querySelector('.status-dot');
            if (statusDot) {
                statusDot.textContent = 'Disconnected';
                statusDot.classList.remove('connected');
            }
        });
        
        // Signal received - update logs immediately
        socket.on('signal_received', (data) => {
            console.log('Signal received:', data);
            const tradeInfo = data.trade ? ` → ${data.trade.action.toUpperCase()} ${data.trade.side || ''}` : '';
            addLogEntry(
                data.action === 'BUY' ? 'open' : 'close',
                `${data.recorder_name}: ${data.action} ${data.ticker} @ ${data.price}${tradeInfo}`,
                data.timestamp
            );
            // Refresh stats to update PnL
            loadControlCenterStats();
        });
        
        // Trade executed
        socket.on('trade_executed', (data) => {
            console.log('Trade executed:', data);
            const pnlStr = data.pnl ? ` | PnL: $${data.pnl.toFixed(2)}` : '';
            addLogEntry('trade', `${data.recorder_name}: ${data.side} closed ${data.ticker}${pnlStr}`, data.timestamp);
            // Refresh stats to update PnL
            loadControlCenterStats();
        });
        
        // Legacy handlers
        socket.on('pnl_update', (data) => {
            loadControlCenterStats();
        });
        
        socket.on('strategy_pnl_update', (data) => {
            updateStrategyPnL(data.strategy_id, data.strategy_name, data.pnl);
        });
        
        async function loadControlCenterStats() {
            try {
                const response = await fetch('/api/control-center/stats');
                const data = await response.json();
                
                if (data.success && data.recorders) {
                    updateLiveTradingTable(data.recorders);
                }
            } catch (error) {
                console.error('Error loading control center stats:', error);
            }
        }
        
        function updateLiveTradingTable(recorders) {
            const tbody = document.querySelector('.live-trading tbody');
            if (!tbody) return;
            
            // Build new rows
            let html = '';
            recorders.forEach(recorder => {
                const pnlClass = recorder.pnl >= 0 ? 'positive' : 'negative';
                const pnlFormatted = recorder.pnl >= 0 ? `$${recorder.pnl.toFixed(2)}` : `-$${Math.abs(recorder.pnl).toFixed(2)}`;
                html += `
                    <tr data-recorder-id="${recorder.id}">
                        <td><a href="/recorders/${recorder.id}">${recorder.name}</a> <span style="color: #64748b; font-size: 0.8em;">${recorder.symbol}</span></td>
                        <td class="toggle-cell">
                            <span>${recorder.open_trades} open / ${recorder.closed_trades} closed</span>
                            <label class="switch">
                                <input type="checkbox" ${recorder.enabled ? 'checked' : ''} onchange="toggleRecorder(${recorder.id}, this.checked)">
                                <span class="slider"></span>
                            </label>
                        </td>
                        <td class="pl-cell ${pnlClass}">${pnlFormatted}</td>
                        <td class="action-cell">
                            <button class="btn btn-outline btn-small" onclick="closeRecorderPositions(${recorder.id})">Close</button>
                            <button class="btn btn-outline btn-small" onclick="viewRecorderDetails(${recorder.id})">View</button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html || '<tr><td colspan="4" style="text-align: center; padding: 2rem; color: #64748b;">No recorders found. <a href="/recorders/new">Create one</a></td></tr>';
        }
        
        function updateStrategyPnL(strategyId, strategyName, pnl) {
            const row = document.querySelector(`tr[data-recorder-id="${strategyId}"]`);
            if (row) {
                    const pnlCell = row.querySelector('.pl-cell');
                    if (pnlCell) {
                    const pnlFormatted = pnl >= 0 ? `$${pnl.toFixed(2)}` : `-$${Math.abs(pnl).toFixed(2)}`;
                    pnlCell.textContent = pnlFormatted;
                        pnlCell.className = `pl-cell ${pnl >= 0 ? 'positive' : 'negative'}`;
                    }
                }
        }
        
        function addLogEntry(type, message, time) {
            const logFeed = document.querySelector('.log-feed');
            if (logFeed) {
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                // Format time in Chicago timezone
                let timeStr;
                if (time) {
                    // Handle UTC timestamps from server
                    let utcStr = time;
                    if (!time.endsWith('Z') && !time.includes('+') && !time.includes('-', 10)) {
                        utcStr = time.replace(' ', 'T') + 'Z';
                    }
                    timeStr = new Date(utcStr).toLocaleTimeString('en-US', { timeZone: 'America/Chicago' });
                } else {
                    timeStr = new Date().toLocaleTimeString('en-US', { timeZone: 'America/Chicago' });
                }
                logEntry.innerHTML = `
                    <span class="log-type ${type}">[${type.toUpperCase()}]</span>
                    <span class="log-content">${message}</span>
                    <span class="log-time">${timeStr}</span>
                `;
                logFeed.insertBefore(logEntry, logFeed.firstChild);
                
                // Keep only last 50 entries
                while (logFeed.children.length > 50) {
                    logFeed.removeChild(logFeed.lastChild);
                }
            }
        }
    });
    
    // Global functions for button handlers
    async function toggleRecorder(recorderId, enabled) {
        try {
            const response = await fetch(`/api/recorders/${recorderId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ recording_enabled: enabled ? 1 : 0 })
            });
            const data = await response.json();
            if (!data.success) {
                console.error('Failed to toggle recorder:', data.error);
            }
        } catch (error) {
            console.error('Error toggling recorder:', error);
        }
    }
    
    async function closeAllPositions() {
        if (!confirm('⚠️ Close ALL open positions on ALL accounts for ALL strategies?\n\nThis will execute close orders on the broker.')) {
            return;
        }
        
        const btn = event.target;
        btn.disabled = true;
        btn.textContent = 'Closing...';
        
        try {
            const response = await fetch('/api/control-center/close-all', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            
            const data = await response.json();
            if (data.success) {
                alert(`✅ ${data.message}`);
                location.reload();
            } else {
                alert(`❌ Error: ${data.error || 'Unknown error'}`);
                btn.disabled = false;
                btn.textContent = 'Close All';
            }
        } catch (error) {
            console.error('Error closing positions:', error);
            alert('❌ Network error. Please try again.');
            btn.disabled = false;
            btn.textContent = 'Close All';
        }
    }
    
    async function clearAllTrades() {
        if (!confirm('⚠️ Clear ALL trade records from database?\n\nThis will DELETE all trade records but will NOT close broker positions.\n\nAre you sure?')) {
            return;
        }
        
        const btn = event.target;
        btn.disabled = true;
        btn.textContent = 'Clearing...';
        
        try {
            const response = await fetch('/api/control-center/clear-all', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            
            const data = await response.json();
            if (data.success) {
                alert(`✅ ${data.message}`);
                location.reload();
            } else {
                alert(`❌ Error: ${data.error || 'Unknown error'}`);
                btn.disabled = false;
                btn.textContent = 'Clear All';
            }
        } catch (error) {
            console.error('Error clearing trades:', error);
            alert('❌ Network error. Please try again.');
            btn.disabled = false;
            btn.textContent = 'Clear All';
        }
    }
    
    async function toggleAllStrategies() {
        // Get current state from first checkbox
        const firstCheckbox = document.querySelector('input[type="checkbox"]');
        const currentState = firstCheckbox ? firstCheckbox.checked : false;
        const newState = !currentState;
        
        try {
            const response = await fetch('/api/control-center/toggle-all', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ enabled: newState })
            });
            
            const data = await response.json();
            if (data.success) {
                location.reload();
            } else {
                alert(`❌ Error: ${data.error || 'Unknown error'}`);
            }
        } catch (error) {
            console.error('Error toggling strategies:', error);
            alert('❌ Network error. Please try again.');
        }
    }
    
    function closeRecorderPositions(recorderId) {
        // TODO: Implement close all positions for recorder
        console.log('Close positions for recorder:', recorderId);
        alert('Close positions feature coming soon');
    }
    
    function viewRecorderDetails(recorderId) {
        window.location.href = `/recorders/${recorderId}`;
    }
</script>
{% endblock %}
