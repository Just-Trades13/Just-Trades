{% extends "layout.html" %}
{% block title %}My Traders - Just.Trades.{% endblock %}
{% block page_title %}MY TRADERS{% endblock %}
{% block content %}
<div class="traders-wrapper">
    {% if mode == 'list' %}
    <section class="list-header">
        <input type="text" placeholder="Search strategy..." id="searchInput" onkeyup="applyFilters()">
        <div class="filter-controls">
            <select id="filterEnv" onchange="applyFilters()">
                <option value="all">All Environments</option>
                <option value="demo">Demo Only</option>
                <option value="live">Live Only</option>
            </select>
            <select id="filterStatus" onchange="applyFilters()">
                <option value="all">All Status</option>
                <option value="enabled">Enabled Only</option>
                <option value="paused">Paused Only</option>
            </select>
            <select id="sortBy" onchange="applyFilters()">
                <option value="name">Sort: Name A-Z</option>
                <option value="name-desc">Sort: Name Z-A</option>
                <option value="accounts">Sort: Most Accounts</option>
                <option value="active">Sort: Most Active</option>
            </select>
        </div>
        <a class="btn btn-primary" href="/traders/new">Create Trader</a>
    </section>

    <div class="strategies-container" id="strategiesContainer">
        {% for strategy in strategies %}
        <div class="strategy-card" data-strategy-name="{{ strategy.recorder_name }}" data-total-accounts="{{ strategy.total_accounts }}" data-live-accounts="{{ strategy.live_accounts }}">
            <div class="strategy-header">
                <div class="strategy-info">
                    <h3 class="strategy-name"><span class="material-icons">show_chart</span>{{ strategy.recorder_name }}</h3>
                    <div class="strategy-meta">
                        <span class="account-count">{{ strategy.total_accounts }} account{{ 's' if strategy.total_accounts != 1 else '' }}</span>
                        <span class="active-pill {{ 'active-pill-good' if strategy.live_accounts == strategy.total_accounts else ('active-pill-warn' if strategy.live_accounts > 0 else 'active-pill-off') }}">{{ strategy.live_accounts }}/{{ strategy.total_accounts }} active</span>
                    </div>
                </div>
                <div class="strategy-actions">
                    <button class="action-btn bulk-toggle" onclick="bulkToggleStrategy({{ strategy.recorder_id }}, this)" title="Toggle all accounts">
                        <span class="material-icons">power_settings_new</span>
                    </button>
                    <button class="action-btn bulk-delete" onclick="bulkDeleteStrategy('{{ strategy.recorder_name }}', this)" title="Delete all accounts">
                        <span class="material-icons">delete_sweep</span>
                    </button>
                    <a href="/recorders/{{ strategy.recorder_id }}" class="action-btn" title="Edit Strategy Settings">
                        <span class="material-icons">settings</span>
                    </a>
                    <button class="action-btn toggle-expand" onclick="toggleStrategyExpand(this)" title="Expand/Collapse">
                        <span class="material-icons">expand_more</span>
                    </button>
                </div>
            </div>
            <div class="strategy-accounts">
                <table class="accounts-table">
                    <thead>
                        <tr>
                            <th>ACCOUNT</th>
                            <th>ENV</th>
                            <th>STATUS</th>
                            <th>ACTIONS</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for account in strategy.accounts %}
                        <tr data-trader-id="{{ account.trader_id }}">
                            <td class="account-name-cell">{{ account.account_name }}</td>
                            <td>
                                <span class="env-badge {{ 'env-demo' if account.is_demo else 'env-live' }}">
                                    {{ account.env_label }}
                                </span>
                            </td>
                            <td>
                                <span class="status-badge {{ 'status-live' if account.enabled else 'status-paused' }}">
                                    {{ 'LIVE' if account.enabled else 'PAUSED' }}
                                </span>
                            </td>
                            <td class="actions">
                                <a href="/traders/{{ account.trader_id }}" class="action-btn action-btn-edit" title="Edit Trader">
                                    <span class="material-icons">edit</span>
                                </a>
                                <button class="action-btn action-btn-toggle" onclick="toggleTrader({{ account.trader_id }}, {{ 0 if account.enabled else 1 }})" title="{{ 'Pause' if account.enabled else 'Enable' }}">
                                    <span class="material-icons">{{ 'pause' if account.enabled else 'play_arrow' }}</span>
                                </button>
                                <button class="action-btn action-btn-delete" onclick="deleteTrader({{ account.trader_id }}, '{{ strategy.recorder_name }}')" title="Remove Account">
                                    <span class="material-icons">delete</span>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endfor %}

        {% if not strategies %}
        <div class="empty-state-card">
            <span class="material-icons">add_circle_outline</span>
            <h3>No traders yet</h3>
            <p>Click "Create Trader" to link a strategy to your broker accounts.</p>
            <a class="btn btn-primary" href="/traders/new">Create Trader</a>
        </div>
        {% endif %}
    </div>
    {% elif mode == 'edit' %}
    <!-- Edit Trader Form -->
    <form id="traderForm" data-trader-id="{{ trader.id }}">
    <input type="hidden" id="editTraderId" value="{{ trader.id }}">
    <input type="hidden" id="recorderSelect" name="recorder_id" value="{{ trader.recorder_id }}">
    <section class="builder-header">
        <div>
            <h1>{{ header_title }}</h1>
            <span class="chip {{ 'chip-live' if trader.enabled else 'chip-paused' }}">{{ 'LIVE' if trader.enabled else 'PAUSED' }}</span>
            <p>Edit your trader settings. Adjust account routing and risk settings below.</p>
        </div>
        <div class="header-actions">
            <button type="submit" class="btn btn-primary" id="createTraderBtn">{{ header_cta }}</button>
            <button type="button" class="btn {{ 'btn-warning' if trader.enabled else 'btn-success' }}" id="toggleTraderBtn" onclick="toggleTraderEdit({{ trader.id }}, {{ 0 if trader.enabled else 1 }})">
                {{ 'Pause Trading' if trader.enabled else 'Enable Trading' }}
            </button>
            <a class="btn btn-secondary" href="/traders">Back to List</a>
        </div>
    </section>

    <section class="builder-alert builder-alert--error" id="validationAlert" style="display: none;">
        <strong>âš  PLEASE FIX THE FOLLOWING ISSUES:</strong>
        <ul id="validationErrors">
        </ul>
    </section>

    <section class="builder-form">
        <!-- Strategy Name is LOCKED on edit - display as read-only -->
        <label class="form-field">
            <span>Strategy Name (Locked)</span>
            <div class="locked-field">
                <span class="material-icons">lock</span>
                <span class="locked-value">{{ trader.recorder_name }}</span>
                <a href="/my-recorders" class="edit-recorder-link">Edit Recorder â†’</a>
            </div>
        </label>
        <label class="form-field">
            <span>Strategy Type</span>
            <div class="select-shell">
                <select id="strategyType" name="strategy_type" disabled>
                    <option value="Futures" {% if trader.strategy_type == 'Futures' %}selected{% endif %}>Futures</option>
                    <option value="Stock" {% if trader.strategy_type == 'Stock' %}selected{% endif %}>Stock</option>
                    <option value="Crypto" {% if trader.strategy_type == 'Crypto' %}selected{% endif %}>Crypto</option>
                </select>
                <span class="material-icons">expand_more</span>
            </div>
        </label>

        <section class="card-panel" data-panel>
            <header>
                <button class="panel-toggle" type="button"><span class="material-icons">remove</span> Hide Account Routing (Required)</button>
                <a class="panel-help" href="#">Help</a>
            </header>
            <div class="panel-body">
                <table class="account-routing">
                    <thead>
                        <tr>
                            <th>ACCOUNT</th>
                            <th>ENABLE</th>
                            <th>MAX CONS</th>
                            <th>CUSTOM TICKER</th>
                            <th>MULTIPLIER</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for account in accounts %}
                        <tr data-account-id="{{ account.id }}" data-account-name="{{ account.name }}" data-subaccount-id="{{ account.subaccount_id }}" data-subaccount-name="{{ account.name }}" data-is-demo="{{ account.is_demo|lower }}">
                            <td>{{ account.display_name }}</td>
                            <td>
                                <label class="switch">
                                    <input type="checkbox" class="account-enable" name="account_{{ account.id }}_enabled" {% if account.is_selected %}checked{% endif %}>
                                    <span class="slider"></span>
                                </label>
                            </td>
                            <td><input type="number" value="{{ account.max_contracts or 0 }}" name="account_{{ account.id }}_max_cons" class="account-max-cons"></td>
                            <td><input type="text" placeholder="DISABLED" name="account_{{ account.id }}_ticker" class="account-ticker" value="{{ account.custom_ticker or '' }}"></td>
                            <td><input type="number" value="{{ account.multiplier if account.multiplier is defined and account.multiplier else 1 }}" name="account_{{ account.id }}_multiplier" class="account-multiplier" step="0.1" min="0.1"></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </section>

        <section class="card-panel" data-panel>
            <header>
                <button class="panel-toggle" type="button"><span class="material-icons">remove</span> Hide Positional Settings</button>
                <a class="panel-help" href="#">Help</a>
            </header>
            <div class="panel-body">
                <div class="form-two">
                    <label class="form-field">
                        <span>Initial Position Size</span>
                        <input type="number" id="initialPositionSize" name="initial_position_size" value="{{ trader.initial_position_size or 1 }}" min="1">
                    </label>
                    <label class="form-field">
                        <span>Add Position Size</span>
                        <input type="number" id="addPositionSize" name="add_position_size" value="{{ trader.add_position_size or 1 }}" min="1">
                    </label>
                </div>
            </div>
        </section>

        <section class="card-panel" data-panel>
            <header>
                <button class="panel-toggle" type="button"><span class="material-icons">remove</span> Hide Stop Loss / Take Profit Settings</button>
                <a class="panel-help" href="#">Help</a>
            </header>
            <div class="panel-body">
                <div class="form-two">
                    <label class="form-field">
                        <span>TP Units</span>
                        <div class="select-shell">
                            <select id="tpUnits" name="tp_units">
                                <option value="Ticks" {% if trader.tp_units == 'Ticks' %}selected{% endif %}>Ticks</option>
                                <option value="Points" {% if trader.tp_units == 'Points' %}selected{% endif %}>Points</option>
                            </select>
                            <span class="material-icons">expand_more</span>
                        </div>
                    </label>
                    <label class="form-field">
                        <span>Trim Units</span>
                        <div class="select-shell">
                            <select id="trimUnits" name="trim_units">
                                <option value="Contracts" {% if trader.trim_units == 'Contracts' %}selected{% endif %}>Contracts</option>
                                <option value="Percent" {% if trader.trim_units == 'Percent' %}selected{% endif %}>Percent</option>
                            </select>
                            <span class="material-icons">expand_more</span>
                        </div>
                    </label>
                </div>
                <div id="tpTargetsContainer">
                    <!-- TP targets will be dynamically loaded here -->
                </div>
                <button type="button" class="add-tp-btn" onclick="addTpTarget()">
                    <span class="material-icons">add</span> Add TP Target
                </button>
                <div class="separator"></div>
                <div class="toggle-row">
                    <span>Stop Loss</span>
                    <label class="switch">
                        <input type="checkbox" id="slEnabled" name="sl_enabled" {% if trader.sl_enabled %}checked{% endif %}>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="form-two">
                    <label class="form-field">
                        <span>Stop Loss Amount</span>
                        <input type="number" id="slAmount" name="sl_amount" value="{{ trader.sl_amount or 0 }}" min="0" step="0.25">
                    </label>
                    <label class="form-field">
                        <span>SL Units</span>
                        <div class="select-shell">
                            <select id="slUnits" name="sl_units">
                                <option value="Ticks" {% if trader.sl_units == 'Ticks' %}selected{% endif %}>Ticks</option>
                                <option value="Points" {% if trader.sl_units == 'Points' %}selected{% endif %}>Points</option>
                            </select>
                            <span class="material-icons">expand_more</span>
                        </div>
                    </label>
                </div>
                <label class="form-field">
                    <span>SL Type</span>
                    <div class="select-shell">
                        <select id="slType" name="sl_type" onchange="toggleTrailSettingsEdit()">
                            <option value="Fixed" {% if trader.sl_type == 'Fixed' %}selected{% endif %}>Fixed</option>
                            <option value="Trailing" {% if trader.sl_type == 'Trailing' or trader.sl_type == 'Trail' %}selected{% endif %}>Trailing</option>
                        </select>
                        <span class="material-icons">expand_more</span>
                    </div>
                </label>
                <!-- Trailing Stop Settings (shown when SL Type = Trail) -->
                <div id="trailSettingsEdit" class="form-two" style="display: {% if trader.sl_type == 'Trail' or trader.sl_type == 'Trailing' %}flex{% else %}none{% endif %};">
                    <label class="form-field">
                        <span>Trail Trigger (ticks)</span>
                        <input type="number" id="trailTrigger" name="trail_trigger" value="{{ trader.trail_trigger or 0 }}" min="0" step="1">
                        <small>0 = immediate, or start after X profit</small>
                    </label>
                    <label class="form-field">
                        <span>Trail Frequency (ticks)</span>
                        <input type="number" id="trailFreq" name="trail_freq" value="{{ trader.trail_freq or 0 }}" min="0" step="1">
                        <small>0 = every tick, or update every X ticks</small>
                    </label>
                </div>
                <div class="separator"></div>
                <div class="toggle-row">
                    <span>Auto Break-Even</span>
                    <label class="switch">
                        <input type="checkbox" id="breakEvenEnabled" name="break_even_enabled" {% if trader.break_even_enabled %}checked{% endif %}>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="form-two">
                    <label class="form-field">
                        <span>Break-Even Trigger (ticks)</span>
                        <input type="number" id="breakEvenTicks" name="break_even_ticks" value="{{ trader.break_even_ticks or 10 }}" min="1" step="1">
                        <small>Move SL after X ticks profit</small>
                    </label>
                    <label class="form-field">
                        <span>Break-Even Offset (ticks)</span>
                        <input type="number" id="breakEvenOffset" name="break_even_offset" value="{{ trader.break_even_offset or 0 }}" min="0" step="1">
                        <small>0 = true BE, or lock in X profit</small>
                    </label>
                </div>
                <div class="separator"></div>
                <div class="toggle-row">
                    <span>Averaging Down (DCA)</span>
                    <label class="switch">
                        <input type="checkbox" id="avgDownEnabled" name="avg_down_enabled" {% if trader.avg_down_enabled %}checked{% endif %}>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="form-two">
                    <label class="form-field">
                        <span>Average Down Amount (contracts)</span>
                        <input type="number" id="avgDownAmount" name="avg_down_amount" value="{{ trader.avg_down_amount or 1 }}" min="1">
                    </label>
                    <label class="form-field">
                        <span>Average Down Point (ticks against)</span>
                        <input type="number" id="avgDownPoint" name="avg_down_point" value="{{ trader.avg_down_point or 10 }}" min="0" step="0.25">
                    </label>
                </div>
                <label class="form-field">
                    <span>Avg Down Unit</span>
                    <div class="select-shell">
                        <select id="avgDownUnits" name="avg_down_units">
                            <option value="Ticks" {% if trader.avg_down_units == 'Ticks' %}selected{% endif %}>Ticks</option>
                            <option value="Points" {% if trader.avg_down_units == 'Points' %}selected{% endif %}>Points</option>
                        </select>
                        <span class="material-icons">expand_more</span>
                    </div>
                </label>
            </div>
        </section>

        <section class="card-panel" data-panel>
            <header>
                <button class="panel-toggle" type="button"><span class="material-icons">add</span> Show Filter Settings (Optional)</button>
                <a class="panel-help" href="#">Help</a>
            </header>
            <div class="panel-body collapsed-body">
                <div class="form-two" style="opacity: 0.45; pointer-events: none;">
                    <label class="form-field">
                        <span>Ticker <span style="font-size:0.7rem;color:#f59e0b;font-weight:600;">COMING SOON</span></span>
                        <div class="select-shell">
                            <select disabled>
                                <option>ALL</option>
                            </select>
                            <span class="material-icons">expand_more</span>
                        </div>
                    </label>
                    <label class="form-field">
                        <span>Timeframe <span style="font-size:0.7rem;color:#f59e0b;font-weight:600;">COMING SOON</span></span>
                        <div class="select-shell">
                            <select disabled>
                                <option>ALL</option>
                            </select>
                            <span class="material-icons">expand_more</span>
                        </div>
                    </label>
                </div>
                <div class="form-two" style="opacity: 0.45; pointer-events: none;">
                    <label class="form-field">
                        <span>Option Premium Filter <span style="font-size:0.7rem;color:#f59e0b;font-weight:600;">COMING SOON</span></span>
                        <input type="number" value="0" disabled>
                    </label>
                    <label class="form-field">
                        <span>Direction Filter <span style="font-size:0.7rem;color:#f59e0b;font-weight:600;">COMING SOON</span></span>
                        <div class="select-shell">
                            <select disabled>
                                <option>Select a strategy...</option>
                            </select>
                            <span class="material-icons">expand_more</span>
                        </div>
                    </label>
                </div>
                <div class="time-filters">
                    <div class="time-block" id="time_filter_1_block">
                        <div class="toggle-row" style="margin-bottom: 0.75rem;">
                            <h4 style="margin: 0;">Time Filter #1</h4>
                            <label class="switch">
                                <input type="checkbox" id="time_filter_1_enabled" {{ 'checked' if trader.time_filter_1_enabled else '' }}>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="time-grid" id="time_filter_1_fields">
                            <label class="form-field">
                                <span>Start #1</span>
                                <input type="text" id="timeFilter1Start" value="{{ trader.time_filter_1_start or '' }}" placeholder="e.g. 8:45 AM">
                            </label>
                            <label class="form-field">
                                <span>Stop #1</span>
                                <input type="text" id="timeFilter1Stop" value="{{ trader.time_filter_1_stop or '' }}" placeholder="e.g. 3:00 PM">
                            </label>
                        </div>
                    </div>
                    <div class="time-block" id="time_filter_2_block">
                        <div class="toggle-row" style="margin-bottom: 0.75rem;">
                            <h4 style="margin: 0;">Time Filter #2</h4>
                            <label class="switch">
                                <input type="checkbox" id="time_filter_2_enabled" {{ 'checked' if trader.time_filter_2_enabled else '' }}>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="time-grid" id="time_filter_2_fields">
                            <label class="form-field">
                                <span>Start #2</span>
                                <input type="text" id="timeFilter2Start" value="{{ trader.time_filter_2_start or '' }}" placeholder="e.g. 6:00 PM">
                            </label>
                            <label class="form-field">
                                <span>Stop #2</span>
                                <input type="text" id="timeFilter2Stop" value="{{ trader.time_filter_2_stop or '' }}" placeholder="e.g. 11:00 PM">
                            </label>
                        </div>
                    </div>
                </div>
                <small style="color: #64748b; margin-top: 0.5rem; display: block;">
                    <span class="material-icons" style="font-size: 0.9rem; vertical-align: middle;">info</span>
                    Set custom time filters for this trader. Leave empty to use no time filter.
                </small>
            </div>
        </section>

        <section class="card-panel collapsed" data-panel>
            <header>
                <button class="panel-toggle" type="button"><span class="material-icons">add</span> Show Execution Controls (Optional)</button>
                <a class="panel-help" href="#">Help</a>
            </header>
            <div class="panel-body">
                <div class="form-two">
                    <label class="form-field">
                        <span>Signal Cooldown (seconds)</span>
                        <input type="number" id="signalCooldown" name="signal_cooldown" value="{{ trader.signal_cooldown or 0 }}" min="0">
                        <small>0 = no cooldown (process all signals)</small>
                    </label>
                    <label class="form-field">
                        <span>Max Signals Per Session</span>
                        <input type="number" id="maxSignalsPerSession" name="max_signals_per_session" value="{{ trader.max_signals_per_session or 0 }}" min="0">
                        <small>0 = unlimited signals</small>
                    </label>
                </div>
                <div class="form-two">
                    <label class="form-field">
                        <span>Max Daily Loss ($)</span>
                        <input type="number" id="maxDailyLoss" name="max_daily_loss" value="{{ trader.max_daily_loss or 0 }}" step="0.01" min="0">
                        <small>0 = no limit</small>
                    </label>
                    <label class="form-field">
                        <span>Add Delay</span>
                        <input type="number" id="addDelay" name="add_delay" value="{{ trader.add_delay or 1 }}" min="1">
                        <small>Take every Nth signal (1 = all, 2 = every other, 3 = every 3rd)</small>
                    </label>
                </div>
                <div class="switch-row">
                    <label class="switch">
                        <input type="checkbox" id="autoFlatAfterCutoff" name="auto_flat_after_cutoff" {% if trader.auto_flat_after_cutoff %}checked{% endif %}>
                        <span class="slider"></span>
                    </label>
                    <div>
                        <h3>Enable Auto Flat After Cutoff</h3>
                        <p>Automatically close open positions and disable signals after the session end time.</p>
                    </div>
                </div>
            </div>
        </section>

        <section class="card-panel collapsed" data-panel>
            <header>
                <button class="panel-toggle" type="button"><span class="material-icons">add</span> Show Miscellaneous Settings</button>
                <a class="panel-help" href="#">Help</a>
            </header>
            <div class="panel-body">
                <div style="opacity: 0.45; pointer-events: none;">
                <label class="form-field">
                    <span>Nickname <span style="font-size:0.7rem;color:#f59e0b;font-weight:600;">COMING SOON</span></span>
                    <input type="text" placeholder="Example nickname" disabled>
                </label>
                <label class="form-field">
                    <span>Strategy Description <span style="font-size:0.7rem;color:#f59e0b;font-weight:600;">COMING SOON</span></span>
                    <textarea rows="3" placeholder="Optional. Max 200 characters." disabled></textarea>
                </label>
                <label class="form-field">
                    <span>Discord Channel <span style="font-size:0.7rem;color:#f59e0b;font-weight:600;">COMING SOON</span></span>
                    <input type="text" placeholder="#alerts-channel" disabled>
                </label>
                <div class="toggle-row">
                    <span>Private</span>
                    <label class="switch" title="When enabled, only you can see this strategy in the recorder dropdown">
                        <input type="checkbox" id="recorder_is_private" {{ 'checked' if recorder_is_private else '' }} {{ '' if is_recorder_owner or is_admin else 'disabled' }}>
                        <span class="slider"></span>
                    </label>
                </div>
                {% if is_admin %}
                <div style="margin-top:8px;">
                    <span style="font-size:0.85rem;color:#94a3b8;display:block;margin-bottom:6px;">Required Tier (Admin Only)</span>
                    <div style="display:flex;gap:0;border-radius:8px;overflow:hidden;border:1px solid #334155;">
                        <button type="button" class="tier-pill" data-tier="public" onclick="selectTier('public')" style="flex:1;padding:6px 12px;font-size:0.8rem;font-weight:600;border:none;cursor:pointer;transition:all 0.2s;background:{{ '#10b981' if recorder_required_tier == 'public' else '#1e293b' }};color:{{ '#fff' if recorder_required_tier == 'public' else '#64748b' }};">Public</button>
                        <button type="button" class="tier-pill" data-tier="premium" onclick="selectTier('premium')" style="flex:1;padding:6px 12px;font-size:0.8rem;font-weight:600;border:none;border-left:1px solid #334155;cursor:pointer;transition:all 0.2s;background:{{ '#f59e0b' if recorder_required_tier == 'premium' else '#1e293b' }};color:{{ '#fff' if recorder_required_tier == 'premium' else '#64748b' }};">Premium</button>
                        <button type="button" class="tier-pill" data-tier="elite" onclick="selectTier('elite')" style="flex:1;padding:6px 12px;font-size:0.8rem;font-weight:600;border:none;border-left:1px solid #334155;cursor:pointer;transition:all 0.2s;background:{{ '#8b5cf6' if recorder_required_tier == 'elite' else '#1e293b' }};color:{{ '#fff' if recorder_required_tier == 'elite' else '#64748b' }};">Elite</button>
                    </div>
                    <input type="hidden" id="required_tier" value="{{ recorder_required_tier or 'public' }}">
                </div>
                {% endif %}
                <div class="toggle-row" style="margin-top:8px;">
                    <span>Manual Strategy <span style="font-size:0.7rem;color:#f59e0b;font-weight:600;">COMING SOON</span></span>
                    <label class="switch">
                        <input type="checkbox" disabled>
                        <span class="slider"></span>
                    </label>
                </div>
                </div>
                <div class="toggle-row">
                    <span>Inverse Strat</span>
                    <label class="switch" title="When enabled, BUY signals become SELL and SELL signals become BUY">
                        <input type="checkbox" id="inverseSignals" name="inverse_signals" {% if recorder and recorder.inverse_signals %}checked{% endif %} onchange="saveInverseSignals()">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </section>
    </section>
    </form>

    <!-- Webhook Section (matching recorders page style) -->
    {% if recorder and recorder.webhook_token %}
    <section class="webhook-card">
        <header>
            <div>
                <h2>Strategy Webhook Details</h2>
                <p>Share the auto-generated webhook and alert templates with your signal source.</p>
            </div>
            <button class="btn btn-outline" type="button" onclick="toggleWebhookCard()">
                <span class="material-icons" id="webhook-toggle-icon">expand_more</span>
            </button>
        </header>
        <div class="webhook-body" id="webhook-body">
            <label class="form-field">
                <span>Webhook URL</span>
                <div class="copy-row">
                    <input type="text" id="webhookUrl" readonly value="https://www.justtrades.app/webhook/{{ recorder.webhook_token }}">
                    <button type="button" class="btn btn-primary btn-small" onclick="copyToClipboard('webhookUrl', this)">Copy</button>
                </div>
                <small>Paste this URL in TradingView Alert â†’ Webhook URL (check the webhook checkbox!)</small>
            </label>
            
            <div class="alert-section">
                <h3 class="section-title">ðŸ“ˆ For Indicator Alerts</h3>
                <p class="section-desc">Create separate alerts for BUY and SELL signals</p>
                
                <div class="alert-block buy-alert">
                    <h4>ðŸŸ¢ BUY Alert Message</h4>
                    <pre id="templateBuy">{
  "recorder": "{{ trader.recorder_name }}",
  "action": "buy",
  "ticker": "{% raw %}{{ticker}}{% endraw %}",
  "price": "{% raw %}{{close}}{% endraw %}"
}</pre>
                    <button type="button" class="btn btn-primary btn-small" onclick="copyToClipboard('templateBuy', this)">Copy BUY Message</button>
                </div>
                
                <div class="alert-block sell-alert">
                    <h4>ðŸ”´ SELL Alert Message</h4>
                    <pre id="templateSell">{
  "recorder": "{{ trader.recorder_name }}",
  "action": "sell",
  "ticker": "{% raw %}{{ticker}}{% endraw %}",
  "price": "{% raw %}{{close}}{% endraw %}"
}</pre>
                    <button type="button" class="btn btn-primary btn-small" onclick="copyToClipboard('templateSell', this)">Copy SELL Message</button>
                </div>
            </div>
            
            <div class="alert-section">
                <h3 class="section-title">ðŸ“Š For Pine Script Strategies</h3>
                <p class="section-desc">One alert handles both BUY and SELL automatically</p>
                
                <div class="alert-block strategy-alert">
                    <h4>Strategy Alert Message</h4>
                    <pre id="templateStrategy">{
  "recorder": "{{ trader.recorder_name }}",
  "action": "{% raw %}{{strategy.order.action}}{% endraw %}",
  "ticker": "{% raw %}{{ticker}}{% endraw %}",
  "price": "{% raw %}{{close}}{% endraw %}",
  "contracts": "{% raw %}{{strategy.order.contracts}}{% endraw %}",
  "position_size": "{% raw %}{{strategy.position_size}}{% endraw %}",
  "market_position": "{% raw %}{{strategy.market_position}}{% endraw %}"
}</pre>
                    <button type="button" class="btn btn-outline btn-small" onclick="copyToClipboard('templateStrategy', this)">Copy Strategy Message</button>
                    <small>TradingView auto-fills {% raw %}{{strategy.order.action}}{% endraw %} with "buy" or "sell"</small>
                </div>
            </div>
        </div>
    </section>
    {% endif %}

    <section class="danger-zone">
        <h3>Danger Zone</h3>
        <div class="danger-action">
            <div>
                <strong>Delete this trader</strong>
                <p>This will stop live trading for this recorder-account link. The recorder and recorded trades will NOT be affected.</p>
            </div>
            <button type="button" class="btn btn-danger" onclick="deleteTraderEdit({{ trader.id }}, '{{ trader.recorder_name }}')">Delete Trader</button>
        </div>
    </section>
    {% else %}
    <!-- Create New Trader Form -->
    <form id="traderForm">
    <section class="builder-header">
        <div>
            <h1>{{ header_title }}</h1>
            <span class="chip">TRADER</span>
            <p>Select a recorder (signal source) and customize settings for your accounts.</p>
        </div>
        <div class="header-actions">
            <button type="submit" class="btn btn-primary" id="createTraderBtn">{{ header_cta }}</button>
            <a class="link-button" href="/my-recorders">Manage Recorders</a>
        </div>
    </section>

    <section class="builder-alert builder-alert--info" id="recorderAlert" style="display: none;">
        <strong>âœ“ RECORDER LOADED:</strong>
        <span id="recorderAlertMessage">Settings auto-populated from recorder defaults. Customize as needed.</span>
    </section>

    <section class="builder-alert builder-alert--error" id="validationAlert" style="display: none;">
        <strong>âš  PLEASE FIX THE FOLLOWING ISSUES:</strong>
        <ul id="validationErrors">
        </ul>
    </section>

    <section class="builder-form">
        <!-- Recorder Selection (for webhook signal source) - Auto-populates settings -->
        <label class="form-field">
            <span>ðŸ“¡ Signal Source (Recorder)</span>
            <div class="select-shell">
                <select id="recorderSelect" name="recorder_id" required>
                    <option value="">Select a recorder to load defaults...</option>
                    {% for recorder in recorders %}
                    <option value="{{ recorder.id }}">{{ recorder.name }} ({{ recorder.strategy_type }})</option>
                    {% endfor %}
                </select>
                <span class="material-icons">expand_more</span>
            </div>
            <small style="color: #64748b;">Select a recorder to auto-fill its default settings below</small>
        </label>

        <label class="form-field">
            <span>Strategy Type</span>
            <div class="select-shell">
                <select id="strategyType" name="strategy_type">
                    <option value="Futures">Futures</option>
                    <option value="Stock">Stock</option>
                    <option value="Crypto">Crypto</option>
                </select>
                <span class="material-icons">expand_more</span>
            </div>
        </label>

        <section class="card-panel" data-panel>
            <header>
                <button class="panel-toggle" type="button"><span class="material-icons">remove</span> Hide Account Routing (Required)</button>
                <a class="panel-help" href="#">Help</a>
            </header>
            <div class="panel-body">
                <table class="account-routing">
                    <thead>
                        <tr>
                            <th>ACCOUNT</th>
                            <th>ENABLE</th>
                            <th>MAX CONS</th>
                            <th>CUSTOM TICKER</th>
                            <th>MULTIPLIER</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for account in accounts %}
                        <tr data-account-id="{{ account.id }}" data-account-name="{{ account.name }}" data-subaccount-id="{{ account.subaccount_id }}" data-subaccount-name="{{ account.name }}" data-is-demo="{{ account.is_demo|lower }}">
                            <td>{{ account.display_name }}</td>
                            <td>
                                <label class="switch">
                                    <input type="checkbox" class="account-enable" name="account_{{ account.id }}_enabled">
                                    <span class="slider"></span>
                                </label>
                            </td>
                            <td><input type="number" value="0" name="account_{{ account.id }}_max_cons" class="account-max-cons" id="maxCons_{{ account.id }}"></td>
                            <td><input type="text" placeholder="DISABLED" name="account_{{ account.id }}_ticker" class="account-ticker"></td>
                            <td><input type="number" value="{{ account.multiplier if account.multiplier is defined and account.multiplier else 1 }}" name="account_{{ account.id }}_multiplier" class="account-multiplier" step="0.1" min="0.1"></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </section>

        <section class="card-panel" data-panel>
            <header>
                <button class="panel-toggle" type="button"><span class="material-icons">remove</span> Hide Positional Settings</button>
                <a class="panel-help" href="#">Help</a>
            </header>
            <div class="panel-body">
                <div class="form-two">
                    <label class="form-field">
                        <span>Initial Position Size</span>
                        <input type="number" id="createInitialPositionSize" name="initial_position_size" value="1" min="1">
                    </label>
                    <label class="form-field">
                        <span>Add Position Size</span>
                        <input type="number" id="createAddPositionSize" name="add_position_size" value="1" min="1">
                    </label>
                </div>
            </div>
        </section>

        <section class="card-panel" data-panel>
            <header>
                <button class="panel-toggle" type="button"><span class="material-icons">add</span> Show Stop Loss / Take Profit Settings (Optional)</button>
                <a class="panel-help" href="#">Help</a>
            </header>
            <div class="panel-body collapsed-body">
                <div class="form-two">
                    <label class="form-field">
                        <span>TP Units</span>
                        <div class="select-shell">
                            <select id="createTpUnits" name="tp_units">
                                <option value="Ticks">Ticks</option>
                                <option value="Points">Points</option>
                            </select>
                            <span class="material-icons">expand_more</span>
                        </div>
                    </label>
                    <label class="form-field">
                        <span>Trim Units</span>
                        <div class="select-shell">
                            <select id="createTrimUnits" name="trim_units">
                                <option value="Contracts">Contracts</option>
                                <option value="Percent">Percent</option>
                            </select>
                            <span class="material-icons">expand_more</span>
                        </div>
                    </label>
                </div>
                <div class="tp-row">
                    <span class="tp-pill">TP #1</span>
                    <label class="form-field">
                        <span>TP Value</span>
                        <input type="number" id="createTpValue" name="tp_value" value="0" min="0">
                    </label>
                    <label class="form-field">
                        <span>Trim %</span>
                        <input type="number" id="createTpTrim" name="tp_trim" value="100" min="0" max="100">
                    </label>
                </div>
                <div class="separator"></div>
                <div class="toggle-row">
                    <span>Stop Loss</span>
                    <label class="switch">
                        <input type="checkbox" id="createSlEnabled" name="sl_enabled">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="form-two">
                    <label class="form-field">
                        <span>Stop Loss Amount</span>
                        <input type="number" id="createSlAmount" name="sl_amount" value="0" min="0" step="0.25">
                    </label>
                    <label class="form-field">
                        <span>SL Units</span>
                        <div class="select-shell">
                            <select id="createSlUnits" name="sl_units">
                                <option value="Ticks">Ticks</option>
                                <option value="Points">Points</option>
                            </select>
                            <span class="material-icons">expand_more</span>
                        </div>
                    </label>
                </div>
                <label class="form-field">
                    <span>SL Type</span>
                    <div class="select-shell">
                        <select id="createSlType" name="sl_type" onchange="toggleTrailSettingsCreate()">
                            <option value="Fixed">Fixed</option>
                            <option value="Trail">Trail</option>
                        </select>
                        <span class="material-icons">expand_more</span>
                    </div>
                </label>
                <!-- Trailing Stop Settings (shown when SL Type = Trail) -->
                <div id="trailSettingsCreate" class="form-two" style="display: none;">
                    <label class="form-field">
                        <span>Trail Trigger (ticks)</span>
                        <input type="number" id="createTrailTrigger" name="trail_trigger" value="0" min="0" step="1">
                        <small>0 = immediate, or start after X profit</small>
                    </label>
                    <label class="form-field">
                        <span>Trail Frequency (ticks)</span>
                        <input type="number" id="createTrailFreq" name="trail_freq" value="0" min="0" step="1">
                        <small>0 = every tick, or update every X ticks</small>
                    </label>
                </div>
                <div class="separator"></div>
                <div class="toggle-row">
                    <span>Auto Break-Even</span>
                    <label class="switch">
                        <input type="checkbox" id="createBreakEvenEnabled" name="break_even_enabled">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="form-two">
                    <label class="form-field">
                        <span>Break-Even Trigger (ticks)</span>
                        <input type="number" id="createBreakEvenTicks" name="break_even_ticks" value="10" min="1" step="1">
                        <small>Move SL after X ticks profit</small>
                    </label>
                    <label class="form-field">
                        <span>Break-Even Offset (ticks)</span>
                        <input type="number" id="createBreakEvenOffset" name="break_even_offset" value="0" min="0" step="1">
                        <small>0 = true BE, or lock in X profit</small>
                    </label>
                </div>
                <div class="separator"></div>
                <div class="toggle-row">
                    <span>Averaging Down (DCA)</span>
                    <label class="switch">
                        <input type="checkbox" id="createAvgDownEnabled" name="avg_down_enabled">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="form-two">
                    <label class="form-field">
                        <span>Average Down Amount (contracts)</span>
                        <input type="number" id="createAvgDownAmount" name="avg_down_amount" value="1" min="1">
                    </label>
                    <label class="form-field">
                        <span>Average Down Point (ticks against)</span>
                        <input type="number" id="createAvgDownPoint" name="avg_down_point" value="10" min="0" step="0.25">
                    </label>
                </div>
                <label class="form-field">
                    <span>Max Contracts</span>
                    <input type="number" id="createMaxContracts" name="max_contracts" value="0" min="0">
                    <small style="color: #64748b;">0 = unlimited</small>
                </label>
                <div class="tp-row">
                    <span class="tp-pill">TP #1</span>
                    <label class="form-field">
                        <span>TP Value</span>
                        <input type="number" value="0">
                    </label>
                    <label class="form-field">
                        <span>Trim %</span>
                        <input type="number" value="0">
                        <small>This TP is disabled.</small>
                    </label>
                    <button class="icon-btn" type="button"><span class="material-icons">delete</span></button>
                </div>
                <div class="separator"></div>
                <div class="toggle-row">
                    <span>Stop Loss</span>
                    <span class="tag tag-disabled">Disabled</span>
                </div>
                <div class="form-two">
                    <label class="form-field">
                        <span>Stop Loss Amount</span>
                        <input type="number" value="0">
                    </label>
                    <label class="form-field">
                        <span>SL Units</span>
                        <div class="select-shell">
                            <select>
                                <option>Ticks</option>
                                <option>Points</option>
                            </select>
                            <span class="material-icons">expand_more</span>
                        </div>
                    </label>
                </div>
                <label class="form-field">
                    <span>SL Type</span>
                    <div class="select-shell">
                        <select>
                            <option>Fixed</option>
                            <option>Trail</option>
                        </select>
                        <span class="material-icons">expand_more</span>
                    </div>
                </label>
                <div class="separator"></div>
                <div class="toggle-row">
                    <span>Averaging Down</span>
                    <span class="tag tag-disabled">Disabled</span>
                </div>
                <div class="form-two">
                    <label class="form-field">
                        <span>Average Down Amount</span>
                        <input type="number" value="1">
                    </label>
                    <label class="form-field">
                        <span>Average Down Point</span>
                        <input type="number" value="0">
                    </label>
                </div>
                <label class="form-field">
                    <span>Avg Down Unit</span>
                    <div class="select-shell">
                        <select>
                            <option>Ticks</option>
                            <option>Points</option>
                        </select>
                        <span class="material-icons">expand_more</span>
                    </div>
                </label>
            </div>
        </section>

        <section class="card-panel" data-panel>
            <header>
                <button class="panel-toggle" type="button"><span class="material-icons">add</span> Show Filter Settings (Optional)</button>
                <a class="panel-help" href="#">Help</a>
            </header>
            <div class="panel-body collapsed-body">
                <div class="form-two" style="opacity: 0.45; pointer-events: none;">
                    <label class="form-field">
                        <span>Ticker <span style="font-size:0.7rem;color:#f59e0b;font-weight:600;">COMING SOON</span></span>
                        <div class="select-shell">
                            <select disabled>
                                <option>ALL</option>
                            </select>
                            <span class="material-icons">expand_more</span>
                        </div>
                    </label>
                    <label class="form-field">
                        <span>Timeframe <span style="font-size:0.7rem;color:#f59e0b;font-weight:600;">COMING SOON</span></span>
                        <div class="select-shell">
                            <select disabled>
                                <option>ALL</option>
                            </select>
                            <span class="material-icons">expand_more</span>
                        </div>
                    </label>
                </div>
                <div class="form-two" style="opacity: 0.45; pointer-events: none;">
                    <label class="form-field">
                        <span>Option Premium Filter <span style="font-size:0.7rem;color:#f59e0b;font-weight:600;">COMING SOON</span></span>
                        <input type="number" value="0" disabled>
                    </label>
                    <label class="form-field">
                        <span>Direction Filter <span style="font-size:0.7rem;color:#f59e0b;font-weight:600;">COMING SOON</span></span>
                        <div class="select-shell">
                            <select disabled>
                                <option>Select a strategy...</option>
                            </select>
                            <span class="material-icons">expand_more</span>
                        </div>
                    </label>
                </div>
                <div class="time-filters">
                    <div class="time-block" id="new_time_filter_1_block">
                        <div class="toggle-row" style="margin-bottom: 0.75rem;">
                            <h4 style="margin: 0;">Time Filter #1</h4>
                            <label class="switch">
                                <input type="checkbox" id="new_time_filter_1_enabled">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="time-grid" id="new_time_filter_1_fields">
                            <label class="form-field">
                                <span>Start #1</span>
                                <input type="text" id="newTimeFilter1Start" placeholder="e.g. 8:45 AM">
                            </label>
                            <label class="form-field">
                                <span>Stop #1</span>
                                <input type="text" id="newTimeFilter1Stop" placeholder="e.g. 1:45 PM">
                            </label>
                        </div>
                    </div>
                    <div class="time-block" id="new_time_filter_2_block">
                        <div class="toggle-row" style="margin-bottom: 0.75rem;">
                            <h4 style="margin: 0;">Time Filter #2</h4>
                            <label class="switch">
                                <input type="checkbox" id="new_time_filter_2_enabled">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="time-grid" id="new_time_filter_2_fields">
                            <label class="form-field">
                                <span>Start #2</span>
                                <input type="text" id="newTimeFilter2Start" placeholder="e.g. 6:00 PM">
                            </label>
                            <label class="form-field">
                                <span>Stop #2</span>
                                <input type="text" id="newTimeFilter2Stop" placeholder="e.g. 11:00 PM">
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="card-panel collapsed" data-panel>
            <header>
                <button class="panel-toggle" type="button"><span class="material-icons">add</span> Show Execution Controls (Optional)</button>
                <a class="panel-help" href="#">Help</a>
            </header>
            <div class="panel-body">
                <div class="form-two">
                    <label class="form-field">
                        <span>Signal Cooldown (seconds)</span>
                        <input type="number" id="createSignalCooldown" name="signal_cooldown" value="0" min="0">
                        <small>0 = no cooldown (process all signals)</small>
                    </label>
                    <label class="form-field">
                        <span>Max Signals Per Session</span>
                        <input type="number" id="createMaxSignalsPerSession" name="max_signals_per_session" value="0" min="0">
                        <small>0 = unlimited signals</small>
                    </label>
                </div>
                <div class="form-two">
                    <label class="form-field">
                        <span>Max Daily Loss ($)</span>
                        <input type="number" id="createMaxDailyLoss" name="max_daily_loss" value="0" step="0.01" min="0">
                        <small>0 = no limit</small>
                    </label>
                    <label class="form-field">
                        <span>Add Delay</span>
                        <input type="number" id="createAddDelay" name="add_delay" value="1" min="1">
                        <small>Take every Nth signal (1 = all, 2 = every other, 3 = every 3rd)</small>
                    </label>
                </div>
                <div class="switch-row">
                    <label class="switch">
                        <input type="checkbox" id="createAutoFlatAfterCutoff" name="auto_flat_after_cutoff">
                        <span class="slider"></span>
                    </label>
                    <div>
                        <h3>Enable Auto Flat After Cutoff</h3>
                        <p>Automatically close open positions and disable signals after the session end time.</p>
                    </div>
                </div>
            </div>
        </section>

        <section class="card-panel collapsed" data-panel>
            <header>
                <button class="panel-toggle" type="button"><span class="material-icons">add</span> Show Miscellaneous Settings</button>
                <a class="panel-help" href="#">Help</a>
            </header>
            <div class="panel-body">
                <div style="opacity: 0.45; pointer-events: none;">
                <label class="form-field">
                    <span>Nickname <span style="font-size:0.7rem;color:#f59e0b;font-weight:600;">COMING SOON</span></span>
                    <input type="text" placeholder="Example nickname" disabled>
                </label>
                <label class="form-field">
                    <span>Strategy Description <span style="font-size:0.7rem;color:#f59e0b;font-weight:600;">COMING SOON</span></span>
                    <textarea rows="3" placeholder="Optional. Max 200 characters." disabled></textarea>
                </label>
                <label class="form-field">
                    <span>Discord Channel <span style="font-size:0.7rem;color:#f59e0b;font-weight:600;">COMING SOON</span></span>
                    <input type="text" placeholder="#alerts-channel" disabled>
                </label>
                <div class="toggle-row">
                    <span>Private <span style="font-size:0.7rem;color:#f59e0b;font-weight:600;">COMING SOON</span></span>
                    <label class="switch">
                        <input type="checkbox" checked disabled>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="toggle-row">
                    <span>Manual Strategy <span style="font-size:0.7rem;color:#f59e0b;font-weight:600;">COMING SOON</span></span>
                    <label class="switch">
                        <input type="checkbox" disabled>
                        <span class="slider"></span>
                    </label>
                </div>
                </div>
                <div class="toggle-row">
                    <span>Inverse Strat</span>
                    <label class="switch">
                        <input type="checkbox" id="createInverseSignals" name="inverse_signals">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </section>
    </section>
    </form>
    {% endif %}
</div>
{% endblock %}
{% block styles %}
<style>
    .traders-wrapper { display: grid; gap: 1.5rem; }
    .list-header { display: flex; align-items: center; gap: 1rem; background: rgba(11,18,33,0.9); border: 1px solid rgba(148,163,184,0.12); border-radius: 16px; padding: 1rem 1.25rem; flex-wrap: wrap; }
    .list-header input { background: rgba(15,23,42,0.55); border: 1px solid rgba(148,163,184,0.2); border-radius: 10px; color: #e2e8f0; padding: 0.65rem 0.85rem; flex: 1; min-width: 160px; }
    .filter-controls { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .filter-controls select { background: rgba(15,23,42,0.55); border: 1px solid rgba(148,163,184,0.2); border-radius: 10px; color: #e2e8f0; padding: 0.5rem 0.75rem; font-size: 0.8rem; cursor: pointer; -webkit-appearance: none; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%2394a3b8' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.6rem center; padding-right: 1.8rem; }
    .filter-controls select:hover { border-color: rgba(59,130,246,0.4); }
    .filter-controls select:focus { outline: none; border-color: rgba(59,130,246,0.5); box-shadow: 0 0 0 2px rgba(59,130,246,0.15); }
    .btn { border: none; border-radius: 12px; padding: 0.65rem 1.4rem; font-weight: 600; letter-spacing: 0.06em; text-transform: uppercase; cursor: pointer; }
    .btn-primary { background: linear-gradient(135deg, #60a5fa, #2563eb); color: #0b1120; box-shadow: inset 0 0 0 1px rgba(255,255,255,0.12); }
    .trader-table { width: 100%; border-collapse: collapse; background: rgba(7,12,23,0.92); border: 1px solid rgba(148,163,184,0.12); border-radius: 16px; overflow: hidden; }
    thead th { text-align: left; padding: 0.85rem 1rem; text-transform: uppercase; letter-spacing: 0.08em; font-size: 0.75rem; color: #94a3b8; border-bottom: 1px solid rgba(148,163,184,0.12); }
    tbody td { padding: 0.95rem 1rem; border-bottom: 1px solid rgba(148,163,184,0.08); color: #e2e8f0; }
    tbody tr:last-child td { border-bottom: none; }
    .actions { display: flex; gap: 0.75rem; }
    .actions a { color: rgba(148,163,184,0.8); text-decoration: none; }
    .actions a:hover { color: #60a5fa; }
    .strategy-link { color: #60a5fa; font-weight: 600; }
    .account-name { color: #94a3b8; font-size: 0.9rem; }
    .status-badge { padding: 0.25rem 0.75rem; border-radius: 999px; font-size: 0.7rem; font-weight: 600; letter-spacing: 0.08em; text-transform: uppercase; }
    .status-live { background: rgba(16, 185, 129, 0.2); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.4); }
    .status-paused { background: rgba(248, 172, 28, 0.15); color: #facc15; border: 1px solid rgba(248, 172, 28, 0.3); }
    .action-btn { background: rgba(15,23,42,0.6); border: 1px solid rgba(148,163,184,0.2); border-radius: 8px; color: #94a3b8; padding: 0.4rem; cursor: pointer; transition: all 0.2s ease; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; }
    .action-btn:hover { background: rgba(59, 130, 246, 0.2); color: #60a5fa; border-color: rgba(59, 130, 246, 0.4); }
    .action-btn-edit:hover { background: rgba(59, 130, 246, 0.2); color: #60a5fa; border-color: rgba(59, 130, 246, 0.4); }
    .action-btn-refresh:hover { background: rgba(168, 85, 247, 0.2); color: #a855f7; border-color: rgba(168, 85, 247, 0.4); }
    .action-btn-delete:hover { background: rgba(239, 68, 68, 0.2); color: #ef4444; border-color: rgba(239, 68, 68, 0.4); }
    .action-btn-toggle:hover { background: rgba(16, 185, 129, 0.2); color: #10b981; border-color: rgba(16, 185, 129, 0.4); }
    .action-btn.spinning .material-icons { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .empty-state { text-align: center; padding: 3rem !important; color: #64748b; font-style: italic; }

    /* Grouped Strategy Cards View */
    .strategies-container { display: flex; flex-direction: column; gap: 1rem; }
    .strategy-card { background: rgba(7,12,23,0.92); border: 1px solid rgba(148,163,184,0.12); border-left: 3px solid rgba(59,130,246,0.5); border-radius: 16px; overflow: hidden; transition: all 0.25s ease; }
    .strategy-card:hover { border-color: rgba(59,130,246,0.3); border-left-color: rgba(59,130,246,0.8); box-shadow: 0 4px 20px rgba(59,130,246,0.1); }
    .strategy-header { display: flex; justify-content: space-between; align-items: center; padding: 1.15rem 1.5rem; background: rgba(15,23,42,0.5); border-bottom: 1px solid rgba(148,163,184,0.08); }
    .strategy-info { display: flex; flex-direction: column; gap: 0.35rem; }
    .strategy-name { margin: 0; font-size: 1.15rem; color: #60a5fa; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; }
    .strategy-name .material-icons { font-size: 1.2rem; opacity: 0.7; }
    .strategy-meta { display: flex; gap: 0.75rem; font-size: 0.8rem; align-items: center; }
    .account-count { color: #94a3b8; }
    .active-pill { padding: 0.15rem 0.6rem; border-radius: 999px; font-size: 0.7rem; font-weight: 600; letter-spacing: 0.04em; }
    .active-pill-good { background: rgba(16,185,129,0.15); color: #10b981; border: 1px solid rgba(16,185,129,0.3); }
    .active-pill-warn { background: rgba(251,191,36,0.15); color: #fbbf24; border: 1px solid rgba(251,191,36,0.3); }
    .active-pill-off { background: rgba(100,116,139,0.15); color: #64748b; border: 1px solid rgba(100,116,139,0.3); }
    .strategy-actions { display: flex; gap: 0.5rem; }
    .bulk-toggle:hover { background: rgba(168,85,247,0.2); color: #a855f7; border-color: rgba(168,85,247,0.4); }
    .bulk-delete:hover { background: rgba(239,68,68,0.2); color: #ef4444; border-color: rgba(239,68,68,0.4); }
    .toggle-expand .material-icons { transition: transform 0.2s ease; }
    .strategy-card.collapsed .toggle-expand .material-icons { transform: rotate(-90deg); }
    .strategy-card.collapsed .strategy-accounts { display: none; }
    .strategy-accounts { padding: 0; }
    .accounts-table { width: 100%; border-collapse: collapse; }
    .accounts-table thead th { text-align: left; padding: 0.6rem 1rem; text-transform: uppercase; letter-spacing: 0.08em; font-size: 0.7rem; color: #64748b; background: rgba(15,23,42,0.3); border-bottom: 1px solid rgba(148,163,184,0.08); }
    .accounts-table tbody td { padding: 0.75rem 1rem; border-bottom: 1px solid rgba(148,163,184,0.06); color: #e2e8f0; }
    .accounts-table tbody tr:last-child td { border-bottom: none; }
    .accounts-table tbody tr:hover { background: rgba(59,130,246,0.05); }
    .account-name-cell { font-weight: 500; }
    .env-badge { padding: 0.2rem 0.5rem; border-radius: 999px; font-size: 0.65rem; font-weight: 600; letter-spacing: 0.06em; text-transform: uppercase; }
    .env-live { background: rgba(16, 185, 129, 0.15); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.3); }
    .env-demo { background: rgba(251, 146, 60, 0.15); color: #fb923c; border: 1px solid rgba(251, 146, 60, 0.3); }
    .empty-state-card { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 4rem 2rem; background: rgba(7,12,23,0.92); border: 1px dashed rgba(148,163,184,0.2); border-radius: 16px; text-align: center; }
    .empty-state-card .material-icons { font-size: 3rem; color: #64748b; margin-bottom: 1rem; }
    .empty-state-card h3 { margin: 0 0 0.5rem 0; color: #e2e8f0; }
    .empty-state-card p { margin: 0 0 1.5rem 0; color: #64748b; }

    /* Edit View Styles */
    .chip-live { background: rgba(16, 185, 129, 0.25); color: #10b981; }
    .chip-paused { background: rgba(248, 172, 28, 0.15); color: #facc15; }
    .locked-field { display: flex; align-items: center; gap: 0.75rem; background: rgba(15,23,42,0.55); border: 1px solid rgba(148,163,184,0.25); border-radius: 12px; padding: 0.75rem 1rem; }
    .locked-field .material-icons { color: #64748b; font-size: 1.1rem; }
    .locked-field .locked-value { color: #e2e8f0; font-size: 1rem; font-weight: 500; flex: 1; }
    .locked-field .edit-recorder-link { color: #60a5fa; font-size: 0.85rem; text-decoration: none; white-space: nowrap; }
    .locked-field .edit-recorder-link:hover { text-decoration: underline; }
    .btn-success { background: linear-gradient(135deg, #10b981, #059669); color: white; }
    .btn-warning { background: linear-gradient(135deg, #f59e0b, #d97706); color: #0b1120; }
    .btn-danger { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
    .btn-secondary { background: rgba(148,163,184,0.2); color: #e2e8f0; border: 1px solid rgba(148,163,184,0.3); }
    .trader-details-card { background: rgba(11,18,33,0.92); border: 1px solid rgba(59,130,246,0.25); border-radius: 16px; padding: 1.5rem; }
    .trader-details-card h3 { margin: 0 0 1.25rem 0; color: #e2e8f0; font-size: 1.1rem; }
    .details-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
    .detail-item { display: flex; flex-direction: column; gap: 0.25rem; }
    .detail-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.08em; color: #64748b; }
    .detail-value { font-size: 1rem; color: #e2e8f0; font-weight: 500; }
    .edit-note { display: flex; align-items: center; gap: 0.5rem; margin-top: 1.5rem; padding: 1rem; background: rgba(59, 130, 246, 0.1); border-radius: 10px; color: #94a3b8; font-size: 0.9rem; }
    .edit-note .material-icons { font-size: 1.1rem; color: #60a5fa; }
    .edit-note a { color: #60a5fa; }
    .danger-zone { background: rgba(239, 68, 68, 0.08); border: 1px solid rgba(239, 68, 68, 0.25); border-radius: 16px; padding: 1.5rem; margin-top: 1.5rem; }
    .danger-zone h3 { margin: 0 0 1rem 0; color: #fca5a5; font-size: 1rem; }
    .danger-action { display: flex; justify-content: space-between; align-items: center; gap: 1rem; }
    .danger-action p { margin: 0.25rem 0 0 0; color: #94a3b8; font-size: 0.85rem; }
    .pager { display: flex; align-items: center; gap: 0.75rem; justify-content: center; padding: 0.75rem; }
    .pager button { background: rgba(15,23,42,0.6); border: 1px solid rgba(148,163,184,0.2); border-radius: 10px; color: #cbd5f5; padding: 0.4rem 0.75rem; cursor: pointer; }
    .pager button:disabled { opacity: 0.4; cursor: not-allowed; }
    .page-pill { background: rgba(236,72,153,0.6); color: white; border-radius: 999px; padding: 0.4rem 0.75rem; font-weight: 600; }

    .builder-header { background: rgba(11,18,33,0.92); border-radius: 18px; border: 1px solid rgba(59,130,246,0.25); padding: 1.75rem; display: flex; justify-content: space-between; align-items: flex-start; gap: 1.5rem; }
    .builder-header h1 { margin: 0; font-size: 2rem; }
    .chip { padding: 0.25rem 0.75rem; border-radius: 999px; background: rgba(59,130,246,0.25); color: #bfdbfe; font-size: 0.75rem; letter-spacing: 0.1em; }
    .header-actions { display: flex; gap: 0.75rem; align-items: center; }
    .link-button { color: #60a5fa; text-decoration: none; font-weight: 600; }
    .builder-alert { border-radius: 14px; padding: 1rem 1.2rem; background: rgba(239,68,68,0.12); border: 1px solid rgba(239,68,68,0.4); color: #fca5a5; }
    .builder-alert--info { background: rgba(16, 185, 129, 0.12); border: 1px solid rgba(16, 185, 129, 0.4); color: #6ee7b7; }
    .builder-alert ul { margin: 0; padding-left: 1.25rem; }
    .builder-form { display: grid; gap: 1.5rem; }
    .form-field { display: grid; gap: 0.35rem; color: var(--text-muted); font-size: 0.8rem; letter-spacing: 0.08em; text-transform: uppercase; }
    input, select, textarea { background: rgba(15,23,42,0.55); border: 1px solid rgba(148,163,184,0.25); border-radius: 12px; color: #e2e8f0; padding: 0.6rem 0.75rem; font-size: 0.95rem; }
    textarea { resize: vertical; }
    .select-shell { position: relative; }
    .select-shell select { width: 100%; appearance: none; }
    .select-shell .material-icons { position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); font-size: 1rem; color: var(--text-muted); pointer-events: none; }

    .card-panel { background: rgba(8,12,24,0.92); border: 1px solid rgba(59,130,246,0.18); border-radius: 16px; overflow: hidden; }
    .card-panel header { background: rgba(37,99,235,0.3); padding: 0.75rem 1rem; display: flex; justify-content: space-between; align-items: center; }
    .panel-toggle { background: none; border: none; color: #e0ecff; display: inline-flex; align-items: center; gap: 0.6rem; font-weight: 600; letter-spacing: 0.05em; text-transform: uppercase; cursor: pointer; }
    .panel-toggle .material-icons { transition: transform 0.2s ease; }
    .panel-help { color: #93c5fd; text-decoration: none; font-size: 0.8rem; }
    .panel-body { padding: 1.2rem 1.4rem; display: block; }
    .card-panel.collapsed .panel-body { display: none; }
    .card-panel.collapsed .panel-toggle .material-icons { transform: rotate(0deg); }
    .form-two { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; }
    .account-routing { width: 100%; border-collapse: collapse; background: rgba(5,10,20,0.8); border-radius: 12px; overflow: hidden; }
    .account-routing thead th { text-align: left; padding: 0.75rem; font-size: 0.75rem; letter-spacing: 0.08em; text-transform: uppercase; color: #94a3b8; border-bottom: 1px solid rgba(148,163,184,0.12); }
    .account-routing tbody td { padding: 0.75rem; border-bottom: 1px solid rgba(148,163,184,0.08); }
    .account-routing tbody tr:last-child td { border-bottom: none; }
    .switch { position: relative; display: inline-block; width: 48px; height: 24px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; inset: 0; background: rgba(148,163,184,0.3); border-radius: 24px; transition: .2s; }
    .slider:before { content: ""; position: absolute; height: 18px; width: 18px; left: 4px; bottom: 3px; background: #0b1120; border-radius: 50%; transition: .2s; }
    .switch input:checked + .slider { background: rgba(16,185,129,0.7); }
    .switch input:checked + .slider:before { transform: translateX(22px); }
    .tp-row { display: grid; grid-template-columns: auto repeat(2, minmax(0,1fr)) auto; gap: 0.75rem; align-items: center; background: rgba(30,41,59,0.6); border-radius: 10px; padding: 0.75rem; margin-top: 0.75rem; }
    .tp-pill { background: rgba(59,130,246,0.35); color: #dbeafe; border-radius: 999px; padding: 0.3rem 0.75rem; font-size: 0.75rem; letter-spacing: 0.08em; text-transform: uppercase; }
    .icon-btn { background: rgba(239,68,68,0.15); border: 1px solid rgba(239,68,68,0.35); color: #fca5a5; border-radius: 10px; padding: 0.45rem; cursor: pointer; }
    .separator { height: 1px; background: rgba(148,163,184,0.2); margin: 0.75rem 0; }
    .toggle-row { display: flex; justify-content: space-between; align-items: center; }
    .tag { padding: 0.2rem 0.6rem; border-radius: 999px; font-size: 0.7rem; letter-spacing: 0.08em; text-transform: uppercase; }
    .tag-disabled { background: rgba(248,172,28,0.15); color: #facc15; }

    .time-filters { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1rem; margin-top: 1rem; }
    .time-block { background: rgba(5,10,20,0.8); border: 1px solid rgba(148,163,184,0.2); border-radius: 12px; padding: 1rem; display: grid; gap: 0.75rem; }
    .time-grid { display: grid; gap: 0.75rem; }
    .time-shell { display: inline-flex; align-items: center; gap: 0.4rem; background: rgba(15,23,42,0.55); border: 1px solid rgba(148,163,184,0.25); border-radius: 10px; padding: 0.4rem 0.65rem; }
    .time-shell input { width: 3rem; border: none; background: transparent; text-align: center; }
    .time-shell select { border: none; background: transparent; color: #e2e8f0; }

    .toggle-row .switch { margin-left: auto; }

    @media (max-width: 900px) {
        .builder-header { flex-direction: column; align-items: flex-start; }
    }

    /* Toast Notification Styles */
    .toast-notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 16px 24px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        gap: 12px;
        z-index: 9999;
        transform: translateX(120%);
        transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        font-weight: 500;
        max-width: 400px;
    }
    .toast-notification.show {
        transform: translateX(0);
    }
    .toast-success {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.95), rgba(5, 150, 105, 0.95));
        border: 1px solid rgba(16, 185, 129, 0.5);
        color: #ffffff;
    }
    .toast-error {
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.95), rgba(220, 38, 38, 0.95));
        border: 1px solid rgba(239, 68, 68, 0.5);
        color: #ffffff;
    }
    .toast-info {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.95), rgba(37, 99, 235, 0.95));
        border: 1px solid rgba(59, 130, 246, 0.5);
        color: #ffffff;
    }
    .toast-icon {
        font-size: 1.25rem;
        font-weight: bold;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
    }
    .toast-message {
        flex: 1;
        line-height: 1.4;
    }

    /* Webhook Card Section (matching recorders page) */
    .webhook-card { 
        background: rgba(11,18,33,0.92); 
        border-radius: 18px; 
        border: 1px solid rgba(148,163,184,0.12); 
        padding: 1.5rem; 
        display: grid; 
        gap: 1.25rem;
        margin-top: 1.5rem;
    }
    .webhook-card header { display: flex; justify-content: space-between; align-items: center; gap: 1rem; }
    .webhook-card header h2 { margin: 0 0 0.25rem; font-size: 1.25rem; }
    .webhook-card header p { margin: 0; color: #94a3b8; font-size: 0.9rem; }
    .webhook-body { display: grid; gap: 1.25rem; }
    .copy-row { display: flex; gap: 0.75rem; }
    .copy-row input { flex: 1; }
    .alert-block { 
        background: rgba(5,10,20,0.8); 
        border: 1px solid rgba(59,130,246,0.2); 
        border-radius: 12px; 
        padding: 1rem; 
        display: grid; 
        gap: 0.75rem; 
    }
    .alert-block h3 { margin: 0; font-size: 0.9rem; color: #bfdbfe; }
    .alert-block h4 { margin: 0 0 0.5rem; font-size: 0.9rem; color: #94a3b8; }
    .alert-block pre { 
        margin: 0; 
        background: rgba(15,23,42,0.55); 
        border: 1px solid rgba(59,130,246,0.25); 
        border-radius: 8px; 
        padding: 0.85rem; 
        color: #10b981; 
        font-size: 0.8rem; 
        line-height: 1.5; 
        overflow-x: auto;
        white-space: pre;
    }
    .alert-block.buy-alert {
        border-color: rgba(34,197,94,0.3);
        background: rgba(34,197,94,0.08);
    }
    .alert-block.buy-alert h4 { color: #86efac; }
    .alert-block.sell-alert {
        border-color: rgba(239,68,68,0.3);
        background: rgba(239,68,68,0.08);
    }
    .alert-block.sell-alert h4 { color: #fca5a5; }
    .alert-block.strategy-alert {
        border-color: rgba(59,130,246,0.3);
        background: rgba(59,130,246,0.08);
    }
    .alert-block.strategy-alert h4 { color: #93c5fd; }
    .alert-block + .alert-block { margin-top: 0.75rem; }
    .alert-section { display: grid; gap: 0.75rem; }
    .alert-section + .alert-section { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(148,163,184,0.12); }
    .section-title { margin: 0; font-size: 1rem; color: #e2e8f0; }
    .section-desc { margin: 0; color: #64748b; font-size: 0.85rem; }
    .alert-block small { color: #64748b; font-size: 0.8rem; margin-top: 0.25rem; }
    .btn-outline { 
        background: transparent; 
        border: 1px solid rgba(148,163,184,0.3); 
        color: #94a3b8; 
    }
    .btn-outline:hover { 
        background: rgba(148,163,184,0.1); 
        border-color: rgba(148,163,184,0.5); 
    }
    .btn-small { padding: 0.5rem 1rem; font-size: 0.75rem; }
    /* Multi-TP Target Styles */
    .tp-target-row {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 0.75rem;
        padding: 0.75rem;
        background: rgba(30,41,59,0.5);
        border-radius: 8px;
        border: 1px solid rgba(148,163,184,0.1);
    }
    .tp-target-row .tp-pill {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
        white-space: nowrap;
    }
    .tp-target-row .form-field {
        flex: 1;
        min-width: 0;
    }
    .tp-target-row .remove-tp-btn {
        background: transparent;
        border: none;
        color: #ef4444;
        cursor: pointer;
        padding: 0.25rem;
        border-radius: 4px;
        transition: background 0.2s;
    }
    .tp-target-row .remove-tp-btn:hover {
        background: rgba(239,68,68,0.1);
    }
    .add-tp-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background: transparent;
        border: 1px dashed rgba(16,185,129,0.5);
        color: #10b981;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.875rem;
        width: 100%;
        justify-content: center;
        margin-bottom: 1rem;
        transition: all 0.2s;
    }
    .add-tp-btn:hover {
        background: rgba(16,185,129,0.1);
        border-color: #10b981;
    }
}
</style>
{% endblock %}
{% block scripts %}
<script>
    // =============================================
    // Trail Settings Toggle Functions
    // =============================================

    function toggleTrailSettingsEdit() {
        const slType = document.getElementById('slType');
        const trailSettings = document.getElementById('trailSettingsEdit');
        if (slType && trailSettings) {
            trailSettings.style.display = (slType.value === 'Trail' || slType.value === 'Trailing') ? 'flex' : 'none';
        }
    }

    function toggleTrailSettingsCreate() {
        const slType = document.getElementById('createSlType');
        const trailSettings = document.getElementById('trailSettingsCreate');
        if (slType && trailSettings) {
            trailSettings.style.display = (slType.value === 'Trail' || slType.value === 'Trailing') ? 'flex' : 'none';
        }
    }

    // =============================================
    // Multi-TP Target Functions
    // =============================================
    let tpTargetCount = 0;

    function addTpTarget(ticks = 0, trim = 100) {
        const container = document.getElementById('tpTargetsContainer');
        if (!container) return;

        tpTargetCount++;
        const index = tpTargetCount;

        const row = document.createElement('div');
        row.className = 'tp-target-row';
        row.dataset.tpIndex = index;
        row.innerHTML = `
            <span class="tp-pill">TP #${index}</span>
            <label class="form-field">
                <span>TP Value (Ticks)</span>
                <input type="number" class="tp-ticks-input" value="${ticks}" min="0">
            </label>
            <label class="form-field">
                <span>Trim %</span>
                <input type="number" class="tp-trim-input" value="${trim}" min="0" max="100">
            </label>
            <button type="button" class="remove-tp-btn" onclick="removeTpTarget(this)" title="Remove TP">
                <span class="material-icons">close</span>
            </button>
        `;
        container.appendChild(row);
        updateTpLabels();
    }

    function removeTpTarget(btn) {
        const row = btn.closest('.tp-target-row');
        if (row) {
            row.remove();
            updateTpLabels();
        }
    }

    function updateTpLabels() {
        const container = document.getElementById('tpTargetsContainer');
        if (!container) return;
        const rows = container.querySelectorAll('.tp-target-row');
        rows.forEach((row, idx) => {
            const pill = row.querySelector('.tp-pill');
            if (pill) pill.textContent = `TP #${idx + 1}`;
        });
    }

    function getTpTargets() {
        const container = document.getElementById('tpTargetsContainer');
        if (!container) return [];

        const targets = [];
        const rows = container.querySelectorAll('.tp-target-row');
        rows.forEach(row => {
            const ticks = parseInt(row.querySelector('.tp-ticks-input')?.value ?? 0);
            const trim = parseInt(row.querySelector('.tp-trim-input')?.value ?? 100);
            targets.push({ ticks, trim });
        });
        return targets;
    }

    function initTpTargets(targets) {
        // Clear existing
        const container = document.getElementById('tpTargetsContainer');
        if (container) container.innerHTML = '';
        tpTargetCount = 0;

        if (!targets || targets.length === 0) {
            // Add default empty TP target
            addTpTarget(0, 100);
        } else {
            targets.forEach(t => {
                const ticks = t.ticks ?? t.value ?? 0;
                const trim = t.trim ?? 100;
                addTpTarget(ticks, trim);
            });
        }
    }

    // =============================================
    // List Page Functions (Toggle, Delete, Filter)
    // =============================================

    async function toggleTrader(traderId, newEnabled) {
        try {
            const response = await fetch(`/api/traders/${traderId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ enabled: newEnabled })
            });
            const data = await response.json();
            
            if (data.success) {
                showToast(newEnabled ? 'Trader enabled - Live trading active!' : 'Trader paused - Live trading stopped.', 'success');
                // Reload page to reflect changes
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('Error updating trader: ' + (data.error || 'Unknown error'), 'error');
            }
        } catch (error) {
            console.error('Error toggling trader:', error);
            showToast('Network error. Please try again.', 'error');
        }
    }
    
    async function refreshTrader(traderId) {
        const row = document.querySelector(`tr[data-trader-id="${traderId}"]`);
        const btn = row.querySelector('.action-btn-refresh');
        
        // Add spinning animation
        btn.classList.add('spinning');
        
        try {
            const response = await fetch(`/api/traders/${traderId}`);
            const data = await response.json();
            
            if (data.success) {
                showToast('Trader status refreshed!', 'success', 2000);
                // Reload page to show updated data
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('Error refreshing: ' + (data.error || 'Unknown error'), 'error');
            }
        } catch (error) {
            console.error('Error refreshing trader:', error);
            showToast('Network error. Please try again.', 'error');
        } finally {
            btn.classList.remove('spinning');
        }
    }
    
    async function deleteTrader(traderId, traderName) {
        // Show confirmation modal
        if (!confirm(`Are you sure you want to delete trader "${traderName}"?\n\nThis will stop live trading for this recorder-account link.\nThe recorder and recorded trades will NOT be affected.`)) {
            return;
        }
        
        try {
            const response = await fetch(`/api/traders/${traderId}`, {
                method: 'DELETE'
            });
            const data = await response.json();
            
            if (data.success) {
                showToast('Trader deleted successfully.', 'success');
                // Remove the row from the table
                const row = document.querySelector(`tr[data-trader-id="${traderId}"]`);
                if (row) {
                    row.style.transition = 'opacity 0.3s ease';
                    row.style.opacity = '0';
                    setTimeout(() => {
                        row.remove();
                        // Check if table is now empty
                        const tbody = document.getElementById('tradersTableBody');
                        if (tbody && tbody.children.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="4" class="empty-state">No traders yet. Click "Create Trader" to link a recorder to an account.</td></tr>';
                        }
                    }, 300);
                }
            } else {
                showToast('Error deleting trader: ' + (data.error || 'Unknown error'), 'error');
            }
        } catch (error) {
            console.error('Error deleting trader:', error);
            showToast('Network error. Please try again.', 'error');
        }
    }
    
    function applyFilters() {
        const searchVal = (document.getElementById('searchInput').value || '').toLowerCase();
        const envFilter = document.getElementById('filterEnv').value;
        const statusFilter = document.getElementById('filterStatus').value;
        const sortBy = document.getElementById('sortBy').value;
        const container = document.getElementById('strategiesContainer');
        const cards = [...container.querySelectorAll('.strategy-card')];

        cards.forEach(card => {
            const name = (card.dataset.strategyName || '').toLowerCase();
            const nameMatch = !searchVal || name.includes(searchVal);

            const rows = card.querySelectorAll('tbody tr[data-trader-id]');
            let visibleRows = 0;

            rows.forEach(row => {
                let show = true;
                // Environment filter
                if (envFilter !== 'all') {
                    const envBadge = row.querySelector('.env-badge');
                    const isDemo = envBadge && envBadge.classList.contains('env-demo');
                    if (envFilter === 'demo' && !isDemo) show = false;
                    if (envFilter === 'live' && isDemo) show = false;
                }
                // Status filter
                if (statusFilter !== 'all') {
                    const statusBadge = row.querySelector('.status-badge');
                    const isEnabled = statusBadge && statusBadge.classList.contains('status-live');
                    if (statusFilter === 'enabled' && !isEnabled) show = false;
                    if (statusFilter === 'paused' && isEnabled) show = false;
                }
                row.style.display = show ? '' : 'none';
                if (show) visibleRows++;
            });

            // Hide card if name doesn't match or no visible rows
            card.style.display = (nameMatch && visibleRows > 0) ? '' : 'none';
        });

        // Sort visible cards
        const sortedCards = cards.filter(c => c.style.display !== 'none');
        sortedCards.sort((a, b) => {
            const nameA = (a.dataset.strategyName || '').toLowerCase();
            const nameB = (b.dataset.strategyName || '').toLowerCase();
            const totalA = parseInt(a.dataset.totalAccounts) || 0;
            const totalB = parseInt(b.dataset.totalAccounts) || 0;
            const liveA = parseInt(a.dataset.liveAccounts) || 0;
            const liveB = parseInt(b.dataset.liveAccounts) || 0;

            switch (sortBy) {
                case 'name': return nameA.localeCompare(nameB);
                case 'name-desc': return nameB.localeCompare(nameA);
                case 'accounts': return totalB - totalA;
                case 'active': return liveB - liveA;
                default: return 0;
            }
        });
        // Reorder DOM
        sortedCards.forEach(card => container.appendChild(card));
        // Also re-append hidden cards at the end so they stay in DOM
        cards.filter(c => c.style.display === 'none').forEach(card => container.appendChild(card));
    }

    async function bulkToggleStrategy(recorderId, btn) {
        const card = btn.closest('.strategy-card');
        const rows = card.querySelectorAll('tbody tr[data-trader-id]');
        if (rows.length === 0) return;

        const anyEnabled = [...rows].some(r => r.querySelector('.status-live'));
        const newState = anyEnabled ? 0 : 1;
        const action = newState ? 'enable' : 'pause';

        if (!confirm(`${action.toUpperCase()} all ${rows.length} accounts in this strategy?`)) return;

        btn.disabled = true;
        btn.querySelector('.material-icons').style.opacity = '0.4';
        let success = 0;

        for (const row of rows) {
            const id = row.dataset.traderId;
            try {
                const r = await fetch(`/api/traders/${id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({enabled: newState})
                });
                const d = await r.json();
                if (d.success) success++;
            } catch(e) {
                console.error('Bulk toggle error for trader', id, e);
            }
        }

        showToast(`${success}/${rows.length} accounts ${action}d`, 'success');
        setTimeout(() => location.reload(), 1000);
    }

    async function bulkDeleteStrategy(strategyName, btn) {
        const card = btn.closest('.strategy-card');
        const rows = card.querySelectorAll('tbody tr[data-trader-id]');
        if (rows.length === 0) return;

        if (!confirm(`DELETE all ${rows.length} trader accounts under "${strategyName}"?\n\nThis removes the trader links â€” your recorder and recorded trades are NOT affected.`)) return;

        btn.disabled = true;
        btn.querySelector('.material-icons').style.opacity = '0.4';
        let success = 0;

        for (const row of rows) {
            const id = row.dataset.traderId;
            try {
                const r = await fetch(`/api/traders/${id}`, { method: 'DELETE' });
                const d = await r.json();
                if (d.success) {
                    success++;
                    row.style.transition = 'opacity 0.3s ease';
                    row.style.opacity = '0';
                }
            } catch(e) {
                console.error('Bulk delete error for trader', id, e);
            }
        }

        showToast(`${success}/${rows.length} accounts deleted`, 'success');
        setTimeout(() => location.reload(), 1000);
    }

    function toggleStrategyExpand(btn) {
        const card = btn.closest('.strategy-card');
        card.classList.toggle('collapsed');
    }
    
    // =============================================
    // Edit Page Functions
    // =============================================
    
    async function toggleTraderEdit(traderId, newEnabled) {
        const btn = document.getElementById('toggleTraderBtn');
        btn.disabled = true;
        btn.textContent = 'Updating...';
        
        try {
            const response = await fetch(`/api/traders/${traderId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ enabled: newEnabled })
            });
            const data = await response.json();
            
            if (data.success) {
                showToast(newEnabled ? 'Trader enabled - Live trading active!' : 'Trader paused - Live trading stopped.', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('Error updating trader: ' + (data.error || 'Unknown error'), 'error');
                btn.disabled = false;
                btn.textContent = newEnabled ? 'Enable Trading' : 'Pause Trading';
            }
        } catch (error) {
            console.error('Error toggling trader:', error);
            showToast('Network error. Please try again.', 'error');
            btn.disabled = false;
            btn.textContent = newEnabled ? 'Enable Trading' : 'Pause Trading';
        }
    }
    
    async function deleteTraderEdit(traderId, traderName) {
        if (!confirm(`Are you sure you want to delete trader "${traderName}"?\n\nThis will stop live trading for this recorder-account link.`)) {
            return;
        }
        
        try {
            const response = await fetch(`/api/traders/${traderId}`, {
                method: 'DELETE'
            });
            const data = await response.json();
            
            if (data.success) {
                showToast('Trader deleted successfully.', 'success');
                setTimeout(() => {
                    window.location.href = '/traders';
                }, 1000);
            } else {
                showToast('Error deleting trader: ' + (data.error || 'Unknown error'), 'error');
            }
        } catch (error) {
            console.error('Error deleting trader:', error);
            showToast('Network error. Please try again.', 'error');
        }
    }

    // =============================================
    // Webhook Card Toggle
    // =============================================
    
    function toggleWebhookCard() {
        const body = document.getElementById('webhook-body');
        const icon = document.getElementById('webhook-toggle-icon');
        if (body.style.display === 'none') {
            body.style.display = 'grid';
            icon.textContent = 'expand_more';
        } else {
            body.style.display = 'none';
            icon.textContent = 'expand_less';
        }
    }

    // =============================================
    // Tier Pill Selector (Admin Only)
    // =============================================
    function selectTier(tier) {
        document.getElementById('required_tier').value = tier;
        document.querySelectorAll('.tier-pill').forEach(btn => {
            const btnTier = btn.getAttribute('data-tier');
            const colors = { public: '#10b981', premium: '#f59e0b', elite: '#8b5cf6' };
            if (btnTier === tier) {
                btn.style.background = colors[tier];
                btn.style.color = '#fff';
            } else {
                btn.style.background = '#1e293b';
                btn.style.color = '#64748b';
            }
        });
    }

    // =============================================
    // Inverse Signals Toggle
    // =============================================
    
    async function saveInverseSignals() {
        const checkbox = document.getElementById('inverseSignals');
        const inverseEnabled = checkbox.checked ? 1 : 0;
        const recorderId = {{ recorder.id if recorder else 0 }};
        
        if (!recorderId) {
            console.log('No recorder ID, skipping inverse save');
            return;
        }
        
        try {
            const response = await fetch(`/api/recorders/${recorderId}/inverse`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ inverse_signals: inverseEnabled })
            });
            
            const data = await response.json();
            if (data.success) {
                showToast(inverseEnabled ? 'ðŸ”„ Inverse Signals ENABLED - BUYâ†”SELL will be swapped' : 'âœ… Inverse Signals disabled', 'success');
            } else {
                showToast('Error saving inverse setting: ' + (data.error || 'Unknown error'), 'error');
                checkbox.checked = !checkbox.checked; // Revert
            }
        } catch (error) {
            console.error('Error saving inverse signals:', error);
            showToast('Error saving setting', 'error');
            checkbox.checked = !checkbox.checked; // Revert
        }
    }

    // =============================================
    // Copy to Clipboard
    // =============================================
    
    function copyToClipboard(elementId, button) {
        const element = document.getElementById(elementId);
        let text;
        
        // Handle both input elements and pre/code elements
        if (element.tagName === 'INPUT') {
            text = element.value;
        } else {
            text = element.textContent || element.innerText;
        }
        
        navigator.clipboard.writeText(text).then(() => {
            // Show success feedback
            const originalHTML = button.innerHTML;
            button.innerHTML = '<span class="material-icons">check</span> Copied!';
            button.style.background = 'rgba(16, 185, 129, 0.3)';
            button.style.color = '#10b981';
            
            setTimeout(() => {
                button.innerHTML = originalHTML;
                button.style.background = '';
                button.style.color = '';
            }, 2000);
            
            showToast('Copied to clipboard!', 'success', 2000);
        }).catch(err => {
            console.error('Failed to copy:', err);
            showToast('Failed to copy to clipboard', 'error');
        });
    }

    // =============================================
    // Toast Notification
    // =============================================
    
    // Toast notification function
    function showToast(message, type = 'success', duration = 3000) {
        // Remove any existing toast
        const existingToast = document.querySelector('.toast-notification');
        if (existingToast) existingToast.remove();
        
        const toast = document.createElement('div');
        toast.className = 'toast-notification toast-' + type;
        
        const icon = type === 'success' ? 'âœ“' : type === 'error' ? 'âœ•' : 'â„¹';
        toast.innerHTML = `
            <span class="toast-icon">${icon}</span>
            <span class="toast-message">${message}</span>
        `;
        
        document.body.appendChild(toast);
        
        // Trigger animation
        setTimeout(() => toast.classList.add('show'), 10);
        
        // Auto remove
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, duration);
    }

    document.addEventListener('DOMContentLoaded', function () {
        // Debug: Log all multiplier values on page load
        document.querySelectorAll('.account-multiplier').forEach(function(input) {
            const row = input.closest('tr');
            const accountName = row ? row.querySelector('td:first-child')?.textContent?.trim() : 'Unknown';
            console.log(`Loaded multiplier for ${accountName}: ${input.value} (type: ${typeof input.value})`);
        });
        
        // =============================================
        // Recorder Selection & Auto-Population
        // =============================================
        
        async function loadRecorderDefaults(recorderId) {
            if (!recorderId) return;
            
            try {
                const response = await fetch(`/api/recorders/${recorderId}`);
                const data = await response.json();
                
                if (data.success && data.recorder) {
                    populateFormFromRecorder(data.recorder);
                } else {
                    console.error('Failed to load recorder:', data.error);
                    showToast('Failed to load recorder settings', 'error');
                }
            } catch (error) {
                console.error('Error loading recorder:', error);
                showToast('Error loading recorder settings', 'error');
            }
        }
        
        function populateFormFromRecorder(recorder) {
            console.log('Populating form with recorder:', recorder);
            
            // Show the recorder loaded alert
            const recorderAlert = document.getElementById('recorderAlert');
            const recorderAlertMessage = document.getElementById('recorderAlertMessage');
            if (recorderAlert && recorderAlertMessage) {
                recorderAlertMessage.textContent = `Settings loaded from "${recorder.name}". Customize as needed for your accounts.`;
                recorderAlert.style.display = 'block';
            }
            
            // Populate Strategy Type
            const strategyType = document.getElementById('strategyType');
            if (strategyType && recorder.strategy_type) {
                strategyType.value = recorder.strategy_type;
            }
            
            // Populate Position Settings
            const initialPositionSize = document.getElementById('createInitialPositionSize');
            if (initialPositionSize) initialPositionSize.value = recorder.initial_position_size || 1;
            
            const addPositionSize = document.getElementById('createAddPositionSize');
            if (addPositionSize) addPositionSize.value = recorder.add_position_size || 1;
            
            // Populate TP Settings
            const tpUnits = document.getElementById('createTpUnits');
            if (tpUnits && recorder.tp_units) tpUnits.value = recorder.tp_units;
            
            const trimUnits = document.getElementById('createTrimUnits');
            if (trimUnits && recorder.trim_units) trimUnits.value = recorder.trim_units;
            
            // Parse TP targets if available
            let tpValue = 0;
            let tpTrim = 100;
            if (recorder.tp_targets) {
                try {
                    const targets = typeof recorder.tp_targets === 'string' ? JSON.parse(recorder.tp_targets) : recorder.tp_targets;
                    if (targets && targets.length > 0) {
                        tpValue = targets[0].value || targets[0].ticks || 0;
                        tpTrim = targets[0].trim || targets[0].percent || 100;
                    }
                } catch (e) {
                    console.log('Could not parse TP targets:', e);
                }
            }
            
            const tpValueInput = document.getElementById('createTpValue');
            if (tpValueInput) tpValueInput.value = tpValue;
            
            const tpTrimInput = document.getElementById('createTpTrim');
            if (tpTrimInput) tpTrimInput.value = tpTrim;
            
            // Populate SL Settings
            const slEnabled = document.getElementById('createSlEnabled');
            if (slEnabled) slEnabled.checked = recorder.sl_enabled ? true : false;
            
            const slAmount = document.getElementById('createSlAmount');
            if (slAmount) slAmount.value = recorder.sl_amount || 0;
            
            const slUnits = document.getElementById('createSlUnits');
            if (slUnits && recorder.sl_units) slUnits.value = recorder.sl_units;
            
            const slType = document.getElementById('createSlType');
            if (slType && recorder.sl_type) {
                // Normalize: recorder may send 'Trail' or 'Trailing'
                slType.value = (recorder.sl_type === 'Trailing' || recorder.sl_type === 'Trail') ? 'Trail' : recorder.sl_type;
                // Show/hide trailing settings based on populated value
                if (typeof toggleTrailSettingsCreate === 'function') toggleTrailSettingsCreate();
            }

            // Populate Trail Settings
            const trailTrigger = document.getElementById('createTrailTrigger');
            if (trailTrigger) trailTrigger.value = recorder.trail_trigger || 0;

            const trailFreq = document.getElementById('createTrailFreq');
            if (trailFreq) trailFreq.value = recorder.trail_freq || 0;

            // Populate Break-Even Settings
            const breakEvenEnabled = document.getElementById('createBreakEvenEnabled');
            if (breakEvenEnabled) breakEvenEnabled.checked = recorder.break_even_enabled ? true : false;

            const breakEvenTicks = document.getElementById('createBreakEvenTicks');
            if (breakEvenTicks) breakEvenTicks.value = recorder.break_even_ticks || 10;

            const breakEvenOffset = document.getElementById('createBreakEvenOffset');
            if (breakEvenOffset) breakEvenOffset.value = recorder.break_even_offset || 0;

            // Populate DCA/Averaging Down Settings
            const avgDownEnabled = document.getElementById('createAvgDownEnabled');
            if (avgDownEnabled) avgDownEnabled.checked = recorder.avg_down_enabled ? true : false;

            const avgDownAmount = document.getElementById('createAvgDownAmount');
            if (avgDownAmount) avgDownAmount.value = recorder.avg_down_amount || 1;

            const avgDownPoint = document.getElementById('createAvgDownPoint');
            if (avgDownPoint) avgDownPoint.value = recorder.avg_down_point || 10;

            // Populate Max Contracts
            const maxContracts = document.getElementById('createMaxContracts');
            if (maxContracts) maxContracts.value = recorder.max_contracts || 0;

            // Populate Execution Controls
            const signalCooldown = document.getElementById('createSignalCooldown');
            if (signalCooldown) signalCooldown.value = recorder.signal_cooldown || 0;

            const maxSignalsPerSession = document.getElementById('createMaxSignalsPerSession');
            if (maxSignalsPerSession) maxSignalsPerSession.value = recorder.max_signals_per_session || 0;

            const maxDailyLoss = document.getElementById('createMaxDailyLoss');
            if (maxDailyLoss) maxDailyLoss.value = recorder.max_daily_loss || 0;

            const addDelay = document.getElementById('createAddDelay');
            if (addDelay) addDelay.value = recorder.add_delay || 1;

            // Populate Time Filters
            const tf1Enabled = document.getElementById('new_time_filter_1_enabled');
            if (tf1Enabled) tf1Enabled.checked = recorder.time_filter_1_enabled ? true : false;
            const tf1Start = document.getElementById('newTimeFilter1Start');
            if (tf1Start) tf1Start.value = recorder.time_filter_1_start || '';
            const tf1Stop = document.getElementById('newTimeFilter1Stop');
            if (tf1Stop) tf1Stop.value = recorder.time_filter_1_stop || '';

            const tf2Enabled = document.getElementById('new_time_filter_2_enabled');
            if (tf2Enabled) tf2Enabled.checked = recorder.time_filter_2_enabled ? true : false;
            const tf2Start = document.getElementById('newTimeFilter2Start');
            if (tf2Start) tf2Start.value = recorder.time_filter_2_start || '';
            const tf2Stop = document.getElementById('newTimeFilter2Stop');
            if (tf2Stop) tf2Stop.value = recorder.time_filter_2_stop || '';

            // Flash highlight on populated fields to show what changed
            const fieldsToHighlight = [
                '#createInitialPositionSize', '#createAddPositionSize',
                '#createTpValue', '#createTpTrim',
                '#createSlAmount', '#createAvgDownAmount', '#createAvgDownPoint',
                '#createMaxContracts', '#createTrailTrigger', '#createTrailFreq',
                '#createBreakEvenTicks', '#createBreakEvenOffset',
                '#createSignalCooldown', '#createMaxSignalsPerSession',
                '#createMaxDailyLoss', '#createAddDelay'
            ];
            
            fieldsToHighlight.forEach(selector => {
                const el = document.querySelector(selector);
                if (el) {
                    el.style.transition = 'background-color 0.3s ease';
                    el.style.backgroundColor = 'rgba(16, 185, 129, 0.3)';
                    setTimeout(() => {
                        el.style.backgroundColor = '';
                    }, 1500);
                }
            });
            
            showToast(`Recorder "${recorder.name}" defaults loaded! Customize settings as needed.`, 'success', 3000);
        }
        
        // Handle recorder selection - auto-populate settings
        const recorderSelect = document.getElementById('recorderSelect');
        if (recorderSelect) {
            recorderSelect.addEventListener('change', function() {
                if (this.value) {
                    loadRecorderDefaults(this.value);
                } else {
                    // Hide the alert if no recorder selected
                    const recorderAlert = document.getElementById('recorderAlert');
                    if (recorderAlert) recorderAlert.style.display = 'none';
                }
            });
        }
        
        // Panel toggle functionality
        document.querySelectorAll('[data-panel]').forEach(function(panel) {
            const toggle = panel.querySelector('.panel-toggle');
            if (!toggle) return;
            toggle.addEventListener('click', function () {
                panel.classList.toggle('collapsed');
                const icon = toggle.querySelector('.material-icons');
                if (icon) {
                    icon.textContent = panel.classList.contains('collapsed') ? 'add' : 'remove';
                }
            });
        });
        
        // Time Filter Toggle functionality (Create mode)
        function setupNewTimeFilterToggles() {
            // Time Filter 1 (Create mode)
            const tf1Enabled = document.getElementById('new_time_filter_1_enabled');
            const tf1Fields = document.getElementById('new_time_filter_1_fields');
            if (tf1Enabled && tf1Fields) {
                const updateTf1 = () => {
                    tf1Fields.style.opacity = tf1Enabled.checked ? '1' : '0.4';
                    tf1Fields.style.pointerEvents = tf1Enabled.checked ? 'auto' : 'none';
                };
                tf1Enabled.addEventListener('change', updateTf1);
                updateTf1(); // Set initial state (disabled by default)
            }
            
            // Time Filter 2 (Create mode)
            const tf2Enabled = document.getElementById('new_time_filter_2_enabled');
            const tf2Fields = document.getElementById('new_time_filter_2_fields');
            if (tf2Enabled && tf2Fields) {
                const updateTf2 = () => {
                    tf2Fields.style.opacity = tf2Enabled.checked ? '1' : '0.4';
                    tf2Fields.style.pointerEvents = tf2Enabled.checked ? 'auto' : 'none';
                };
                tf2Enabled.addEventListener('change', updateTf2);
                updateTf2(); // Set initial state (disabled by default)
            }
        }
        setupNewTimeFilterToggles();
        
        // Form submission handler
        const form = document.getElementById('traderForm');
        if (form) {
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const validationAlert = document.getElementById('validationAlert');
                const validationErrors = document.getElementById('validationErrors');
                const submitBtn = document.getElementById('createTraderBtn');
                
                // Check if this is an edit or create
                const editTraderId = document.getElementById('editTraderId');
                const isEdit = editTraderId && editTraderId.value;
                
                // Clear previous errors
                validationErrors.innerHTML = '';
                validationAlert.style.display = 'none';
                
                // Get selected recorder
                const recorderSelect = document.getElementById('recorderSelect');
                const recorderId = recorderSelect.value;
                
                // Get enabled accounts with subaccount info
                const enabledAccounts = [];
                document.querySelectorAll('.account-enable:checked').forEach(function(checkbox) {
                    const row = checkbox.closest('tr');
                    const accountId = row.dataset.accountId;
                    const accountName = row.dataset.accountName;
                    const subaccountId = row.dataset.subaccountId;
                    const subaccountName = row.dataset.subaccountName;
                    const isDemo = row.dataset.isDemo === 'true';
                    const maxCons = row.querySelector('.account-max-cons').value || 0;
                    const ticker = row.querySelector('.account-ticker').value || '';
                    const multiplierInput = row.querySelector('.account-multiplier');
                    let multiplier = 1.0;
                    if (multiplierInput) {
                        const multiplierValue = multiplierInput.value.trim();
                        if (multiplierValue) {
                            multiplier = parseFloat(multiplierValue);
                            if (isNaN(multiplier) || multiplier <= 0) {
                                multiplier = 1.0;
                            }
                        }
                    }
                    
                    // Log what we're saving for debugging
                    console.log(`Saving account ${accountName}: multiplier=${multiplier} (input value="${multiplierInput ? multiplierInput.value : 'N/A'}")`);
                    
                    enabledAccounts.push({
                        account_id: parseInt(accountId),
                        account_name: accountName,
                        subaccount_id: subaccountId ? parseInt(subaccountId) : null,
                        subaccount_name: subaccountName,
                        is_demo: isDemo,
                        max_contracts: parseInt(maxCons) || 0,
                        custom_ticker: ticker || '',
                        multiplier: multiplier  // Always a valid float >= 0.1
                    });
                });
                
                // Log the full enabled_accounts array before sending
                console.log('Saving enabled_accounts:', JSON.stringify(enabledAccounts, null, 2));
                
                // Validate
                const errors = [];
                if (!recorderId) {
                    errors.push('Please select a recorder (strategy).');
                }
                if (enabledAccounts.length === 0) {
                    errors.push('At least one account must be enabled.');
                }
                
                if (errors.length > 0) {
                    errors.forEach(function(err) {
                        const li = document.createElement('li');
                        li.textContent = err;
                        validationErrors.appendChild(li);
                    });
                    validationAlert.style.display = 'block';
                    return;
                }
                
                // Disable button while submitting
                submitBtn.disabled = true;
                submitBtn.textContent = isEdit ? 'Updating...' : 'Creating...';
                
                try {
                    if (isEdit) {
                        // UPDATE existing trader
                        const traderId = editTraderId.value;
                        const account = enabledAccounts[0]; // Primary account (for backward compatibility)
                        
                        // Collect all risk settings
                        const initialPositionSize = parseInt(document.getElementById('initialPositionSize')?.value) || 1;
                        const addPositionSize = parseInt(document.getElementById('addPositionSize')?.value) || 1;
                        const tpUnits = document.getElementById('tpUnits')?.value || 'Ticks';
                        const slEnabled = document.getElementById('slEnabled')?.checked ? 1 : 0;
                        const slAmount = parseFloat(document.getElementById('slAmount')?.value) || 0;
                        const slUnits = document.getElementById('slUnits')?.value || 'Ticks';
                        const slType = document.getElementById('slType')?.value || 'Fixed';
                        const breakEvenEnabled = document.getElementById('breakEvenEnabled')?.checked ? 1 : 0;
                        const breakEvenTicks = parseInt(document.getElementById('breakEvenTicks')?.value) || 10;
                        const breakEvenOffset = parseInt(document.getElementById('breakEvenOffset')?.value) || 0;
                        const trailTrigger = parseInt(document.getElementById('trailTrigger')?.value) || 0;
                        const trailFreq = parseInt(document.getElementById('trailFreq')?.value) || 0;
                        const avgDownEnabled = document.getElementById('avgDownEnabled')?.checked ? 1 : 0;
                        const avgDownAmount = parseInt(document.getElementById('avgDownAmount')?.value) || 1;
                        const avgDownPoint = parseFloat(document.getElementById('avgDownPoint')?.value) || 10;
                        const avgDownUnits = document.getElementById('avgDownUnits')?.value || 'Ticks';
                        const trimUnits = document.getElementById('trimUnits')?.value || 'Percent';

                        // Get time filter settings
                        const timeFilter1Enabled = document.getElementById('time_filter_1_enabled')?.checked ? true : false;
                        const timeFilter1Start = document.getElementById('timeFilter1Start')?.value || '';
                        const timeFilter1Stop = document.getElementById('timeFilter1Stop')?.value || '';
                        const timeFilter2Enabled = document.getElementById('time_filter_2_enabled')?.checked ? true : false;
                        const timeFilter2Start = document.getElementById('timeFilter2Start')?.value || '';
                        const timeFilter2Stop = document.getElementById('timeFilter2Stop')?.value || '';

                        // Signal delay - take every Nth signal
                        const addDelay = parseInt(document.getElementById('addDelay')?.value) || 1;

                        // Risk management settings
                        const signalCooldown = parseInt(document.getElementById('signalCooldown')?.value) || 0;
                        const maxSignalsPerSession = parseInt(document.getElementById('maxSignalsPerSession')?.value) || 0;
                        const maxDailyLoss = parseFloat(document.getElementById('maxDailyLoss')?.value) || 0;
                        const autoFlatAfterCutoff = document.getElementById('autoFlatAfterCutoff')?.checked ? 1 : 0;
                        const inverseSignals = document.getElementById('inverseSignals')?.checked ? 1 : 0;

                        // Build TP targets array from dynamic inputs
                        const tpTargets = JSON.stringify(getTpTargets());
                        
                        // Log what we're sending
                        console.log('Saving trader with settings:', {
                            initial_position_size: initialPositionSize,
                            add_position_size: addPositionSize,
                            tp_targets: tpTargets,
                            sl_enabled: slEnabled,
                            sl_amount: slAmount,
                            avg_down_enabled: avgDownEnabled,
                            time_filter_1_enabled: timeFilter1Enabled,
                            time_filter_2_enabled: timeFilter2Enabled
                        });
                        
                        const response = await fetch(`/api/traders/${traderId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                recorder_id: parseInt(recorderId),
                                account_id: account.account_id,
                                enabled_accounts: enabledAccounts,
                                // Risk settings
                                initial_position_size: initialPositionSize,
                                add_position_size: addPositionSize,
                                tp_units: tpUnits,
                                trim_units: trimUnits,
                                tp_targets: tpTargets,
                                sl_enabled: slEnabled,
                                sl_amount: slAmount,
                                sl_units: slUnits,
                                sl_type: slType,
                                break_even_enabled: breakEvenEnabled,
                                break_even_ticks: breakEvenTicks,
                                break_even_offset: breakEvenOffset,
                                trail_trigger: trailTrigger,
                                trail_freq: trailFreq,
                                avg_down_enabled: avgDownEnabled,
                                avg_down_amount: avgDownAmount,
                                avg_down_point: avgDownPoint,
                                avg_down_units: avgDownUnits,
                                // Time filter settings
                                time_filter_1_enabled: timeFilter1Enabled,
                                time_filter_1_start: timeFilter1Start,
                                time_filter_1_stop: timeFilter1Stop,
                                time_filter_2_enabled: timeFilter2Enabled,
                                time_filter_2_start: timeFilter2Start,
                                time_filter_2_stop: timeFilter2Stop,
                                // Signal delay
                                add_delay: addDelay,
                                // Risk management
                                signal_cooldown: signalCooldown,
                                max_signals_per_session: maxSignalsPerSession,
                                max_daily_loss: maxDailyLoss,
                                auto_flat_after_cutoff: autoFlatAfterCutoff,
                                inverse_signals: inverseSignals,
                                // Recorder privacy settings
                                recorder_is_private: document.getElementById('recorder_is_private') ? document.getElementById('recorder_is_private').checked : undefined,
                                required_tier: document.getElementById('required_tier') ? document.getElementById('required_tier').value : undefined
                            })
                        });
                        
                        // Check response status first
                        if (!response.ok) {
                            const errorText = await response.text();
                            console.error('Server error response:', response.status, errorText);
                            showToast('Network error: ' + response.status + ' - ' + errorText.substring(0, 100), 'error', 5000);
                            submitBtn.disabled = false;
                            submitBtn.textContent = isEdit ? 'Update Trader' : 'Create Trader';
                            return;
                        }
                        
                        // Parse response only once
                        const data = await response.json();
                        console.log('Server response:', data);
                        if (data.success) {
                            showToast('Trader updated successfully!', 'success', 2500);
                            setTimeout(() => {
                                window.location.href = '/traders';
                            }, 1500);
                        } else {
                            showToast('Error updating trader: ' + (data.error || 'Unknown error'), 'error', 4000);
                            submitBtn.disabled = false;
                            submitBtn.textContent = isEdit ? 'Update Trader' : 'Create Trader';
                        }
                    } else {
                        // CREATE new traders
                        let successCount = 0;
                        let errorMessages = [];
                        
                        // Collect create form settings
                        const newInverseSignals = document.getElementById('createInverseSignals')?.checked ? 1 : 0;
                        const newTimeFilter1Enabled = document.getElementById('new_time_filter_1_enabled')?.checked ? true : false;
                        const newTimeFilter1Start = document.getElementById('newTimeFilter1Start')?.value || '';
                        const newTimeFilter1Stop = document.getElementById('newTimeFilter1Stop')?.value || '';
                        const newTimeFilter2Enabled = document.getElementById('new_time_filter_2_enabled')?.checked ? true : false;
                        const newTimeFilter2Start = document.getElementById('newTimeFilter2Start')?.value || '';
                        const newTimeFilter2Stop = document.getElementById('newTimeFilter2Stop')?.value || '';
                        
                        for (const account of enabledAccounts) {
                            const response = await fetch('/api/traders', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    recorder_id: parseInt(recorderId),
                                    account_id: account.account_id,
                                    subaccount_id: account.subaccount_id,
                                    subaccount_name: account.subaccount_name,
                                    is_demo: account.is_demo,
                                    inverse_signals: newInverseSignals,
                                    // Time filter settings (optional overrides)
                                    time_filter_1_enabled: newTimeFilter1Enabled,
                                    time_filter_1_start: newTimeFilter1Start,
                                    time_filter_1_stop: newTimeFilter1Stop,
                                    time_filter_2_enabled: newTimeFilter2Enabled,
                                    time_filter_2_start: newTimeFilter2Start,
                                    time_filter_2_stop: newTimeFilter2Stop
                                })
                            });
                            
                            const data = await response.json();
                            if (data.success) {
                                successCount++;
                            } else {
                                errorMessages.push(`${account.account_name}: ${data.error || 'Unknown error'}`);
                            }
                        }
                        
                        if (successCount > 0) {
                            showToast(`Successfully created ${successCount} trader(s)! Live trading enabled.`, 'success', 2500);
                            setTimeout(() => {
                                window.location.href = '/traders';
                            }, 1500);
                        } else {
                            errorMessages.forEach(function(err) {
                                const li = document.createElement('li');
                                li.textContent = err;
                                validationErrors.appendChild(li);
                            });
                            validationAlert.style.display = 'block';
                            showToast('Failed to create trader. See errors below.', 'error', 4000);
                        }
                    }
                } catch (error) {
                    console.error('Error saving trader:', error);
                    const li = document.createElement('li');
                    li.textContent = 'Network error. Please try again.';
                    validationErrors.appendChild(li);
                    validationAlert.style.display = 'block';
                    showToast('Network error. Please try again.', 'error', 4000);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = isEdit ? 'Update Trader' : 'Create Trader';
                }
            });
        }

        // Initialize TP Targets for edit mode
        {% if mode == 'edit' and trader.tp_targets %}
        try {
            const tpTargetsData = {{ trader.tp_targets | tojson | safe }};
            if (Array.isArray(tpTargetsData)) {
                initTpTargets(tpTargetsData);
            } else {
                initTpTargets([]);
            }
        } catch (e) {
            console.log('Could not parse TP targets, using defaults');
            initTpTargets([]);
        }
        {% elif mode == 'edit' %}
        // No TP targets saved yet - add default
        initTpTargets([]);
        {% else %}
        // New trader - add default empty TP target
        initTpTargets([]);
        {% endif %}
    });
</script>
{% endblock %}
