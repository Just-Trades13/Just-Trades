{% extends "layout.html" %}
{% block title %}My Traders - Just.Trades.{% endblock %}
{% block page_title %}MY TRADERS{% endblock %}
{% block content %}
<div class="traders-wrapper">
    {% if mode == 'list' %}
    <section class="list-header">
        <input type="text" placeholder="Search strategy..." id="searchInput" onkeyup="filterTraders()">
        <a class="btn btn-primary" href="/traders/new">Create Trader</a>
    </section>
    <table class="trader-table">
        <thead>
            <tr>
                <th>ACTIONS</th>
                <th>STRATEGY</th>
                <th>ACCOUNT</th>
                <th>STATUS</th>
            </tr>
        </thead>
        <tbody id="tradersTableBody">
            {% for trader in traders %}
            <tr data-trader-id="{{ trader.id }}" data-trader-name="{{ trader.recorder_name }}">
                <td class="actions">
                    <a href="/traders/{{ trader.id }}" class="action-btn action-btn-edit" title="Edit Trader">
                        <span class="material-icons">edit</span>
                    </a>
                    <button class="action-btn action-btn-refresh" onclick="refreshTrader({{ trader.id }})" title="Refresh Status">
                        <span class="material-icons">refresh</span>
                    </button>
                    <button class="action-btn action-btn-toggle" onclick="toggleTrader({{ trader.id }}, {{ 0 if trader.enabled else 1 }})" title="{{ 'Pause Trading' if trader.enabled else 'Enable Trading' }}">
                        <span class="material-icons">{{ 'pause' if trader.enabled else 'play_arrow' }}</span>
                    </button>
                    <button class="action-btn action-btn-delete" onclick="deleteTrader({{ trader.id }}, '{{ trader.recorder_name }}')" title="Delete Trader">
                        <span class="material-icons">delete</span>
                    </button>
                </td>
                <td><span class="strategy-link">{{ trader.recorder_name }}</span></td>
                <td><span class="account-name">{{ trader.account_name }}</span></td>
                <td>
                    <span class="status-badge {{ 'status-live' if trader.enabled else 'status-paused' }}">
                        {{ 'LIVE' if trader.enabled else 'PAUSED' }}
                    </span>
                </td>
            </tr>
            {% endfor %}
            {% if not traders %}
            <tr>
                <td colspan="4" class="empty-state">No traders yet. Click "Create Trader" to link a recorder to an account.</td>
            </tr>
            {% endif %}
        </tbody>
    </table>
    <footer class="pager">
        <button disabled>â€¹</button>
        <span class="page-pill">1</span>
        <button>â€º</button>
    </footer>
    {% elif mode == 'edit' %}
    <!-- Edit Trader Form -->
    <form id="traderForm" data-trader-id="{{ trader.id }}">
    <input type="hidden" id="editTraderId" value="{{ trader.id }}">
    <input type="hidden" id="recorderSelect" name="recorder_id" value="{{ trader.recorder_id }}">
    <section class="builder-header">
        <div>
            <h1>{{ header_title }}</h1>
            <span class="chip {{ 'chip-live' if trader.enabled else 'chip-paused' }}">{{ 'LIVE' if trader.enabled else 'PAUSED' }}</span>
            <p>Edit your trader settings. Adjust account routing and risk settings below.</p>
        </div>
        <div class="header-actions">
            <button type="submit" class="btn btn-primary" id="createTraderBtn">{{ header_cta }}</button>
            <button type="button" class="btn {{ 'btn-warning' if trader.enabled else 'btn-success' }}" id="toggleTraderBtn" onclick="toggleTraderEdit({{ trader.id }}, {{ 0 if trader.enabled else 1 }})">
                {{ 'Pause Trading' if trader.enabled else 'Enable Trading' }}
            </button>
            <a class="btn btn-secondary" href="/traders">Back to List</a>
        </div>
    </section>

    <section class="builder-alert builder-alert--error" id="validationAlert" style="display: none;">
        <strong>âš  PLEASE FIX THE FOLLOWING ISSUES:</strong>
        <ul id="validationErrors">
        </ul>
    </section>

    <section class="builder-form">
        <!-- Strategy Name is LOCKED on edit - display as read-only -->
        <label class="form-field">
            <span>Strategy Name (Locked)</span>
            <div class="locked-field">
                <span class="material-icons">lock</span>
                <span class="locked-value">{{ trader.recorder_name }}</span>
                <a href="/my-recorders" class="edit-recorder-link">Edit Recorder â†’</a>
            </div>
        </label>
        <label class="form-field">
            <span>Strategy Type</span>
            <div class="select-shell">
                <select id="strategyType" name="strategy_type" disabled>
                    <option value="Futures" {% if trader.strategy_type == 'Futures' %}selected{% endif %}>Futures</option>
                    <option value="Stock" {% if trader.strategy_type == 'Stock' %}selected{% endif %}>Stock</option>
                    <option value="Crypto" {% if trader.strategy_type == 'Crypto' %}selected{% endif %}>Crypto</option>
                </select>
                <span class="material-icons">expand_more</span>
            </div>
        </label>

        <section class="card-panel" data-panel>
            <header>
                <button class="panel-toggle" type="button"><span class="material-icons">remove</span> Hide Account Routing (Required)</button>
                <a class="panel-help" href="#">Help</a>
            </header>
            <div class="panel-body">
                <table class="account-routing">
                    <thead>
                        <tr>
                            <th>ACCOUNT</th>
                            <th>ENABLE</th>
                            <th>MAX CONS</th>
                            <th>CUSTOM TICKER</th>
                            <th>MULTIPLIER</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for account in accounts %}
                        <tr data-account-id="{{ account.id }}" data-account-name="{{ account.name }}" data-subaccount-id="{{ account.subaccount_id }}" data-subaccount-name="{{ account.name }}" data-is-demo="{{ account.is_demo|lower }}">
                            <td>{{ account.display_name }}</td>
                            <td>
                                <label class="switch">
                                    <input type="checkbox" class="account-enable" name="account_{{ account.id }}_enabled" {% if account.is_selected %}checked{% endif %}>
                                    <span class="slider"></span>
                                </label>
                            </td>
                            <td><input type="number" value="0" name="account_{{ account.id }}_max_cons" class="account-max-cons"></td>
                            <td><input type="text" placeholder="DISABLED" name="account_{{ account.id }}_ticker" class="account-ticker"></td>
                            <td><input type="number" value="1" name="account_{{ account.id }}_multiplier" class="account-multiplier"></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </section>

        <section class="card-panel" data-panel>
            <header>
                <button class="panel-toggle" type="button"><span class="material-icons">remove</span> Hide Positional Settings</button>
                <a class="panel-help" href="#">Help</a>
            </header>
            <div class="panel-body">
                <div class="form-two">
                    <label class="form-field">
                        <span>Initial Position Size</span>
                        <input type="number" id="initialPositionSize" name="initial_position_size" value="{{ trader.initial_position_size or 1 }}" min="1">
                    </label>
                    <label class="form-field">
                        <span>Add Position Size</span>
                        <input type="number" id="addPositionSize" name="add_position_size" value="{{ trader.add_position_size or 1 }}" min="1">
                    </label>
                </div>
            </div>
        </section>

        <section class="card-panel" data-panel>
            <header>
                <button class="panel-toggle" type="button"><span class="material-icons">remove</span> Hide Stop Loss / Take Profit Settings</button>
                <a class="panel-help" href="#">Help</a>
            </header>
            <div class="panel-body">
                <div class="form-two">
                    <label class="form-field">
                        <span>TP Units</span>
                        <div class="select-shell">
                            <select id="tpUnits" name="tp_units">
                                <option value="Ticks" {% if trader.tp_units == 'Ticks' %}selected{% endif %}>Ticks</option>
                                <option value="Points" {% if trader.tp_units == 'Points' %}selected{% endif %}>Points</option>
                            </select>
                            <span class="material-icons">expand_more</span>
                        </div>
                    </label>
                    <label class="form-field">
                        <span>Trim Units</span>
                        <div class="select-shell">
                            <select id="trimUnits" name="trim_units">
                                <option value="Contracts" {% if trader.trim_units == 'Contracts' %}selected{% endif %}>Contracts</option>
                                <option value="Percent" {% if trader.trim_units == 'Percent' %}selected{% endif %}>Percent</option>
                            </select>
                            <span class="material-icons">expand_more</span>
                        </div>
                    </label>
                </div>
                <div class="tp-row">
                    <span class="tp-pill">TP #1</span>
                    <label class="form-field">
                        <span>TP Value (Ticks)</span>
                        <input type="number" id="tpValue" name="tp_value" value="{{ trader.tp_value or 5 }}" min="0">
                    </label>
                    <label class="form-field">
                        <span>Trim %</span>
                        <input type="number" id="tpTrim" name="tp_trim" value="{{ trader.tp_trim or 100 }}" min="0" max="100">
                    </label>
                </div>
                <div class="separator"></div>
                <div class="toggle-row">
                    <span>Stop Loss</span>
                    <label class="switch">
                        <input type="checkbox" id="slEnabled" name="sl_enabled" {% if trader.sl_enabled %}checked{% endif %}>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="form-two">
                    <label class="form-field">
                        <span>Stop Loss Amount</span>
                        <input type="number" id="slAmount" name="sl_amount" value="{{ trader.sl_amount or 0 }}" min="0" step="0.25">
                    </label>
                    <label class="form-field">
                        <span>SL Units</span>
                        <div class="select-shell">
                            <select id="slUnits" name="sl_units">
                                <option value="Ticks" {% if trader.sl_units == 'Ticks' %}selected{% endif %}>Ticks</option>
                                <option value="Points" {% if trader.sl_units == 'Points' %}selected{% endif %}>Points</option>
                            </select>
                            <span class="material-icons">expand_more</span>
                        </div>
                    </label>
                </div>
                <label class="form-field">
                    <span>SL Type</span>
                    <div class="select-shell">
                        <select id="slType" name="sl_type">
                            <option value="Fixed" {% if trader.sl_type == 'Fixed' %}selected{% endif %}>Fixed</option>
                            <option value="Trail" {% if trader.sl_type == 'Trail' %}selected{% endif %}>Trail</option>
                        </select>
                        <span class="material-icons">expand_more</span>
                    </div>
                </label>
                <div class="separator"></div>
                <div class="toggle-row">
                    <span>Averaging Down (DCA)</span>
                    <label class="switch">
                        <input type="checkbox" id="avgDownEnabled" name="avg_down_enabled" {% if trader.avg_down_enabled %}checked{% endif %}>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="form-two">
                    <label class="form-field">
                        <span>Average Down Amount (contracts)</span>
                        <input type="number" id="avgDownAmount" name="avg_down_amount" value="{{ trader.avg_down_amount or 1 }}" min="1">
                    </label>
                    <label class="form-field">
                        <span>Average Down Point (ticks against)</span>
                        <input type="number" id="avgDownPoint" name="avg_down_point" value="{{ trader.avg_down_point or 10 }}" min="0" step="0.25">
                    </label>
                </div>
                <label class="form-field">
                    <span>Avg Down Unit</span>
                    <div class="select-shell">
                        <select id="avgDownUnits" name="avg_down_units">
                            <option value="Ticks" {% if trader.avg_down_units == 'Ticks' %}selected{% endif %}>Ticks</option>
                            <option value="Points" {% if trader.avg_down_units == 'Points' %}selected{% endif %}>Points</option>
                        </select>
                        <span class="material-icons">expand_more</span>
                    </div>
                </label>
            </div>
        </section>

        <section class="card-panel" data-panel>
            <header>
                <button class="panel-toggle" type="button"><span class="material-icons">add</span> Show Filter Settings (Optional)</button>
                <a class="panel-help" href="#">Help</a>
            </header>
            <div class="panel-body collapsed-body">
                <div class="form-two">
                    <label class="form-field">
                        <span>Ticker</span>
                        <div class="select-shell">
                            <select>
                                <option>ALL</option>
                            </select>
                            <span class="material-icons">expand_more</span>
                        </div>
                    </label>
                    <label class="form-field">
                        <span>Timeframe</span>
                        <div class="select-shell">
                            <select>
                                <option>ALL</option>
                            </select>
                            <span class="material-icons">expand_more</span>
                        </div>
                    </label>
                </div>
                <div class="form-two">
                    <label class="form-field">
                        <span>Add Delay</span>
                        <input type="number" value="1">
                        <small>Currently disabled</small>
                    </label>
                    <label class="form-field">
                        <span>Max Contracts Per Trade</span>
                        <input type="number" value="0">
                        <small>Unlimited contracts (no limit)</small>
                    </label>
                </div>
                <label class="form-field">
                    <span>Option Premium Filter</span>
                    <input type="number" value="0">
                    <small>Currently disabled</small>
                </label>
                <label class="form-field">
                    <span>Direction Filter</span>
                    <div class="select-shell">
                        <select>
                            <option>Select a strategy...</option>
                        </select>
                        <span class="material-icons">expand_more</span>
                    </div>
                </label>
                <div class="time-filters">
                    <div class="time-block" id="time_filter_1_block">
                        <div class="toggle-row" style="margin-bottom: 0.75rem;">
                            <h4 style="margin: 0;">Time Filter #1</h4>
                            <label class="switch">
                                <input type="checkbox" id="time_filter_1_enabled" {{ 'checked' if trader.time_filter_1_enabled else '' }}>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="time-grid" id="time_filter_1_fields">
                            <label class="form-field">
                                <span>Start #1</span>
                                <input type="text" id="timeFilter1Start" value="{{ trader.time_filter_1_start or '' }}" placeholder="e.g. 8:45 AM">
                            </label>
                            <label class="form-field">
                                <span>Stop #1</span>
                                <input type="text" id="timeFilter1Stop" value="{{ trader.time_filter_1_stop or '' }}" placeholder="e.g. 3:00 PM">
                            </label>
                        </div>
                    </div>
                    <div class="time-block" id="time_filter_2_block">
                        <div class="toggle-row" style="margin-bottom: 0.75rem;">
                            <h4 style="margin: 0;">Time Filter #2</h4>
                            <label class="switch">
                                <input type="checkbox" id="time_filter_2_enabled" {{ 'checked' if trader.time_filter_2_enabled else '' }}>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="time-grid" id="time_filter_2_fields">
                            <label class="form-field">
                                <span>Start #2</span>
                                <input type="text" id="timeFilter2Start" value="{{ trader.time_filter_2_start or '' }}" placeholder="e.g. 6:00 PM">
                            </label>
                            <label class="form-field">
                                <span>Stop #2</span>
                                <input type="text" id="timeFilter2Stop" value="{{ trader.time_filter_2_stop or '' }}" placeholder="e.g. 11:00 PM">
                            </label>
                        </div>
                    </div>
                </div>
                <small style="color: #64748b; margin-top: 0.5rem; display: block;">
                    <span class="material-icons" style="font-size: 0.9rem; vertical-align: middle;">info</span>
                    Set custom time filters for this trader. Leave empty to use no time filter.
                </small>
            </div>
        </section>

        <section class="card-panel" data-panel>
            <header>
                <button class="panel-toggle" type="button"><span class="material-icons">add</span> Show Miscellaneous Settings</button>
                <a class="panel-help" href="#">Help</a>
            </header>
            <div class="panel-body collapsed-body">
                <label class="form-field">
                    <span>Nickname</span>
                    <input type="text" placeholder="Example nickname">
                </label>
                <label class="form-field">
                    <span>Strategy Description</span>
                    <textarea rows="3" placeholder="Optional. Max 200 characters."></textarea>
                </label>
                <label class="form-field">
                    <span>Discord Channel</span>
                    <input type="text" placeholder="#alerts-channel">
                </label>
                <div class="toggle-row">
                    <span>Private</span>
                    <label class="switch">
                        <input type="checkbox" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="toggle-row">
                    <span>Manual Strategy</span>
                    <label class="switch">
                        <input type="checkbox">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="toggle-row">
                    <span>Inverse Strat</span>
                    <label class="switch">
                        <input type="checkbox">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </section>
    </section>
    </form>

    <section class="danger-zone">
        <h3>Danger Zone</h3>
        <div class="danger-action">
            <div>
                <strong>Delete this trader</strong>
                <p>This will stop live trading for this recorder-account link. The recorder and recorded trades will NOT be affected.</p>
            </div>
            <button type="button" class="btn btn-danger" onclick="deleteTraderEdit({{ trader.id }}, '{{ trader.recorder_name }}')">Delete Trader</button>
        </div>
    </section>
    {% else %}
    <!-- Create New Trader Form -->
    <form id="traderForm">
    <section class="builder-header">
        <div>
            <h1>{{ header_title }}</h1>
            <span class="chip">TRADER</span>
            <p>Select a strategy template to auto-fill settings, then customize and route to your accounts.</p>
        </div>
        <div class="header-actions">
            <button type="submit" class="btn btn-primary" id="createTraderBtn">{{ header_cta }}</button>
            <a class="link-button" href="/strategies/manage">Manage Strategies</a>
        </div>
    </section>

    <section class="builder-alert builder-alert--info" id="templateAlert" style="display: none;">
        <strong>âœ“ TEMPLATE LOADED:</strong>
        <span id="templateAlertMessage">Settings auto-populated from template. Customize as needed.</span>
    </section>

    <section class="builder-alert builder-alert--error" id="validationAlert" style="display: none;">
        <strong>âš  PLEASE FIX THE FOLLOWING ISSUES:</strong>
        <ul id="validationErrors">
        </ul>
    </section>

    <section class="builder-form">
        <!-- Strategy Template Dropdown (SHARED) -->
        <label class="form-field">
            <span>ðŸ“‹ Strategy Template (Auto-fills settings)</span>
            <div class="select-shell">
                <select id="strategyTemplateSelect" name="strategy_template_id">
                    <option value="">-- Select a strategy template --</option>
                    <!-- Options populated via JavaScript -->
                </select>
                <span class="material-icons">expand_more</span>
            </div>
            <small id="templateInfo" style="color: #64748b; margin-top: 4px;">Loading templates...</small>
        </label>

        <!-- Recorder Selection (for webhook signal source) -->
        <label class="form-field">
            <span>ðŸ“¡ Signal Source (Recorder)</span>
            <div class="select-shell">
                <select id="recorderSelect" name="recorder_id" required>
                    <option value="">Select recorder...</option>
                    {% for recorder in recorders %}
                    <option value="{{ recorder.id }}">{{ recorder.name }}</option>
                    {% endfor %}
                </select>
                <span class="material-icons">expand_more</span>
            </div>
            <small style="color: #64748b;">The recorder that receives webhook signals for this trader</small>
        </label>

        <label class="form-field">
            <span>Strategy Type</span>
            <div class="select-shell">
                <select id="strategyType" name="strategy_type">
                    <option value="Futures">Futures</option>
                    <option value="Stock">Stock</option>
                    <option value="Crypto">Crypto</option>
                </select>
                <span class="material-icons">expand_more</span>
            </div>
        </label>

        <section class="card-panel" data-panel>
            <header>
                <button class="panel-toggle" type="button"><span class="material-icons">remove</span> Hide Account Routing (Required)</button>
                <a class="panel-help" href="#">Help</a>
            </header>
            <div class="panel-body">
                <table class="account-routing">
                    <thead>
                        <tr>
                            <th>ACCOUNT</th>
                            <th>ENABLE</th>
                            <th>MAX CONS</th>
                            <th>CUSTOM TICKER</th>
                            <th>MULTIPLIER</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for account in accounts %}
                        <tr data-account-id="{{ account.id }}" data-account-name="{{ account.name }}" data-subaccount-id="{{ account.subaccount_id }}" data-subaccount-name="{{ account.name }}" data-is-demo="{{ account.is_demo|lower }}">
                            <td>{{ account.display_name }}</td>
                            <td>
                                <label class="switch">
                                    <input type="checkbox" class="account-enable" name="account_{{ account.id }}_enabled">
                                    <span class="slider"></span>
                                </label>
                            </td>
                            <td><input type="number" value="0" name="account_{{ account.id }}_max_cons" class="account-max-cons" id="maxCons_{{ account.id }}"></td>
                            <td><input type="text" placeholder="DISABLED" name="account_{{ account.id }}_ticker" class="account-ticker"></td>
                            <td><input type="number" value="1" name="account_{{ account.id }}_multiplier" class="account-multiplier"></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </section>

        <section class="card-panel" data-panel>
            <header>
                <button class="panel-toggle" type="button"><span class="material-icons">remove</span> Hide Positional Settings</button>
                <a class="panel-help" href="#">Help</a>
            </header>
            <div class="panel-body">
                <div class="form-two">
                    <label class="form-field">
                        <span>Initial Position Size</span>
                        <input type="number" id="createInitialPositionSize" name="initial_position_size" value="1" min="1">
                    </label>
                    <label class="form-field">
                        <span>Add Position Size</span>
                        <input type="number" id="createAddPositionSize" name="add_position_size" value="1" min="1">
                    </label>
                </div>
            </div>
        </section>

        <section class="card-panel" data-panel>
            <header>
                <button class="panel-toggle" type="button"><span class="material-icons">add</span> Show Stop Loss / Take Profit Settings (Optional)</button>
                <a class="panel-help" href="#">Help</a>
            </header>
            <div class="panel-body collapsed-body">
                <div class="form-two">
                    <label class="form-field">
                        <span>TP Units</span>
                        <div class="select-shell">
                            <select id="createTpUnits" name="tp_units">
                                <option value="Ticks">Ticks</option>
                                <option value="Points">Points</option>
                            </select>
                            <span class="material-icons">expand_more</span>
                        </div>
                    </label>
                    <label class="form-field">
                        <span>Trim Units</span>
                        <div class="select-shell">
                            <select id="createTrimUnits" name="trim_units">
                                <option value="Contracts">Contracts</option>
                                <option value="Percent">Percent</option>
                            </select>
                            <span class="material-icons">expand_more</span>
                        </div>
                    </label>
                </div>
                <div class="tp-row">
                    <span class="tp-pill">TP #1</span>
                    <label class="form-field">
                        <span>TP Value</span>
                        <input type="number" id="createTpValue" name="tp_value" value="0" min="0">
                    </label>
                    <label class="form-field">
                        <span>Trim %</span>
                        <input type="number" id="createTpTrim" name="tp_trim" value="100" min="0" max="100">
                    </label>
                </div>
                <div class="separator"></div>
                <div class="toggle-row">
                    <span>Stop Loss</span>
                    <label class="switch">
                        <input type="checkbox" id="createSlEnabled" name="sl_enabled">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="form-two">
                    <label class="form-field">
                        <span>Stop Loss Amount</span>
                        <input type="number" id="createSlAmount" name="sl_amount" value="0" min="0" step="0.25">
                    </label>
                    <label class="form-field">
                        <span>SL Units</span>
                        <div class="select-shell">
                            <select id="createSlUnits" name="sl_units">
                                <option value="Ticks">Ticks</option>
                                <option value="Points">Points</option>
                            </select>
                            <span class="material-icons">expand_more</span>
                        </div>
                    </label>
                </div>
                <label class="form-field">
                    <span>SL Type</span>
                    <div class="select-shell">
                        <select id="createSlType" name="sl_type">
                            <option value="Fixed">Fixed</option>
                            <option value="Trail">Trail</option>
                        </select>
                        <span class="material-icons">expand_more</span>
                    </div>
                </label>
                <div class="separator"></div>
                <div class="toggle-row">
                    <span>Averaging Down (DCA)</span>
                    <label class="switch">
                        <input type="checkbox" id="createAvgDownEnabled" name="avg_down_enabled">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="form-two">
                    <label class="form-field">
                        <span>Average Down Amount (contracts)</span>
                        <input type="number" id="createAvgDownAmount" name="avg_down_amount" value="1" min="1">
                    </label>
                    <label class="form-field">
                        <span>Average Down Point (ticks against)</span>
                        <input type="number" id="createAvgDownPoint" name="avg_down_point" value="10" min="0" step="0.25">
                    </label>
                </div>
                <label class="form-field">
                    <span>Max Contracts</span>
                    <input type="number" id="createMaxContracts" name="max_contracts" value="0" min="0">
                    <small style="color: #64748b;">0 = unlimited</small>
                </label>
                <div class="tp-row">
                    <span class="tp-pill">TP #1</span>
                    <label class="form-field">
                        <span>TP Value</span>
                        <input type="number" value="0">
                    </label>
                    <label class="form-field">
                        <span>Trim %</span>
                        <input type="number" value="0">
                        <small>This TP is disabled.</small>
                    </label>
                    <button class="icon-btn" type="button"><span class="material-icons">delete</span></button>
                </div>
                <div class="separator"></div>
                <div class="toggle-row">
                    <span>Stop Loss</span>
                    <span class="tag tag-disabled">Disabled</span>
                </div>
                <div class="form-two">
                    <label class="form-field">
                        <span>Stop Loss Amount</span>
                        <input type="number" value="0">
                    </label>
                    <label class="form-field">
                        <span>SL Units</span>
                        <div class="select-shell">
                            <select>
                                <option>Ticks</option>
                                <option>Points</option>
                            </select>
                            <span class="material-icons">expand_more</span>
                        </div>
                    </label>
                </div>
                <label class="form-field">
                    <span>SL Type</span>
                    <div class="select-shell">
                        <select>
                            <option>Fixed</option>
                            <option>Trail</option>
                        </select>
                        <span class="material-icons">expand_more</span>
                    </div>
                </label>
                <div class="separator"></div>
                <div class="toggle-row">
                    <span>Averaging Down</span>
                    <span class="tag tag-disabled">Disabled</span>
                </div>
                <div class="form-two">
                    <label class="form-field">
                        <span>Average Down Amount</span>
                        <input type="number" value="1">
                    </label>
                    <label class="form-field">
                        <span>Average Down Point</span>
                        <input type="number" value="0">
                    </label>
                </div>
                <label class="form-field">
                    <span>Avg Down Unit</span>
                    <div class="select-shell">
                        <select>
                            <option>Ticks</option>
                            <option>Points</option>
                        </select>
                        <span class="material-icons">expand_more</span>
                    </div>
                </label>
            </div>
        </section>

        <section class="card-panel" data-panel>
            <header>
                <button class="panel-toggle" type="button"><span class="material-icons">add</span> Show Filter Settings (Optional)</button>
                <a class="panel-help" href="#">Help</a>
            </header>
            <div class="panel-body collapsed-body">
                <div class="form-two">
                    <label class="form-field">
                        <span>Ticker</span>
                        <div class="select-shell">
                            <select>
                                <option>ALL</option>
                            </select>
                            <span class="material-icons">expand_more</span>
                        </div>
                    </label>
                    <label class="form-field">
                        <span>Timeframe</span>
                        <div class="select-shell">
                            <select>
                                <option>ALL</option>
                            </select>
                            <span class="material-icons">expand_more</span>
                        </div>
                    </label>
                </div>
                <div class="form-two">
                    <label class="form-field">
                        <span>Add Delay</span>
                        <input type="number" value="1">
                        <small>Currently disabled</small>
                    </label>
                    <label class="form-field">
                        <span>Max Contracts Per Trade</span>
                        <input type="number" value="0">
                        <small>Unlimited contracts (no limit)</small>
                    </label>
                </div>
                <label class="form-field">
                    <span>Option Premium Filter</span>
                    <input type="number" value="0">
                    <small>Currently disabled</small>
                </label>
                <label class="form-field">
                    <span>Direction Filter</span>
                    <div class="select-shell">
                        <select>
                            <option>Select a strategy...</option>
                        </select>
                        <span class="material-icons">expand_more</span>
                    </div>
                </label>
                <div class="time-filters">
                    <div class="time-block">
                        <h4>Time Filter #1</h4>
                        <div class="time-grid">
                            <label class="form-field">
                                <span>Start #1</span>
                                <div class="time-shell">
                                    <input type="number" value="8">
                                    <span>:</span>
                                    <input type="number" value="45">
                                    <select>
                                        <option>AM</option>
                                        <option>PM</option>
                                    </select>
                                </div>
                            </label>
                            <label class="form-field">
                                <span>Stop #1</span>
                                <div class="time-shell">
                                    <input type="number" value="1">
                                    <span>:</span>
                                    <input type="number" value="45">
                                    <select>
                                        <option>PM</option>
                                        <option>AM</option>
                                    </select>
                                </div>
                            </label>
                        </div>
                    </div>
                    <div class="time-block">
                        <h4>Time Filter #2</h4>
                        <div class="time-grid">
                            <label class="form-field">
                                <span>Start #2</span>
                                <div class="time-shell">
                                    <input type="number" value="12">
                                    <span>:</span>
                                    <input type="number" value="30">
                                    <select>
                                        <option>PM</option>
                                        <option>AM</option>
                                    </select>
                                </div>
                            </label>
                            <label class="form-field">
                                <span>Stop #2</span>
                                <div class="time-shell">
                                    <input type="number" value="3">
                                    <span>:</span>
                                    <input type="number" value="15">
                                    <select>
                                        <option>PM</option>
                                        <option>AM</option>
                                    </select>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="card-panel" data-panel>
            <header>
                <button class="panel-toggle" type="button"><span class="material-icons">add</span> Show Miscellaneous Settings</button>
                <a class="panel-help" href="#">Help</a>
            </header>
            <div class="panel-body collapsed-body">
                <label class="form-field">
                    <span>Nickname</span>
                    <input type="text" placeholder="Example nickname">
                </label>
                <label class="form-field">
                    <span>Strategy Description</span>
                    <textarea rows="3" placeholder="Optional. Max 200 characters."></textarea>
                </label>
                <label class="form-field">
                    <span>Discord Channel</span>
                    <input type="text" placeholder="#alerts-channel">
                </label>
                <div class="toggle-row">
                    <span>Private</span>
                    <label class="switch">
                        <input type="checkbox" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="toggle-row">
                    <span>Manual Strategy</span>
                    <label class="switch">
                        <input type="checkbox">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="toggle-row">
                    <span>Inverse Strat</span>
                    <label class="switch">
                        <input type="checkbox">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </section>
    </section>
    </form>
    {% endif %}
</div>
{% endblock %}
{% block styles %}
<style>
    .traders-wrapper { display: grid; gap: 1.5rem; }
    .list-header { display: flex; align-items: center; gap: 1rem; background: rgba(11,18,33,0.9); border: 1px solid rgba(148,163,184,0.12); border-radius: 16px; padding: 1rem 1.25rem; }
    .list-header input { background: rgba(15,23,42,0.55); border: 1px solid rgba(148,163,184,0.2); border-radius: 10px; color: #e2e8f0; padding: 0.65rem 0.85rem; flex: 1; }
    .btn { border: none; border-radius: 12px; padding: 0.65rem 1.4rem; font-weight: 600; letter-spacing: 0.06em; text-transform: uppercase; cursor: pointer; }
    .btn-primary { background: linear-gradient(135deg, #60a5fa, #2563eb); color: #0b1120; box-shadow: inset 0 0 0 1px rgba(255,255,255,0.12); }
    .trader-table { width: 100%; border-collapse: collapse; background: rgba(7,12,23,0.92); border: 1px solid rgba(148,163,184,0.12); border-radius: 16px; overflow: hidden; }
    thead th { text-align: left; padding: 0.85rem 1rem; text-transform: uppercase; letter-spacing: 0.08em; font-size: 0.75rem; color: #94a3b8; border-bottom: 1px solid rgba(148,163,184,0.12); }
    tbody td { padding: 0.95rem 1rem; border-bottom: 1px solid rgba(148,163,184,0.08); color: #e2e8f0; }
    tbody tr:last-child td { border-bottom: none; }
    .actions { display: flex; gap: 0.75rem; }
    .actions a { color: rgba(148,163,184,0.8); text-decoration: none; }
    .actions a:hover { color: #60a5fa; }
    .strategy-link { color: #60a5fa; font-weight: 600; }
    .account-name { color: #94a3b8; font-size: 0.9rem; }
    .status-badge { padding: 0.25rem 0.75rem; border-radius: 999px; font-size: 0.7rem; font-weight: 600; letter-spacing: 0.08em; text-transform: uppercase; }
    .status-live { background: rgba(16, 185, 129, 0.2); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.4); }
    .status-paused { background: rgba(248, 172, 28, 0.15); color: #facc15; border: 1px solid rgba(248, 172, 28, 0.3); }
    .action-btn { background: rgba(15,23,42,0.6); border: 1px solid rgba(148,163,184,0.2); border-radius: 8px; color: #94a3b8; padding: 0.4rem; cursor: pointer; transition: all 0.2s ease; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; }
    .action-btn:hover { background: rgba(59, 130, 246, 0.2); color: #60a5fa; border-color: rgba(59, 130, 246, 0.4); }
    .action-btn-edit:hover { background: rgba(59, 130, 246, 0.2); color: #60a5fa; border-color: rgba(59, 130, 246, 0.4); }
    .action-btn-refresh:hover { background: rgba(168, 85, 247, 0.2); color: #a855f7; border-color: rgba(168, 85, 247, 0.4); }
    .action-btn-delete:hover { background: rgba(239, 68, 68, 0.2); color: #ef4444; border-color: rgba(239, 68, 68, 0.4); }
    .action-btn-toggle:hover { background: rgba(16, 185, 129, 0.2); color: #10b981; border-color: rgba(16, 185, 129, 0.4); }
    .action-btn.spinning .material-icons { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .empty-state { text-align: center; padding: 3rem !important; color: #64748b; font-style: italic; }

    /* Edit View Styles */
    .chip-live { background: rgba(16, 185, 129, 0.25); color: #10b981; }
    .chip-paused { background: rgba(248, 172, 28, 0.15); color: #facc15; }
    .locked-field { display: flex; align-items: center; gap: 0.75rem; background: rgba(15,23,42,0.55); border: 1px solid rgba(148,163,184,0.25); border-radius: 12px; padding: 0.75rem 1rem; }
    .locked-field .material-icons { color: #64748b; font-size: 1.1rem; }
    .locked-field .locked-value { color: #e2e8f0; font-size: 1rem; font-weight: 500; flex: 1; }
    .locked-field .edit-recorder-link { color: #60a5fa; font-size: 0.85rem; text-decoration: none; white-space: nowrap; }
    .locked-field .edit-recorder-link:hover { text-decoration: underline; }
    .btn-success { background: linear-gradient(135deg, #10b981, #059669); color: white; }
    .btn-warning { background: linear-gradient(135deg, #f59e0b, #d97706); color: #0b1120; }
    .btn-danger { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
    .btn-secondary { background: rgba(148,163,184,0.2); color: #e2e8f0; border: 1px solid rgba(148,163,184,0.3); }
    .trader-details-card { background: rgba(11,18,33,0.92); border: 1px solid rgba(59,130,246,0.25); border-radius: 16px; padding: 1.5rem; }
    .trader-details-card h3 { margin: 0 0 1.25rem 0; color: #e2e8f0; font-size: 1.1rem; }
    .details-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
    .detail-item { display: flex; flex-direction: column; gap: 0.25rem; }
    .detail-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.08em; color: #64748b; }
    .detail-value { font-size: 1rem; color: #e2e8f0; font-weight: 500; }
    .edit-note { display: flex; align-items: center; gap: 0.5rem; margin-top: 1.5rem; padding: 1rem; background: rgba(59, 130, 246, 0.1); border-radius: 10px; color: #94a3b8; font-size: 0.9rem; }
    .edit-note .material-icons { font-size: 1.1rem; color: #60a5fa; }
    .edit-note a { color: #60a5fa; }
    .danger-zone { background: rgba(239, 68, 68, 0.08); border: 1px solid rgba(239, 68, 68, 0.25); border-radius: 16px; padding: 1.5rem; margin-top: 1.5rem; }
    .danger-zone h3 { margin: 0 0 1rem 0; color: #fca5a5; font-size: 1rem; }
    .danger-action { display: flex; justify-content: space-between; align-items: center; gap: 1rem; }
    .danger-action p { margin: 0.25rem 0 0 0; color: #94a3b8; font-size: 0.85rem; }
    .pager { display: flex; align-items: center; gap: 0.75rem; justify-content: center; padding: 0.75rem; }
    .pager button { background: rgba(15,23,42,0.6); border: 1px solid rgba(148,163,184,0.2); border-radius: 10px; color: #cbd5f5; padding: 0.4rem 0.75rem; cursor: pointer; }
    .pager button:disabled { opacity: 0.4; cursor: not-allowed; }
    .page-pill { background: rgba(236,72,153,0.6); color: white; border-radius: 999px; padding: 0.4rem 0.75rem; font-weight: 600; }

    .builder-header { background: rgba(11,18,33,0.92); border-radius: 18px; border: 1px solid rgba(59,130,246,0.25); padding: 1.75rem; display: flex; justify-content: space-between; align-items: flex-start; gap: 1.5rem; }
    .builder-header h1 { margin: 0; font-size: 2rem; }
    .chip { padding: 0.25rem 0.75rem; border-radius: 999px; background: rgba(59,130,246,0.25); color: #bfdbfe; font-size: 0.75rem; letter-spacing: 0.1em; }
    .header-actions { display: flex; gap: 0.75rem; align-items: center; }
    .link-button { color: #60a5fa; text-decoration: none; font-weight: 600; }
    .builder-alert { border-radius: 14px; padding: 1rem 1.2rem; background: rgba(239,68,68,0.12); border: 1px solid rgba(239,68,68,0.4); color: #fca5a5; }
    .builder-alert--info { background: rgba(16, 185, 129, 0.12); border: 1px solid rgba(16, 185, 129, 0.4); color: #6ee7b7; }
    .builder-alert ul { margin: 0; padding-left: 1.25rem; }
    .builder-form { display: grid; gap: 1.5rem; }
    .form-field { display: grid; gap: 0.35rem; color: var(--text-muted); font-size: 0.8rem; letter-spacing: 0.08em; text-transform: uppercase; }
    input, select, textarea { background: rgba(15,23,42,0.55); border: 1px solid rgba(148,163,184,0.25); border-radius: 12px; color: #e2e8f0; padding: 0.6rem 0.75rem; font-size: 0.95rem; }
    textarea { resize: vertical; }
    .select-shell { position: relative; }
    .select-shell select { width: 100%; appearance: none; }
    .select-shell .material-icons { position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); font-size: 1rem; color: var(--text-muted); pointer-events: none; }

    .card-panel { background: rgba(8,12,24,0.92); border: 1px solid rgba(59,130,246,0.18); border-radius: 16px; overflow: hidden; }
    .card-panel header { background: rgba(37,99,235,0.3); padding: 0.75rem 1rem; display: flex; justify-content: space-between; align-items: center; }
    .panel-toggle { background: none; border: none; color: #e0ecff; display: inline-flex; align-items: center; gap: 0.6rem; font-weight: 600; letter-spacing: 0.05em; text-transform: uppercase; cursor: pointer; }
    .panel-toggle .material-icons { transition: transform 0.2s ease; }
    .panel-help { color: #93c5fd; text-decoration: none; font-size: 0.8rem; }
    .panel-body { padding: 1.2rem 1.4rem; display: block; }
    .card-panel.collapsed .panel-body { display: none; }
    .card-panel.collapsed .panel-toggle .material-icons { transform: rotate(0deg); }
    .form-two { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; }
    .account-routing { width: 100%; border-collapse: collapse; background: rgba(5,10,20,0.8); border-radius: 12px; overflow: hidden; }
    .account-routing thead th { text-align: left; padding: 0.75rem; font-size: 0.75rem; letter-spacing: 0.08em; text-transform: uppercase; color: #94a3b8; border-bottom: 1px solid rgba(148,163,184,0.12); }
    .account-routing tbody td { padding: 0.75rem; border-bottom: 1px solid rgba(148,163,184,0.08); }
    .account-routing tbody tr:last-child td { border-bottom: none; }
    .switch { position: relative; display: inline-block; width: 48px; height: 24px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; inset: 0; background: rgba(148,163,184,0.3); border-radius: 24px; transition: .2s; }
    .slider:before { content: ""; position: absolute; height: 18px; width: 18px; left: 4px; bottom: 3px; background: #0b1120; border-radius: 50%; transition: .2s; }
    .switch input:checked + .slider { background: rgba(16,185,129,0.7); }
    .switch input:checked + .slider:before { transform: translateX(22px); }
    .tp-row { display: grid; grid-template-columns: auto repeat(2, minmax(0,1fr)) auto; gap: 0.75rem; align-items: center; background: rgba(30,41,59,0.6); border-radius: 10px; padding: 0.75rem; margin-top: 0.75rem; }
    .tp-pill { background: rgba(59,130,246,0.35); color: #dbeafe; border-radius: 999px; padding: 0.3rem 0.75rem; font-size: 0.75rem; letter-spacing: 0.08em; text-transform: uppercase; }
    .icon-btn { background: rgba(239,68,68,0.15); border: 1px solid rgba(239,68,68,0.35); color: #fca5a5; border-radius: 10px; padding: 0.45rem; cursor: pointer; }
    .separator { height: 1px; background: rgba(148,163,184,0.2); margin: 0.75rem 0; }
    .toggle-row { display: flex; justify-content: space-between; align-items: center; }
    .tag { padding: 0.2rem 0.6rem; border-radius: 999px; font-size: 0.7rem; letter-spacing: 0.08em; text-transform: uppercase; }
    .tag-disabled { background: rgba(248,172,28,0.15); color: #facc15; }

    .time-filters { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1rem; margin-top: 1rem; }
    .time-block { background: rgba(5,10,20,0.8); border: 1px solid rgba(148,163,184,0.2); border-radius: 12px; padding: 1rem; display: grid; gap: 0.75rem; }
    .time-grid { display: grid; gap: 0.75rem; }
    .time-shell { display: inline-flex; align-items: center; gap: 0.4rem; background: rgba(15,23,42,0.55); border: 1px solid rgba(148,163,184,0.25); border-radius: 10px; padding: 0.4rem 0.65rem; }
    .time-shell input { width: 3rem; border: none; background: transparent; text-align: center; }
    .time-shell select { border: none; background: transparent; color: #e2e8f0; }

    .toggle-row .switch { margin-left: auto; }

    @media (max-width: 900px) {
        .builder-header { flex-direction: column; align-items: flex-start; }
    }

    /* Toast Notification Styles */
    .toast-notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 16px 24px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        gap: 12px;
        z-index: 9999;
        transform: translateX(120%);
        transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        font-weight: 500;
        max-width: 400px;
    }
    .toast-notification.show {
        transform: translateX(0);
    }
    .toast-success {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.95), rgba(5, 150, 105, 0.95));
        border: 1px solid rgba(16, 185, 129, 0.5);
        color: #ffffff;
    }
    .toast-error {
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.95), rgba(220, 38, 38, 0.95));
        border: 1px solid rgba(239, 68, 68, 0.5);
        color: #ffffff;
    }
    .toast-info {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.95), rgba(37, 99, 235, 0.95));
        border: 1px solid rgba(59, 130, 246, 0.5);
        color: #ffffff;
    }
    .toast-icon {
        font-size: 1.25rem;
        font-weight: bold;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
    }
    .toast-message {
        flex: 1;
        line-height: 1.4;
    }
}
</style>
{% endblock %}
{% block scripts %}
<script>
    // =============================================
    // List Page Functions (Toggle, Delete, Filter)
    // =============================================
    
    async function toggleTrader(traderId, newEnabled) {
        try {
            const response = await fetch(`/api/traders/${traderId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ enabled: newEnabled })
            });
            const data = await response.json();
            
            if (data.success) {
                showToast(newEnabled ? 'Trader enabled - Live trading active!' : 'Trader paused - Live trading stopped.', 'success');
                // Reload page to reflect changes
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('Error updating trader: ' + (data.error || 'Unknown error'), 'error');
            }
        } catch (error) {
            console.error('Error toggling trader:', error);
            showToast('Network error. Please try again.', 'error');
        }
    }
    
    async function refreshTrader(traderId) {
        const row = document.querySelector(`tr[data-trader-id="${traderId}"]`);
        const btn = row.querySelector('.action-btn-refresh');
        
        // Add spinning animation
        btn.classList.add('spinning');
        
        try {
            const response = await fetch(`/api/traders/${traderId}`);
            const data = await response.json();
            
            if (data.success) {
                showToast('Trader status refreshed!', 'success', 2000);
                // Reload page to show updated data
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('Error refreshing: ' + (data.error || 'Unknown error'), 'error');
            }
        } catch (error) {
            console.error('Error refreshing trader:', error);
            showToast('Network error. Please try again.', 'error');
        } finally {
            btn.classList.remove('spinning');
        }
    }
    
    async function deleteTrader(traderId, traderName) {
        // Show confirmation modal
        if (!confirm(`Are you sure you want to delete trader "${traderName}"?\n\nThis will stop live trading for this recorder-account link.\nThe recorder and recorded trades will NOT be affected.`)) {
            return;
        }
        
        try {
            const response = await fetch(`/api/traders/${traderId}`, {
                method: 'DELETE'
            });
            const data = await response.json();
            
            if (data.success) {
                showToast('Trader deleted successfully.', 'success');
                // Remove the row from the table
                const row = document.querySelector(`tr[data-trader-id="${traderId}"]`);
                if (row) {
                    row.style.transition = 'opacity 0.3s ease';
                    row.style.opacity = '0';
                    setTimeout(() => {
                        row.remove();
                        // Check if table is now empty
                        const tbody = document.getElementById('tradersTableBody');
                        if (tbody && tbody.children.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="4" class="empty-state">No traders yet. Click "Create Trader" to link a recorder to an account.</td></tr>';
                        }
                    }, 300);
                }
            } else {
                showToast('Error deleting trader: ' + (data.error || 'Unknown error'), 'error');
            }
        } catch (error) {
            console.error('Error deleting trader:', error);
            showToast('Network error. Please try again.', 'error');
        }
    }
    
    function filterTraders() {
        const input = document.getElementById('searchInput');
        const filter = input.value.toLowerCase();
        const rows = document.querySelectorAll('#tradersTableBody tr');
        
        rows.forEach(row => {
            const name = row.dataset.traderName;
            if (name && name.toLowerCase().includes(filter)) {
                row.style.display = '';
            } else if (!row.querySelector('.empty-state')) {
                row.style.display = 'none';
            }
        });
    }
    
    // =============================================
    // Edit Page Functions
    // =============================================
    
    async function toggleTraderEdit(traderId, newEnabled) {
        const btn = document.getElementById('toggleTraderBtn');
        btn.disabled = true;
        btn.textContent = 'Updating...';
        
        try {
            const response = await fetch(`/api/traders/${traderId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ enabled: newEnabled })
            });
            const data = await response.json();
            
            if (data.success) {
                showToast(newEnabled ? 'Trader enabled - Live trading active!' : 'Trader paused - Live trading stopped.', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('Error updating trader: ' + (data.error || 'Unknown error'), 'error');
                btn.disabled = false;
                btn.textContent = newEnabled ? 'Enable Trading' : 'Pause Trading';
            }
        } catch (error) {
            console.error('Error toggling trader:', error);
            showToast('Network error. Please try again.', 'error');
            btn.disabled = false;
            btn.textContent = newEnabled ? 'Enable Trading' : 'Pause Trading';
        }
    }
    
    async function deleteTraderEdit(traderId, traderName) {
        if (!confirm(`Are you sure you want to delete trader "${traderName}"?\n\nThis will stop live trading for this recorder-account link.`)) {
            return;
        }
        
        try {
            const response = await fetch(`/api/traders/${traderId}`, {
                method: 'DELETE'
            });
            const data = await response.json();
            
            if (data.success) {
                showToast('Trader deleted successfully.', 'success');
                setTimeout(() => {
                    window.location.href = '/traders';
                }, 1000);
            } else {
                showToast('Error deleting trader: ' + (data.error || 'Unknown error'), 'error');
            }
        } catch (error) {
            console.error('Error deleting trader:', error);
            showToast('Network error. Please try again.', 'error');
        }
    }

    // =============================================
    // Toast Notification
    // =============================================
    
    // Toast notification function
    function showToast(message, type = 'success', duration = 3000) {
        // Remove any existing toast
        const existingToast = document.querySelector('.toast-notification');
        if (existingToast) existingToast.remove();
        
        const toast = document.createElement('div');
        toast.className = 'toast-notification toast-' + type;
        
        const icon = type === 'success' ? 'âœ“' : type === 'error' ? 'âœ•' : 'â„¹';
        toast.innerHTML = `
            <span class="toast-icon">${icon}</span>
            <span class="toast-message">${message}</span>
        `;
        
        document.body.appendChild(toast);
        
        // Trigger animation
        setTimeout(() => toast.classList.add('show'), 10);
        
        // Auto remove
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, duration);
    }

    document.addEventListener('DOMContentLoaded', function () {
        // =============================================
        // Strategy Template Loading & Auto-Population
        // =============================================
        
        let strategyTemplates = []; // Store loaded templates
        
        async function loadStrategyTemplates() {
            const select = document.getElementById('strategyTemplateSelect');
            const templateInfo = document.getElementById('templateInfo');
            
            if (!select) return; // Not on create page
            
            try {
                const response = await fetch('/api/strategies/templates');
                const data = await response.json();
                
                if (data.success && data.templates) {
                    strategyTemplates = data.templates;
                    
                    // Clear and rebuild options
                    select.innerHTML = '<option value="">-- Select a strategy template --</option>';
                    
                    // Group by public vs private
                    const publicTemplates = data.templates.filter(t => t.is_public && !t.is_own);
                    const myTemplates = data.templates.filter(t => t.is_own);
                    
                    if (publicTemplates.length > 0) {
                        const publicGroup = document.createElement('optgroup');
                        publicGroup.label = 'ðŸ“¢ Public Strategies';
                        publicTemplates.forEach(t => {
                            const opt = document.createElement('option');
                            opt.value = t.id;
                            opt.textContent = `${t.name} (by ${t.owner_username})`;
                            publicGroup.appendChild(opt);
                        });
                        select.appendChild(publicGroup);
                    }
                    
                    if (myTemplates.length > 0) {
                        const myGroup = document.createElement('optgroup');
                        myGroup.label = 'ðŸ”’ My Strategies';
                        myTemplates.forEach(t => {
                            const opt = document.createElement('option');
                            opt.value = t.id;
                            opt.textContent = t.name;
                            myGroup.appendChild(opt);
                        });
                        select.appendChild(myGroup);
                    }
                    
                    templateInfo.textContent = `${data.count} template(s) available`;
                    templateInfo.style.color = '#10b981';
                } else {
                    templateInfo.textContent = 'No templates available. Create one in Manage Strategies.';
                    templateInfo.style.color = '#f59e0b';
                }
            } catch (error) {
                console.error('Error loading templates:', error);
                templateInfo.textContent = 'Error loading templates';
                templateInfo.style.color = '#ef4444';
            }
        }
        
        function populateFormFromTemplate(templateId) {
            const template = strategyTemplates.find(t => t.id == templateId);
            if (!template) return;
            
            console.log('Populating form with template:', template);
            
            // Show the template loaded alert
            const templateAlert = document.getElementById('templateAlert');
            const templateAlertMessage = document.getElementById('templateAlertMessage');
            if (templateAlert && templateAlertMessage) {
                templateAlertMessage.textContent = `Settings loaded from "${template.name}" by ${template.owner_username}. Customize as needed.`;
                templateAlert.style.display = 'block';
            }
            
            // Populate Strategy Type
            const strategyType = document.getElementById('strategyType');
            if (strategyType && template.strat_type) {
                strategyType.value = template.strat_type;
            }
            
            // Populate Position Settings
            const initialPositionSize = document.getElementById('createInitialPositionSize');
            if (initialPositionSize) initialPositionSize.value = template.position_size || 1;
            
            const addPositionSize = document.getElementById('createAddPositionSize');
            if (addPositionSize) addPositionSize.value = template.position_add || 1;
            
            // Populate TP Settings
            const tpUnits = document.getElementById('createTpUnits');
            if (tpUnits && template.tpsl_units) tpUnits.value = template.tpsl_units;
            
            const tpValue = document.getElementById('createTpValue');
            if (tpValue) tpValue.value = template.take_profit || 0;
            
            const tpTrim = document.getElementById('createTpTrim');
            if (tpTrim) tpTrim.value = template.trim || 100;
            
            // Populate SL Settings
            const slEnabled = document.getElementById('createSlEnabled');
            if (slEnabled) slEnabled.checked = (template.stop_loss && template.stop_loss > 0);
            
            const slAmount = document.getElementById('createSlAmount');
            if (slAmount) slAmount.value = template.stop_loss || 0;
            
            const slUnits = document.getElementById('createSlUnits');
            if (slUnits && template.tpsl_units) slUnits.value = template.tpsl_units;
            
            // Populate Max Contracts
            const maxContracts = document.getElementById('createMaxContracts');
            if (maxContracts) maxContracts.value = template.max_contracts || 0;
            
            // Flash highlight on populated fields
            document.querySelectorAll('#createInitialPositionSize, #createAddPositionSize, #createTpValue, #createSlAmount, #createMaxContracts').forEach(el => {
                if (el) {
                    el.style.transition = 'background-color 0.3s ease';
                    el.style.backgroundColor = 'rgba(16, 185, 129, 0.3)';
                    setTimeout(() => {
                        el.style.backgroundColor = '';
                    }, 1500);
                }
            });
            
            showToast(`Template "${template.name}" loaded! Customize settings as needed.`, 'success', 3000);
        }
        
        // Load templates on page load
        loadStrategyTemplates();
        
        // Handle template selection
        const templateSelect = document.getElementById('strategyTemplateSelect');
        if (templateSelect) {
            templateSelect.addEventListener('change', function() {
                if (this.value) {
                    populateFormFromTemplate(this.value);
                } else {
                    // Hide the alert if no template selected
                    const templateAlert = document.getElementById('templateAlert');
                    if (templateAlert) templateAlert.style.display = 'none';
                }
            });
        }
        
        // Panel toggle functionality
        document.querySelectorAll('[data-panel]').forEach(function(panel) {
            const toggle = panel.querySelector('.panel-toggle');
            if (!toggle) return;
            toggle.addEventListener('click', function () {
                panel.classList.toggle('collapsed');
                const icon = toggle.querySelector('.material-icons');
                if (icon) {
                    icon.textContent = panel.classList.contains('collapsed') ? 'add' : 'remove';
                }
            });
        });
        
        // Form submission handler
        const form = document.getElementById('traderForm');
        if (form) {
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const validationAlert = document.getElementById('validationAlert');
                const validationErrors = document.getElementById('validationErrors');
                const submitBtn = document.getElementById('createTraderBtn');
                
                // Check if this is an edit or create
                const editTraderId = document.getElementById('editTraderId');
                const isEdit = editTraderId && editTraderId.value;
                
                // Clear previous errors
                validationErrors.innerHTML = '';
                validationAlert.style.display = 'none';
                
                // Get selected recorder
                const recorderSelect = document.getElementById('recorderSelect');
                const recorderId = recorderSelect.value;
                
                // Get enabled accounts with subaccount info
                const enabledAccounts = [];
                document.querySelectorAll('.account-enable:checked').forEach(function(checkbox) {
                    const row = checkbox.closest('tr');
                    const accountId = row.dataset.accountId;
                    const accountName = row.dataset.accountName;
                    const subaccountId = row.dataset.subaccountId;
                    const subaccountName = row.dataset.subaccountName;
                    const isDemo = row.dataset.isDemo === 'true';
                    const maxCons = row.querySelector('.account-max-cons').value || 0;
                    const ticker = row.querySelector('.account-ticker').value || '';
                    const multiplier = row.querySelector('.account-multiplier').value || 1;
                    
                    enabledAccounts.push({
                        account_id: parseInt(accountId),
                        account_name: accountName,
                        subaccount_id: subaccountId ? parseInt(subaccountId) : null,
                        subaccount_name: subaccountName,
                        is_demo: isDemo,
                        max_contracts: parseInt(maxCons),
                        custom_ticker: ticker,
                        multiplier: parseFloat(multiplier)
                    });
                });
                
                // Validate
                const errors = [];
                if (!recorderId) {
                    errors.push('Please select a recorder (strategy).');
                }
                if (enabledAccounts.length === 0) {
                    errors.push('At least one account must be enabled.');
                }
                
                if (errors.length > 0) {
                    errors.forEach(function(err) {
                        const li = document.createElement('li');
                        li.textContent = err;
                        validationErrors.appendChild(li);
                    });
                    validationAlert.style.display = 'block';
                    return;
                }
                
                // Disable button while submitting
                submitBtn.disabled = true;
                submitBtn.textContent = isEdit ? 'Updating...' : 'Creating...';
                
                try {
                    if (isEdit) {
                        // UPDATE existing trader
                        const traderId = editTraderId.value;
                        const account = enabledAccounts[0]; // Primary account (for backward compatibility)
                        
                        // Collect all risk settings
                        const initialPositionSize = parseInt(document.getElementById('initialPositionSize')?.value) || 1;
                        const addPositionSize = parseInt(document.getElementById('addPositionSize')?.value) || 1;
                        const tpUnits = document.getElementById('tpUnits')?.value || 'Ticks';
                        const tpValue = parseInt(document.getElementById('tpValue')?.value) || 5;
                        const tpTrim = parseInt(document.getElementById('tpTrim')?.value) || 100;
                        const slEnabled = document.getElementById('slEnabled')?.checked ? 1 : 0;
                        const slAmount = parseFloat(document.getElementById('slAmount')?.value) || 0;
                        const slUnits = document.getElementById('slUnits')?.value || 'Ticks';
                        const slType = document.getElementById('slType')?.value || 'Fixed';
                        const avgDownEnabled = document.getElementById('avgDownEnabled')?.checked ? 1 : 0;
                        const avgDownAmount = parseInt(document.getElementById('avgDownAmount')?.value) || 1;
                        const avgDownPoint = parseFloat(document.getElementById('avgDownPoint')?.value) || 10;
                        const avgDownUnits = document.getElementById('avgDownUnits')?.value || 'Ticks';
                        
                        // Get time filter settings
                        const timeFilter1Enabled = document.getElementById('time_filter_1_enabled')?.checked ? true : false;
                        const timeFilter1Start = document.getElementById('timeFilter1Start')?.value || '';
                        const timeFilter1Stop = document.getElementById('timeFilter1Stop')?.value || '';
                        const timeFilter2Enabled = document.getElementById('time_filter_2_enabled')?.checked ? true : false;
                        const timeFilter2Start = document.getElementById('timeFilter2Start')?.value || '';
                        const timeFilter2Stop = document.getElementById('timeFilter2Stop')?.value || '';
                        
                        // Build TP targets array
                        const tpTargets = JSON.stringify([{ value: tpValue, trim: tpTrim }]);
                        
                        // Log what we're sending
                        console.log('Saving trader with settings:', {
                            initial_position_size: initialPositionSize,
                            add_position_size: addPositionSize,
                            tp_targets: tpTargets,
                            sl_enabled: slEnabled,
                            sl_amount: slAmount,
                            avg_down_enabled: avgDownEnabled,
                            time_filter_1_enabled: timeFilter1Enabled,
                            time_filter_2_enabled: timeFilter2Enabled
                        });
                        
                        const response = await fetch(`/api/traders/${traderId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                recorder_id: parseInt(recorderId),
                                account_id: account.account_id,
                                enabled_accounts: enabledAccounts,
                                // Risk settings
                                initial_position_size: initialPositionSize,
                                add_position_size: addPositionSize,
                                tp_units: tpUnits,
                                tp_targets: tpTargets,
                                sl_enabled: slEnabled,
                                sl_amount: slAmount,
                                sl_units: slUnits,
                                sl_type: slType,
                                avg_down_enabled: avgDownEnabled,
                                avg_down_amount: avgDownAmount,
                                avg_down_point: avgDownPoint,
                                avg_down_units: avgDownUnits,
                                // Time filter settings
                                time_filter_1_enabled: timeFilter1Enabled,
                                time_filter_1_start: timeFilter1Start,
                                time_filter_1_stop: timeFilter1Stop,
                                time_filter_2_enabled: timeFilter2Enabled,
                                time_filter_2_start: timeFilter2Start,
                                time_filter_2_stop: timeFilter2Stop
                            })
                        });
                        
                        // Check response status first
                        if (!response.ok) {
                            const errorText = await response.text();
                            console.error('Server error response:', response.status, errorText);
                            showToast('Network error: ' + response.status + ' - ' + errorText.substring(0, 100), 'error', 5000);
                            submitBtn.disabled = false;
                            submitBtn.textContent = isEdit ? 'Update Trader' : 'Create Trader';
                            return;
                        }
                        
                        // Parse response only once
                        const data = await response.json();
                        console.log('Server response:', data);
                        if (data.success) {
                            showToast('Trader updated successfully!', 'success', 2500);
                            setTimeout(() => {
                                window.location.href = '/traders';
                            }, 1500);
                        } else {
                            showToast('Error updating trader: ' + (data.error || 'Unknown error'), 'error', 4000);
                            submitBtn.disabled = false;
                            submitBtn.textContent = isEdit ? 'Update Trader' : 'Create Trader';
                        }
                    } else {
                        // CREATE new traders
                        let successCount = 0;
                        let errorMessages = [];
                        
                        for (const account of enabledAccounts) {
                            const response = await fetch('/api/traders', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    recorder_id: parseInt(recorderId),
                                    account_id: account.account_id,
                                    subaccount_id: account.subaccount_id,
                                    subaccount_name: account.subaccount_name,
                                    is_demo: account.is_demo
                                })
                            });
                            
                            const data = await response.json();
                            if (data.success) {
                                successCount++;
                            } else {
                                errorMessages.push(`${account.account_name}: ${data.error || 'Unknown error'}`);
                            }
                        }
                        
                        if (successCount > 0) {
                            showToast(`Successfully created ${successCount} trader(s)! Live trading enabled.`, 'success', 2500);
                            setTimeout(() => {
                                window.location.href = '/traders';
                            }, 1500);
                        } else {
                            errorMessages.forEach(function(err) {
                                const li = document.createElement('li');
                                li.textContent = err;
                                validationErrors.appendChild(li);
                            });
                            validationAlert.style.display = 'block';
                            showToast('Failed to create trader. See errors below.', 'error', 4000);
                        }
                    }
                } catch (error) {
                    console.error('Error saving trader:', error);
                    const li = document.createElement('li');
                    li.textContent = 'Network error. Please try again.';
                    validationErrors.appendChild(li);
                    validationAlert.style.display = 'block';
                    showToast('Network error. Please try again.', 'error', 4000);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = isEdit ? 'Update Trader' : 'Create Trader';
                }
            });
        }
    });
</script>
{% endblock %}
