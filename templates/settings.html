{% extends "layout.html" %}
{% block title %}Settings - Just.Trades.{% endblock %}
{% block page_title %}SETTINGS{% endblock %}
{% block content %}
<div class="settings-wrapper">
    <section class="settings-row">
        <article class="settings-card">
            <header>
                <h2>Push Notifications</h2>
            </header>
            <p>Receive browser push notifications when your recorders fire or encounter issues.</p>
            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                <button class="btn" id="pushNotificationsBtn" onclick="togglePushNotifications()">Enable Push Notifications</button>
                <button class="btn btn-primary" id="testPushBtn" onclick="testPushNotification()" style="display: none; padding: 0.5rem 0.8rem; font-size: 0.85rem;">Test</button>
            </div>
            <small id="pushStatus" style="color: var(--text-muted); font-size: 0.85rem; margin-top: 8px; display: block;"></small>
        </article>
        <article class="settings-card">
            <header>
                <h2>Discord DMs</h2>
            </header>
            <p>Send alerts as direct messages via Discord when enabled.</p>
            <button class="btn" id="discordDMsBtn" onclick="toggleDiscordDMs()">
                {% if discord_dms_enabled %}Disable{% else %}Enable{% endif %} Discord DMs
            </button>
        </article>
    </section>

    <section class="settings-row">
        <article class="settings-card linked">
            <div>
                <h3 style="margin: 0 0 0.5rem 0; font-size: 1rem; color: var(--text-light);">Discord Account</h3>
                <p style="margin: 0; color: var(--text-muted); font-size: 0.9rem;">
                    {% if discord_linked %}
                    Connected to Discord
                    {% else %}
                    Not connected
                    {% endif %}
                </p>
            </div>
            {% if discord_linked %}
            <div style="display: flex; gap: 10px; align-items: center;">
                <span class="status-dot connected">Linked</span>
                <button class="btn btn-primary" onclick="testDiscordNotification()" style="padding: 0.4rem 0.8rem; font-size: 0.75rem;">Test DM</button>
            </div>
            {% else %}
            <a href="/api/settings/discord/link" class="btn btn-primary" style="text-decoration: none; padding: 0.5rem 1rem; font-size: 0.85rem;">Link Discord</a>
            {% endif %}
        </article>
        <article class="settings-card linked signout">
            <div>
                <h3 style="margin: 0 0 0.5rem 0; font-size: 1rem; color: var(--text-light);">Account</h3>
                <p style="margin: 0; color: var(--text-muted); font-size: 0.9rem;">Sign out of your account</p>
            </div>
            <a href="/logout" style="color: #facc15; text-decoration: none; font-weight: 600;">Sign Out</a>
        </article>
    </section>

    <section class="settings-forms">
        <div class="username-card">
            <h2>Change Your Username</h2>
            <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 0.5rem;">
                Username changes require admin approval.
            </p>
            <div class="form-row">
                <input type="text" id="newUsernameInput" placeholder="Enter new username" value="{{ user.username if user else '' }}">
                <button class="btn btn-primary" onclick="requestUsernameChange()">Request Change</button>
            </div>
            <div id="usernameMessage" style="margin-top: 0.5rem; font-size: 0.85rem;"></div>
        </div>
        <div class="password-card">
            <h2>Change Password</h2>
            <div class="form-row">
                <label class="input-shell">
                    <input type="password" id="newPasswordInput" placeholder="New password (min 6 characters)">
                    <span class="material-icons password-toggle" onclick="togglePasswordVisibility('newPasswordInput', this)">visibility</span>
                </label>
                <label class="input-shell">
                    <input type="password" id="confirmPasswordInput" placeholder="Confirm new password">
                    <span class="material-icons password-toggle" onclick="togglePasswordVisibility('confirmPasswordInput', this)">visibility</span>
                </label>
                <button class="btn btn-highlight" onclick="changePassword()">Change Password</button>
            </div>
            <div id="passwordMessage" style="margin-top: 0.5rem; font-size: 0.85rem;"></div>
        </div>
    </section>
</div>
{% endblock %}
{% block styles %}
<style>
    .settings-wrapper { display: grid; gap: 1.5rem; }
    .settings-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 1.5rem; }
    .settings-card { background: rgba(11,18,33,0.92); border-radius: 18px; border: 1px solid rgba(148,163,184,0.12); padding: 1.75rem; display: grid; gap: 0.75rem; }
    .settings-card header h2 { margin: 0; font-size: 1.2rem; }
    .settings-card p { margin: 0; color: var(--text-muted); }
    .btn { border: none; border-radius: 12px; padding: 0.7rem 1.6rem; font-weight: 600; letter-spacing: 0.08em; text-transform: uppercase; cursor: pointer; }
    .btn-danger { background: linear-gradient(135deg, #f87171, #ef4444); color: #0b1120; }
    .btn-primary { background: linear-gradient(135deg, #60a5fa, #2563eb); color: #0b1120; }
    .btn-highlight { background: linear-gradient(135deg, #fb7185, #ec4899); color: #0b1120; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .linked { display: flex; align-items: center; justify-content: space-between; }
    .status-dot { font-size: 0.85rem; letter-spacing: 0.08em; text-transform: uppercase; padding: 0.35rem 0.85rem; border-radius: 999px; }
    .status-dot.connected { background: rgba(52,211,153,0.25); color: #bbf7d0; }
    .status-dot.disconnected { background: rgba(148,163,184,0.25); color: var(--text-muted); }
    .signout { justify-content: flex-end; }
    .signout a { color: #facc15; text-decoration: none; font-weight: 600; }
    .message-success { color: #22c55e; }
    .message-error { color: #ef4444; }

    .settings-forms { display: grid; gap: 1.5rem; }
    .username-card, .password-card { background: rgba(7,12,23,0.92); border-radius: 18px; border: 1px solid rgba(148,163,184,0.12); padding: 1.75rem; display: grid; gap: 1rem; }
    .form-row { display: flex; gap: 0.75rem; flex-wrap: wrap; }
    .form-row input { background: rgba(15,23,42,0.55); border: 1px solid rgba(148,163,184,0.25); border-radius: 12px; color: #e2e8f0; padding: 0.65rem 0.85rem; font-size: 0.95rem; flex: 1; min-width: 220px; }
    .input-shell { position: relative; flex: 1; min-width: 220px; }
    .input-shell input { width: 100%; padding-right: 2.5rem; }
    .input-shell .material-icons { position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); color: var(--text-muted); cursor: pointer; }

    @media (max-width: 720px) {
        .settings-row { grid-template-columns: 1fr; }
        .form-row { flex-direction: column; }
        .form-row button { width: 100%; }
    }
}
</style>
{% endblock %}
{% block scripts %}
<script>
    // Password visibility toggle
    function togglePasswordVisibility(inputId, iconElement) {
        const input = document.getElementById(inputId);
        if (input.type === 'password') {
            input.type = 'text';
            iconElement.textContent = 'visibility_off';
        } else {
            input.type = 'password';
            iconElement.textContent = 'visibility';
        }
    }

    // Change password
    function changePassword() {
        const newPassword = document.getElementById('newPasswordInput').value;
        const confirmPassword = document.getElementById('confirmPasswordInput').value;
        const messageDiv = document.getElementById('passwordMessage');
        
        messageDiv.textContent = '';
        
        if (!newPassword || newPassword.length < 6) {
            messageDiv.textContent = 'Password must be at least 6 characters';
            messageDiv.className = 'message-error';
            return;
        }
        
        if (newPassword !== confirmPassword) {
            messageDiv.textContent = 'Passwords do not match';
            messageDiv.className = 'message-error';
            return;
        }
        
        fetch('/api/settings/password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                password: newPassword,
                confirm_password: confirmPassword
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                messageDiv.textContent = 'Password changed successfully!';
                messageDiv.className = 'message-success';
                document.getElementById('newPasswordInput').value = '';
                document.getElementById('confirmPasswordInput').value = '';
            } else {
                messageDiv.textContent = data.error || 'Failed to change password';
                messageDiv.className = 'message-error';
            }
        })
        .catch(error => {
            messageDiv.textContent = 'Error: ' + error;
            messageDiv.className = 'message-error';
        });
    }

    // Request username change
    function requestUsernameChange() {
        const newUsername = document.getElementById('newUsernameInput').value.trim().toLowerCase();
        const messageDiv = document.getElementById('usernameMessage');
        
        messageDiv.textContent = '';
        
        if (!newUsername || newUsername.length < 3) {
            messageDiv.textContent = 'Username must be at least 3 characters';
            messageDiv.className = 'message-error';
            return;
        }
        
        fetch('/api/settings/username', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username: newUsername })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                messageDiv.textContent = data.message || 'Username change request submitted!';
                messageDiv.className = 'message-success';
            } else {
                messageDiv.textContent = data.error || 'Failed to request username change';
                messageDiv.className = 'message-error';
            }
        })
        .catch(error => {
            messageDiv.textContent = 'Error: ' + error;
            messageDiv.className = 'message-error';
        });
    }

    // Toggle Discord DMs
    function toggleDiscordDMs() {
        const btn = document.getElementById('discordDMsBtn');
        btn.disabled = true;
        btn.textContent = 'Loading...';
        
        fetch('/api/settings/discord/toggle', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                btn.textContent = data.enabled ? 'Disable Discord DMs' : 'Enable Discord DMs';
                if (data.enabled) {
                    btn.className = 'btn btn-danger';
                } else {
                    btn.className = 'btn btn-primary';
                }
            } else {
                alert('Error: ' + (data.error || 'Failed to toggle Discord DMs'));
            }
            btn.disabled = false;
        })
        .catch(error => {
            alert('Error: ' + error);
            btn.disabled = false;
        });
    }

    // Test Discord notification
    function testDiscordNotification() {
        fetch('/api/settings/discord/test', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('✅ ' + data.message);
            } else {
                alert('❌ ' + (data.error || 'Failed to send test notification'));
            }
        })
        .catch(error => {
            alert('Error: ' + error);
        });
    }

    // Enter key handlers
    document.getElementById('newUsernameInput')?.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') requestUsernameChange();
    });
    document.getElementById('newPasswordInput')?.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            document.getElementById('confirmPasswordInput').focus();
        }
    });
    document.getElementById('confirmPasswordInput')?.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') changePassword();
    });

    // ============================================
    // PUSH NOTIFICATIONS
    // ============================================
    
    let swRegistration = null;
    let pushSubscription = null;

    // Check push notification support and status on load
    async function initPushNotifications() {
        const btn = document.getElementById('pushNotificationsBtn');
        const testBtn = document.getElementById('testPushBtn');
        const statusEl = document.getElementById('pushStatus');
        
        // Check if push is supported
        if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
            btn.disabled = true;
            btn.textContent = 'Not Supported';
            statusEl.textContent = 'Push notifications are not supported in this browser.';
            return;
        }
        
        // Check server configuration
        try {
            const statusResp = await fetch('/api/push/status');
            const status = await statusResp.json();
            
            if (!status.configured) {
                btn.disabled = true;
                btn.textContent = 'Not Available';
                statusEl.textContent = 'Push notifications not configured on server.';
                return;
            }
            
            // Register service worker
            swRegistration = await navigator.serviceWorker.register('/static/js/service-worker.js');
            console.log('Service Worker registered:', swRegistration);
            
            // Check current subscription
            pushSubscription = await swRegistration.pushManager.getSubscription();
            
            if (pushSubscription || status.subscribed) {
                btn.textContent = 'Disable Push Notifications';
                btn.className = 'btn btn-danger';
                testBtn.style.display = 'inline-block';
                statusEl.textContent = `✅ Push notifications enabled (${status.subscription_count} device(s))`;
            } else {
                btn.textContent = 'Enable Push Notifications';
                btn.className = 'btn btn-primary';
                testBtn.style.display = 'none';
                statusEl.textContent = 'Push notifications are disabled.';
            }
            btn.disabled = false;
        } catch (error) {
            console.error('Push init error:', error);
            statusEl.textContent = 'Error initializing push notifications.';
        }
    }

    async function togglePushNotifications() {
        const btn = document.getElementById('pushNotificationsBtn');
        const testBtn = document.getElementById('testPushBtn');
        const statusEl = document.getElementById('pushStatus');
        
        btn.disabled = true;
        
        try {
            if (pushSubscription) {
                // Unsubscribe
                await pushSubscription.unsubscribe();
                await fetch('/api/push/unsubscribe', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({endpoint: pushSubscription.endpoint})
                });
                pushSubscription = null;
                btn.textContent = 'Enable Push Notifications';
                btn.className = 'btn btn-primary';
                testBtn.style.display = 'none';
                statusEl.textContent = 'Push notifications disabled.';
            } else {
                // Request permission and subscribe
                const permission = await Notification.requestPermission();
                if (permission !== 'granted') {
                    statusEl.textContent = '❌ Notification permission denied. Please allow notifications in your browser settings.';
                    btn.disabled = false;
                    return;
                }
                
                // Get VAPID public key
                const keyResp = await fetch('/api/push/vapid-public-key');
                const keyData = await keyResp.json();
                
                if (!keyData.publicKey) {
                    statusEl.textContent = 'Server not configured for push notifications.';
                    btn.disabled = false;
                    return;
                }
                
                // Subscribe to push
                const applicationServerKey = urlBase64ToUint8Array(keyData.publicKey);
                pushSubscription = await swRegistration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: applicationServerKey
                });
                
                // Send subscription to server
                const resp = await fetch('/api/push/subscribe', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({subscription: pushSubscription.toJSON()})
                });
                
                const result = await resp.json();
                if (result.success) {
                    btn.textContent = 'Disable Push Notifications';
                    btn.className = 'btn btn-danger';
                    testBtn.style.display = 'inline-block';
                    statusEl.textContent = '✅ Push notifications enabled!';
                } else {
                    statusEl.textContent = '❌ ' + (result.error || 'Failed to enable push notifications.');
                }
            }
        } catch (error) {
            console.error('Push toggle error:', error);
            statusEl.textContent = '❌ Error: ' + error.message;
        }
        
        btn.disabled = false;
    }

    async function testPushNotification() {
        const statusEl = document.getElementById('pushStatus');
        try {
            const resp = await fetch('/api/push/test', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            });
            const result = await resp.json();
            if (result.success) {
                statusEl.textContent = '✅ ' + result.message;
            } else {
                statusEl.textContent = '❌ ' + (result.error || 'Failed to send test notification.');
            }
        } catch (error) {
            statusEl.textContent = '❌ Error: ' + error.message;
        }
    }

    // Helper function to convert VAPID key
    function urlBase64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - base64String.length % 4) % 4);
        const base64 = (base64String + padding)
            .replace(/-/g, '+')
            .replace(/_/g, '/');
        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);
        for (let i = 0; i < rawData.length; ++i) {
            outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray;
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', initPushNotifications);
</script>
{% endblock %}
